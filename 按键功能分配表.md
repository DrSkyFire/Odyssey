# 按键功能分配表

## 按键映射总览

| 按键编号 | 默认模式 | 自动测试模式 | 微弱信号模式 | 备注 |
|---------|---------|------------|------------|------|
| button[0] | 模式切换 | 频率增加 | (频率增加) | 核心功能键 |
| button[1] | 微弱信号切换 | 频率减少 | (微弱信号切换) | FFT自动启动，不需要启动键 |
| button[2] | 停止 | 幅度增加 | 参考频率增加 | 多功能复用 |
| button[3] | CH1开关 | 幅度减少 | 参考频率减少 | 通道/参数控制 |
| button[4] | 触发模式 | 占空比增加 | 参考模式切换 | 模式控制 |
| button[5] | 自动测试切换 | (自动测试切换) | (保留) | 模式切换键 |
| button[6] | CH2开关 | THD阈值调整 | (CH2开关) | 通道/参数控制 |
| button[7] | 测试模式/清除溢出 | (保留) | (保留) | 系统功能键 |

## 详细功能说明

### button[0] - 模式切换/频率增加
**默认模式**: 工作模式循环切换（时域 → 频域 → 双通道）
**自动测试模式**: 增加测试信号频率
**优先级**: 自动测试模式优先

```verilog
assign btn_mode    = btn_0_pulse & ~auto_test_enable;
assign btn_freq_up = btn_0_pulse & auto_test_enable;
```

### button[1] - 微弱信号切换/频率减少
**默认模式**: 切换微弱信号检测模式（因为FFT已有自动启动功能）
**自动测试模式**: 减少测试信号频率
**微弱信号模式**: 切换微弱信号检测（退出模式）
**优先级**: 自动测试模式优先

```verilog
assign btn_weak_sig_enable = btn_1_pulse & ~auto_test_enable;
assign btn_freq_dn         = btn_1_pulse & auto_test_enable;
```

**说明**: 由于FFT已实现自动启动和延迟启动功能，不再需要手动启动键，因此button[1]改为微弱信号切换功能。

### button[2] - 停止/幅度增加/参考频率增加
**默认模式**: 停止信号采集
**自动测试模式**: 增加测试信号幅度
**微弱信号模式**: 增加锁相放大器参考频率
**优先级**: 自动测试 > 微弱信号 > 默认

```verilog
assign btn_stop        = btn_2_pulse & ~auto_test_enable & ~weak_sig_enable;
assign btn_amp_up      = btn_2_pulse & auto_test_enable;
assign btn_ref_freq_up = btn_2_pulse & weak_sig_enable & ~auto_test_enable;
```

### button[3] - CH1开关/幅度减少/参考频率减少
**默认模式**: 切换通道1显示开关
**自动测试模式**: 减少测试信号幅度
**微弱信号模式**: 减少锁相放大器参考频率
**优先级**: 自动测试 > 微弱信号 > 默认

```verilog
assign btn_ch1_toggle  = btn_3_pulse & ~auto_test_enable & ~weak_sig_enable;
assign btn_amp_dn      = btn_3_pulse & auto_test_enable;
assign btn_ref_freq_dn = btn_3_pulse & weak_sig_enable & ~auto_test_enable;
```

### button[4] - 触发模式/占空比增加/参考模式切换
**默认模式**: 触发模式切换（自动/正常）
**自动测试模式**: 增加测试信号占空比
**微弱信号模式**: 锁相放大器参考模式切换（内部DDS/外部信号）
**优先级**: 自动测试 > 微弱信号 > 默认

```verilog
assign btn_trig_mode = btn_4_pulse & ~auto_test_enable & ~weak_sig_enable;
assign btn_duty_up   = btn_4_pulse & auto_test_enable;
assign btn_ref_mode  = btn_4_pulse & weak_sig_enable & ~auto_test_enable;
```

### button[5] - 自动测试切换
**功能**: 切换自动测试模式
**说明**: 进入/退出自动测试模式，通过auto_test_enable控制
**优先级**: 全模式有效

```verilog
assign btn_auto_test = btn_5_pulse;
```

**变更说明**: 微弱信号切换功能已移至button[1]，button[5]现在专门用于自动测试模式切换。

### button[6] - CH2开关/THD阈值调整
**默认模式**: 切换通道2显示开关
**自动测试模式**: 调整THD阈值范围（50%→30%→10%→5%循环）
**优先级**: 自动测试模式优先

```verilog
assign btn_ch2_toggle = btn_6_pulse & ~auto_test_enable;
assign btn_thd_adjust = btn_6_pulse & auto_test_enable;
```

### button[7] - 测试模式/清除溢出
**功能**: 
- 切换测试模式（开启内部信号源）
- 清除ADC溢出标志
**说明**: 单键双功能（测试模式通过逻辑控制，溢出清除通过脉冲触发）
**优先级**: 全模式有效

```verilog
assign btn_test_mode  = btn_7_pulse;
assign adc_otr_clear  = btn_7_pulse;
```

## 模式切换逻辑

### 默认模式 (auto_test_enable = 0, weak_sig_enable = 0)
- 基础操作：模式切换、启动停止、通道开关、触发控制
- 适用场景：正常信号分析

### 自动测试模式 (auto_test_enable = 1)
- 进入方式：按下button[5]进入/退出
- 功能重定向：6个按键用于调整测试信号参数
- LED指示：test_mode_led闪烁（1Hz）显示模式状态
- 测试流程：设置参数 → 生成信号 → 自动判定 → LED指示结果

### 微弱信号模式 (weak_sig_enable = 1)
- 进入方式：按下button[5]进入/退出
- 功能重定向：3个按键用于调整锁相放大器参数
- 核心功能：参考频率调整、参考模式切换
- 显示输出：幅度、相位、SNR改善、锁定状态

## 按键复用优先级总结

1. **自动测试模式** > 微弱信号模式 > 默认模式
2. **模式切换键**（button[5]）在所有模式下都有效
3. **系统键**（button[7]）不受模式影响
4. **互斥保护**：自动测试和微弱信号模式不同时启用

## 资源节约

**修复前**: 13个key_debounce模块（按键冲突）
**修复后**: 8个key_debounce模块（每个按键一个）
**节省资源**: ~250 LUT, ~500 FF

## 使用建议

1. **新手模式**: 保持在默认模式，使用基础功能
2. **信号调试**: 进入自动测试模式，快速验证信号质量
3. **微弱信号**: 进入微弱信号模式，启用锁相放大
4. **故障排查**: 使用button[7]清除ADC溢出标志

## 注意事项

⚠️ 按键在不同模式下功能不同，需要注意当前模式状态
⚠️ button[7]同时控制测试模式和清除溢出，操作时需确认当前状态
⚠️ 自动测试和微弱信号模式会占用大部分按键，此时基础功能受限
