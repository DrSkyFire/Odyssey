# THD修复v11 - 多帧平均滤波 + 动态阈值

**日期**: 2025-11-05  
**版本**: v11  
**目标**: 解决频谱噪声和峰值跳动问题  

---

## 📊 **问题分析**

### v10c遗留问题:

```
测试结果：
  ✅ 600kHz方波：THD恢复到53%（vs v10b的10%）
  ❌ 峰值跳动：THD在51-55%跳动（±3%）
  ❌ 频谱噪声：低频区域噪声明显
  ❌ 20kHz方波：THD仍然0.0%（能量泄漏未完全解决）

根因：
  1. Rectangular窗导致频率泄漏 → 峰值在相邻bin跳动
  2. 量化噪声、采样抖动 → 幅度测量跳动±2%
  3. 单帧FFT检测 → 随机噪声影响大
  4. 固定阈值50 → 对强弱信号不适应
```

---

## 🎯 **v11优化方案**

### 优化1: 谐波幅度8帧滑动平均 ⭐⭐⭐

**原理**:
```
信号处理理论：
  随机噪声功率 ∝ 1/√N
  N=8帧平均 → 噪声降低√8≈2.8倍（69%）
  
实时性：
  FFT周期：25ms（8192点@35MHz）
  8帧延迟：200ms（可接受）
```

**实现**:
```verilog
// 新增历史缓存（4个谐波×8帧×16位=128字节RAM）
reg [15:0] harm2_amp_history [0:7];
reg [15:0] harm3_amp_history [0:7];
reg [15:0] harm4_amp_history [0:7];
reg [15:0] harm5_amp_history [0:7];
reg [2:0]  harm_history_index;  // 循环索引0-7

// FFT扫描结束时：存储本次幅度
harm2_amp_history[harm_history_index] <= harm2_amp;
harm3_amp_history[harm_history_index] <= harm3_amp;
harm4_amp_history[harm_history_index] <= harm4_amp;
harm5_amp_history[harm_history_index] <= harm5_amp;
harm_history_index <= harm_history_index + 1'b1;

// 计算8帧平均（防溢出：4+4分组计算）
harm2_amp_avg <= ((harm2_amp_history[0] + harm2_amp_history[1] + 
                   harm2_amp_history[2] + harm2_amp_history[3]) +
                  (harm2_amp_history[4] + harm2_amp_history[5] + 
                   harm2_amp_history[6] + harm2_amp_history[7])) >> 3;
// 类似处理harm3/4/5_amp_avg
```

**资源消耗**:
- RAM: 128字节 (4谐波×8帧×16bit)
- LUT: ~200个 (加法树和移位)
- 寄存器: 64个 (4×16bit平均值)

---

### 优化2: 动态噪声阈值 ⭐⭐

**问题**:
```
v10c固定阈值50的缺陷：
  3Vpp方波：基波10000，谐波5000，50阈值太低（噪声漏入）
  1Vpp方波：基波3000，谐波1500，50阈值太低（噪声漏入）
  0.3Vpp方波：基波1000，谐波500，50阈值太高（谐波漏掉）
```

**改进**:
```verilog
// 动态阈值 = 基波幅度的3.125%（右移5位，即÷32）
// 3.125%是经验值：既能过滤噪声，又不会误杀微弱谐波
dynamic_noise_threshold <= (fft_avg_amp >> 5) > 16'd50 ? 
                           (fft_avg_amp >> 5) : 16'd50;

// 示例：
//   3Vpp信号：基波10000 → 阈值312（vs固定50）
//   1Vpp信号：基波3000  → 阈值93（vs固定50）
//   0.3Vpp信号：基波1000 → 阈值50（最小限制）
```

**阈值选择依据**:
```
方波THD理论值：48.3%（H3+H5为主）
  H3 ≈ 33% × 基波
  H5 ≈ 20% × 基波
  
噪声典型值：<1% × 基波

阈值3.125%：
  ✅ 远小于H5（20%） → 不漏掉真实谐波
  ✅ 大于噪声（1%）  → 有效滤除噪声
  ✅ 自适应信号强度  → 适用0.3-3Vpp全范围
```

---

### 优化3: 双重滤波策略

**v11谐波检测流程**:
```
原始谐波幅度（单帧，噪声大）
    ↓
存入历史缓存[0:7]
    ↓
8帧滑动平均（噪声降低69%）
    ↓
harm_X_amp_avg
    ↓
动态阈值判断（自适应信号强度）
    ↓
fft_harmonic_X（稳定、准确）
    ↓
THD计算
```

**vs v10c单阈值**:
```
v10c: 原始幅度 → 固定阈值50 → THD
      ❌ 噪声大  ❌ 不自适应
      
v11:  原始幅度 → 8帧平均 → 动态阈值 → THD
      ✅ 噪声小  ✅ 自适应
```

---

## 📋 **代码修改清单**

### 文件: `signal_parameter_measure.v`

**1. 新增寄存器定义（Line ~568）**:
```verilog
// 【v11新增】谐波幅度8帧历史缓存（降低噪声和峰值跳动）
reg [15:0] harm2_amp_history [0:7];    // 2次谐波最近8帧幅度
reg [15:0] harm3_amp_history [0:7];    // 3次谐波最近8帧幅度
reg [15:0] harm4_amp_history [0:7];    // 4次谐波最近8帧幅度
reg [15:0] harm5_amp_history [0:7];    // 5次谐波最近8帧幅度
reg [2:0]  harm_history_index;         // 谐波历史索引（0-7循环）

// 【v11新增】谐波平均幅度（8帧滑动平均后的稳定值）
reg [15:0] harm2_amp_avg;
reg [15:0] harm3_amp_avg;
reg [15:0] harm4_amp_avg;
reg [15:0] harm5_amp_avg;

// 【v11新增】动态噪声阈值（基于基波幅度自适应）
reg [15:0] dynamic_noise_threshold;
```

**2. 复位初始化（Line ~575）**:
```verilog
// 【v11新增】谐波历史缓存初始化
harm_history_index <= 3'd0;
harm2_amp_avg <= 16'd0;
harm3_amp_avg <= 16'd0;
harm4_amp_avg <= 16'd0;
harm5_amp_avg <= 16'd0;
dynamic_noise_threshold <= 16'd50;
```

**3. 动态阈值计算（Line ~612）**:
```verilog
// 【v11新增】动态噪声阈值计算
// 阈值 = 基波幅度的3.125%（除以32，即右移5位）
dynamic_noise_threshold <= (fft_avg_amp >> 5) > 16'd50 ? 
                           (fft_avg_amp >> 5) : 16'd50;
```

**4. 8帧平均滤波（Line ~740）**:
```verilog
// 【v11新增】谐波幅度历史记录与滑动平均
harm2_amp_history[harm_history_index] <= harm2_amp;
harm3_amp_history[harm_history_index] <= harm3_amp;
harm4_amp_history[harm_history_index] <= harm4_amp;
harm5_amp_history[harm_history_index] <= harm5_amp;
harm_history_index <= harm_history_index + 1'b1;

// 8帧滑动平均（4+4分组防溢出）
harm2_amp_avg <= ((harm2_amp_history[0:3]求和) +
                  (harm2_amp_history[4:7]求和)) >> 3;
// 类似处理harm3/4/5
```

**5. 动态阈值判断（Line ~770）**:
```verilog
// 【v11优化】使用动态阈值和平均幅度
if (harm2_amp_avg > dynamic_noise_threshold)
    fft_harmonic_2 <= harm2_amp_avg;
else
    fft_harmonic_2 <= 16'd0;
// 类似处理harm3/4/5
```

---

## 🧪 **预期效果**

### 性能对比:

| 测试场景 | v10c | v11预期 | 理论值 |
|---------|------|---------|--------|
| **600kHz方波** | | | |
| THD平均值 | 53% | 53% | 48.3% |
| THD跳动范围 | ±3% | ±0.5% | - |
| 测量稳定性 | 中 | **高** | - |
| **1MHz方波** | | | |
| THD平均值 | 20% | 20% | 53.3%* |
| THD跳动范围 | ±2% | ±0.3% | - |
| **20kHz方波** | | | |
| THD | 0.0% | 40-48% | 48.3% |
| 检测成功率 | 0% | **>90%** | - |
| **噪声抑制** | | | |
| 低频噪声 | 明显 | **降低69%** | - |
| 峰值跳动 | 严重 | **基本消除** | - |

*注：1MHz理论THD=53.3%，但实际测量20%可能是信号源失真

---

## 🔍 **信号处理原理**

### 滑动平均滤波器特性:

**时域**:
```
y[n] = (x[n] + x[n-1] + ... + x[n-7]) / 8

冲激响应: h = [1/8, 1/8, ..., 1/8]  (8个tap)
```

**频域（低通滤波器）**:
```
截止频率: fc ≈ Fs / (2πN) = 35MHz / (2π×8) ≈ 0.7MHz

对噪声的抑制：
  白噪声功率 ∝ σ²
  平均后功率 ∝ σ²/N
  幅度降低 = √N = √8 ≈ 2.83倍
  
  dB抑制 = 20log₁₀(√8) ≈ 9dB
```

**为什么选8帧？**:
```
4帧:  √4=2倍（6dB抑制），延迟100ms ⚠️ 抑制不足
8帧:  √8=2.8倍（9dB抑制），延迟200ms ✅ 平衡点
16帧: √16=4倍（12dB抑制），延迟400ms ❌ 响应太慢
```

---

## 🚀 **测试计划**

### 测试步骤:

1. **编译烧录**
   ```
   TD IDE → Full Compile
   烧录v11版本到FPGA
   ```

2. **基准测试（600kHz方波）**
   ```
   信号源：600kHz方波，2Vpp
   预期：THD=53%±0.5%（vs v10c的51-55%跳动）
   观察：OSD显示是否稳定
   ```

3. **低频测试（20kHz方波）**
   ```
   信号源：20kHz方波，2Vpp
   预期：THD=40-48%（vs v10c的0.0%）
   关键：验证±5bin搜索+8帧平均能否解决能量泄漏
   ```

4. **高频测试（1MHz方波）**
   ```
   信号源：1MHz方波，2Vpp
   预期：THD=20%±0.3%（vs v10c的18-22%跳动）
   ```

5. **幅度范围测试**
   ```
   0.3Vpp: 动态阈值≈50（最小限制）
   1.0Vpp: 动态阈值≈93
   2.0Vpp: 动态阈值≈187
   3.0Vpp: 动态阈值≈312
   
   验证：各幅度下THD检测成功
   ```

---

## 🎯 **成功标准**

### v11必须达到:

1. ✅ **THD跳动<±1%**（vs v10c的±3%）
2. ✅ **20kHz方波THD>40%**（vs v10c的0.0%）
3. ✅ **600kHz/1MHz稳定显示**（无频繁跳动）
4. ✅ **0.3-3Vpp全范围检测**（动态阈值适应）

### 如果失败:

**Plan B**: 增加到16帧平均（更强抑制）
**Plan C**: 实施抛物线插值（解决频率泄漏）
**Plan D**: 尝试Flattop窗（如果噪声仍然严重）

---

## 📝 **下一步优化（v12预留）**

1. **抛物线插值** (如果20kHz仍失败)
   ```verilog
   // 3点抛物线拟合，精确估计真实峰值位置
   delta = 0.5 × (A[k+1] - A[k-1]) / (2A[k] - A[k+1] - A[k-1]);
   real_bin = peak_bin + delta;
   ```

2. **7次/9次谐波** (如果需要完整THD)
   ```
   方波完整THD = √(H3²+H5²+H7²+H9²+...) / H1
   当前只计算到H5，理论漏掉H7(14%)和H9(11%)
   ```

3. **自适应窗长** (如果低频分辨率不足)
   ```
   <100kHz: 使用16384点FFT（2.136Hz分辨率）
   >100kHz: 使用8192点FFT（4.272Hz分辨率）
   ```

---

## 总结

**v11核心改进**:
- ⭐⭐⭐ 8帧滑动平均（噪声降低69%，跳动基本消除）
- ⭐⭐ 动态噪声阈值（自适应0.3-3Vpp信号）
- ⭐ 双重滤波（平均+阈值，双保险）

**预期收益**:
- THD测量稳定性提升80%
- 20kHz检测成功率从0%→90%
- 开发时间：2小时（已完成代码修改）

**风险评估**:
- ⚠️ 响应延迟200ms（8帧×25ms）
- ✅ 资源消耗小（128字节RAM）
- ✅ 时序安全（只有加法和移位）

**建议**: 立即测试v11，如效果达标则定版！
