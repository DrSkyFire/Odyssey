# 微弱信号锁相放大功能检查报告

**日期**: 2025年11月7日  
**检查对象**: 微弱信号检测模块 (weak_signal_detector.v + lock_in_amplifier.v)  
**需求**: 低噪声放大与锁相放大算法

---

## 1. 功能架构总览

### 1.1 模块层次
```
weak_signal_detector (顶层检测器)
    ├── lock_in_amplifier (CH1锁相放大器)
    └── lock_in_amplifier (CH2锁相放大器)
```

### 1.2 信号处理流程
```
ADC信号 (11-bit)
    ↓
数字增益 (1x-32768x可调)
    ↓
混频器 (与参考信号相乘)
    ├── I通道: signal × cos(ωt)
    └── Q通道: signal × sin(ωt)
    ↓
低通滤波 (256点移动平均)
    ↓
幅度/相位提取
    ├── 幅度: √(I² + Q²)
    └── 相位: atan2(Q, I)
    ↓
锁定检测 (稳定性判断)
```

---

## 2. 锁相放大器核心实现

### 2.1 ✅ DDS参考信号生成器

**实现方式**: 64点正弦查找表 + 对称性扩展

```verilog
// 相位累加器（32位）
phase_acc <= phase_acc + ref_freq_tuning;

// 频率调谐字计算
freq_tuning_word = (Fref << 16) / (Fclk >> 16)
```

**优点**:
- 节省资源（仅存储64个点）
- 利用对称性扩展到1024点
- 频率分辨率高（32位相位累加器）

**潜在问题**:
- ⚠️ 当前使用简化的除法计算调谐字，可能精度不足
- ⚠️ 正弦表精度16位，可能引入量化噪声

**建议**:
- 使用更精确的调谐字计算（预计算或IP核）
- 考虑使用CORDIC算法替代查找表

---

### 2.2 ✅ 数字增益控制

**实现方式**: 可编程移位增益

```verilog
signal_gain = signal_in <<< gain_shift;  // 2^gain_shift 增益
```

**增益范围**:
| gain_shift | 增益倍数 | dB |
|-----------|---------|-----|
| 0 | 1x | 0 dB |
| 4 | 16x | 24 dB |
| 8 | 256x | 48 dB |
| 12 | 4096x | 72 dB |
| 15 | 32768x | 90 dB |

**自动增益控制（AGC）**:
```verilog
// 每256个样本调整一次
if (magnitude < 0x010000 && gain < 15)
    gain++;  // 增加增益
else if (magnitude > 0x700000 && gain > 0)
    gain--;  // 减小增益
```

**优点**:
- ✅ 动态范围大（90dB）
- ✅ 自动适应信号强度
- ✅ 避免饱和

**潜在问题**:
- ⚠️ AGC响应速度固定（256样本），可能不适合快速变化信号
- ⚠️ 目标幅度范围写死在代码中

---

### 2.3 ✅ 混频器（相乘器）

**实现方式**: 直接乘法

```verilog
mixer_i = signal_gain × ref_cos;  // 同相分量
mixer_q = signal_gain × ref_sin;  // 正交分量
```

**位宽**: 
- 输入: 16-bit (ADC) + 15-bit (增益) = 31-bit
- 参考: 16-bit (正弦表)
- 输出: 47-bit (31+16)

**优点**:
- ✅ 精度高
- ✅ 完美正交（sin/cos相位差90°）

**资源占用**:
- 需要 2 个 DSP 乘法器（每通道）
- 共 4 个 DSP（双通道）

---

### 2.4 ✅ 低通滤波器

**实现方式**: CIC风格移动平均

```verilog
// 积分器
i_integrator = i_integrator + mixer_i - i_delay[FILTER_SIZE-1];

// 移位寄存器（延迟线）
i_delay[0] = mixer_i;
for (j=1; j<FILTER_SIZE; j++)
    i_delay[j] = i_delay[j-1];

// 梳状滤波器
i_comb = i_integrator;

// 缩放
i_filtered = i_comb >>> LPF_ORDER;  // 除以256
```

**参数**:
- **滤波器阶数**: 固定 LPF_ORDER = 8 (在实例化时设置)
- **窗口大小**: 2^8 = 256 点
- **截止频率**: Fs / (2 × 256) ≈ 68 Hz @ 35MHz采样率

**性能**:
| 采样率 | 窗口大小 | 截止频率 | 处理时间 |
|-------|---------|---------|---------|
| 35 MHz | 256 | ~68 kHz | 7.3 μs |
| 35 MHz | 1024 | ~17 kHz | 29 μs |

**优点**:
- ✅ 计算高效（仅加法+移位）
- ✅ 线性相位
- ✅ 无乘法器消耗

**潜在问题**:
- ⚠️ 固定滤波器阶数（参数化时已确定），无法动态调整
- ⚠️ 在 `weak_signal_detector.v` 中两个实例使用了不同阶数：
  ```verilog
  u_lia_ch1: LPF_ORDER = 10  // 1024点 ❌
  u_lia_ch2: LPF_ORDER = 8   // 256点 ❌
  ```
  **这是不一致的！可能是错误。**

---

### 2.5 ⚠️ 幅度和相位计算

**幅度近似**:
```verilog
mag ≈ max(|I|, |Q|) + 0.5 × min(|I|, |Q|)
```

**误差分析**:
- 真实幅度: √(I² + Q²)
- 近似误差: 典型 <12%
- 最大误差: 45° 相位时约 11.8%

**相位计算**:
```verilog
// 简化的象限判断
if (I>=0 && Q>=0) phase = Q[13:0];       // 第一象限 ❌ 错误
else if (I<0 && Q>=0) phase = 0x4000 - I[13:0]; // 第二象限
...
```

**问题**:
- ❌ **相位计算逻辑错误**: 直接使用 I/Q 的高位，而不是 atan2(Q, I)
- ❌ 缺少正确的反正切计算
- ❌ 相位精度低（仅14位数据）

**建议**:
- 使用 CORDIC IP 核计算 atan2
- 或者使用查找表 (atan2 LUT)

---

### 2.6 ✅ 锁定检测

**实现方式**: 幅度稳定性判断

```verilog
// 记录最近16个幅度值
mag_history[mag_ptr] <= magnitude;

// 查找最大最小值
mag_max = max(mag_history[0:15]);
mag_min = min(mag_history[0:15]);

// 锁定判断
if ((mag_max - mag_min) < (magnitude >> 3))  // 波动 < 12.5%
    locked = 1;
```

**优点**:
- ✅ 简单有效
- ✅ 自适应阈值（12.5%相对波动）

**潜在问题**:
- ⚠️ 仅基于幅度，未考虑相位稳定性
- ⚠️ 16个样本可能不够（建议32-64）

---

## 3. 顶层集成检查

### 3.1 ❌ 触发方式 - 未实现

**当前状态**:
```verilog
// signal_analyzer_top.v line 2136
assign btn_weak_sig_enable = 1'b0;  // 暂时禁用，未连接按键 ❌
```

**问题**:
- ❌ **按键未连接**: 用户无法启用微弱信号检测
- ❌ **默认关闭**: `weak_sig_enable = 1'b0`
- ❌ **参考频率调整按键未实现**:
  ```verilog
  assign btn_ref_freq_up = 1'b0;
  assign btn_ref_freq_dn = 1'b0;
  ```

**建议修复**:
1. 分配一个未使用的按键（如 `user_button[7]`）
2. 添加按键消抖
3. 实现频率调整按键（复用现有按键）

---

### 3.2 ⚠️ 参数配置

**默认配置**:
```verilog
weak_sig_enable   = 0;           // ❌ 默认关闭
weak_sig_ref_mode = 0;           // ✅ 内部DDS
weak_sig_ref_freq = 1000 Hz;     // ✅ 1kHz参考
weak_sig_gain     = 4 (16x);     // ✅ 适中增益
weak_sig_auto_gain = 1;          // ✅ 自动增益
```

**问题**:
- ⚠️ 用户无法通过界面调整参数（仅硬编码默认值）
- ⚠️ 参考频率步进固定 100Hz（可能太粗）

---

### 3.3 ⚠️ 滤波器阶数不一致

**在 `weak_signal_detector.v` 中**:
```verilog
// CH1 实例化
lock_in_amplifier #(
    .LPF_ORDER (10)  // 1024点 ❌
) u_lia_ch1 (...);

// CH2 实例化
lock_in_amplifier #(
    .LPF_ORDER (8)   // 256点 ❌
) u_lia_ch2 (...);
```

**问题**:
- ❌ **双通道不一致**: CH1使用1024点，CH2使用256点
- ❌ **性能不对称**: CH1截止频率更低，响应更慢
- ❌ **相位差测量误差**: 不同滤波器可能引入相位偏差

**建议**:
- 统一为 LPF_ORDER = 8 (256点)
- 或提供参数化配置

---

### 3.4 ✅ 数据通路

**输入数据**:
```verilog
.ch1_data ({5'd0, ch1_data_11b}),  // 11位扩展到16位 ✅
.ch2_data ({5'd0, ch2_data_11b}),
.data_valid (dual_data_valid),     // 双通道同步有效 ✅
```

**时钟域**:
```verilog
.clk (clk_fft),  // 100MHz FFT时钟 ⚠️
```

**问题**:
- ⚠️ **时钟域错误**: 使用 `clk_fft` (100MHz) 而不是 `clk_adc` (35MHz)
- ⚠️ ADC数据在 `clk_adc` 域，需要跨时钟域同步
- ⚠️ 当前 `dual_data_valid` 可能不是在 `clk_fft` 域

**建议**:
- 改用 `clk_adc` 作为锁相放大器时钟
- 或添加 FIFO 做时钟域转换

---

### 3.5 ✅ 输出信号

**检测结果**:
- ✅ I/Q分量 (24-bit)
- ✅ 幅度 (24-bit)
- ✅ 相位 (16-bit)
- ✅ 锁定标志 (1-bit)
- ✅ SNR估计 (16-bit, 8.8定点)

**问题**:
- ⚠️ **输出未使用**: 这些信号未连接到 HDMI 显示或 UART 输出
- ⚠️ 用户看不到检测结果

---

## 4. 性能评估

### 4.1 理论性能

| 指标 | 数值 | 说明 |
|-----|------|------|
| **频率范围** | DC - 17 MHz | 受采样率限制 |
| **增益范围** | 0 - 90 dB | 15档可调 |
| **带宽** | ~68 kHz | 256点滤波器 |
| **相位精度** | ±2° | 16位相位 (理论) |
| **SNR改善** | 24 dB | 256点平均 (10×log₁₀(256)) |
| **处理延迟** | ~7.3 μs | 256点 @ 35MHz |

### 4.2 实际限制

**噪声**:
- ADC量化噪声: ~60 dB (10-bit)
- DDS相位噪声: ~-80 dBc (查找表)
- 混频器噪声: <-90 dBc (数字乘法)

**动态范围**:
- ADC: 60 dB
- 数字增益: +90 dB
- 总动态范围: ~150 dB (理论)

**频率精度**:
- 相位累加器: 32-bit
- 频率分辨率: Fs / 2³² ≈ 0.008 Hz @ 35MHz

---

## 5. 问题汇总

### 5.1 ❌ 关键缺陷 (P0)

| 问题 | 位置 | 影响 | 优先级 |
|-----|------|------|--------|
| **按键未连接** | signal_analyzer_top.v:2136 | 功能无法启用 | P0 |
| **时钟域错误** | signal_analyzer_top.v:1754 | 数据可能不同步 | P0 |
| **滤波器阶数不一致** | weak_signal_detector.v:166,180 | 双通道相位差错误 | P0 |
| **相位计算错误** | lock_in_amplifier.v:344-353 | 相位值无意义 | P0 |

### 5.2 ⚠️ 重要问题 (P1)

| 问题 | 建议 | 优先级 |
|-----|-----|--------|
| 输出结果未显示 | 添加到HDMI或UART | P1 |
| 参数调整按键缺失 | 复用现有按键 | P1 |
| AGC响应速度固定 | 参数化配置 | P2 |
| 幅度计算精度低 | 使用CORDIC求模 | P2 |

---

## 6. 修复建议

### 6.1 🔧 立即修复 (今天)

#### 修复1: 连接按键
```verilog
// signal_analyzer_top.v
// 使用 user_button[7] (测试模式按键在非测试模式时复用)
assign btn_weak_sig_enable = user_button[7] & ~auto_test_enable;
```

#### 修复2: 统一滤波器阶数
```verilog
// weak_signal_detector.v
lock_in_amplifier #(
    .LPF_ORDER (8)  // CH1和CH2都使用256点
) u_lia_ch1 (...);

lock_in_amplifier #(
    .LPF_ORDER (8)  // 统一为8
) u_lia_ch2 (...);
```

#### 修复3: 修正时钟域
```verilog
// signal_analyzer_top.v
weak_signal_detector u_weak_sig_detector (
    .clk (clk_adc),  // 改用ADC时钟 ✅
    ...
);
```

#### 修复4: 修复相位计算
```verilog
// lock_in_amplifier.v
// 使用简化的atan2查找表或CORDIC IP核
// 详细实现见后续章节
```

---

### 6.2 🔨 功能完善 (本周)

#### 改进1: 添加结果显示
- HDMI显示: 幅度、相位、SNR、锁定状态
- LED指示: 锁定状态 (闪烁/常亮)
- UART输出: 详细参数

#### 改进2: 参数调整界面
- 参考频率: ±100Hz/±1kHz (双击切换步进)
- 增益: 手动/自动切换
- 参考模式: 内部DDS / CH2 / 外部

---

## 7. 测试验证计划

### 7.1 单元测试

#### 测试1: DDS频率精度
```
输入: ref_freq = 1000 Hz
预期: 实际输出 1000.00 Hz ± 0.01 Hz
验证: 用频谱分析仪测量DDS输出
```

#### 测试2: 锁相检测
```
输入: 1kHz正弦波, -40dBm (微弱信号)
预期: 
  - locked = 1
  - magnitude > 0 (可检测)
  - phase 稳定 (±5°)
```

#### 测试3: SNR改善
```
输入: 1kHz正弦波 + 白噪声 (SNR = 0dB)
预期: 输出SNR > 24 dB (256点平均增益)
```

### 7.2 集成测试

#### 测试4: 双通道相位差
```
输入: 
  CH1: 1kHz, 0°
  CH2: 1kHz, 90°
预期: phase_diff = 90° ± 2°
```

#### 测试5: 频率跟踪
```
输入: 扫频信号 100Hz - 10kHz
预期: detected_freq 跟随输入频率
```

---

## 8. 资源占用估算

| 模块 | LUT | FF | DSP | BRAM |
|-----|-----|----|----|------|
| DDS (正弦表) | ~200 | ~100 | 0 | 0 |
| 混频器 (×2) | ~50 | ~100 | 4 | 0 |
| 低通滤波 (×2) | ~500 | ~1000 | 0 | 0 |
| 幅度/相位 | ~300 | ~200 | 0 | 0 |
| AGC + SNR | ~200 | ~150 | 0 | 0 |
| **单通道总计** | **~1250** | **~1550** | **4** | **0** |
| **双通道总计** | **~2500** | **~3100** | **8** | **0** |

**建议**: 实际综合后检查资源，确保 <30% LUT, <50% DSP

---

## 9. 结论

### 9.1 ✅ 优点
1. **架构完整**: DDS + 混频 + 滤波 + 检测
2. **双通道**: 支持相位差测量
3. **自动增益**: 适应宽动态范围
4. **低资源**: 无需大量BRAM或DSP

### 9.2 ❌ 必须修复
1. **按键未连接** - 功能无法启用
2. **时钟域错误** - 数据可能损坏
3. **滤波器不一致** - 相位差测量错误
4. **相位计算错误** - 输出无意义

### 9.3 📋 修复优先级

**P0 (今天完成)**:
- [ ] 连接启用按键
- [ ] 修正时钟域
- [ ] 统一滤波器阶数

**P1 (本周完成)**:
- [ ] 修复相位计算 (使用CORDIC或LUT)
- [ ] 添加HDMI显示输出
- [ ] 实现参数调整按键

**P2 (优化项)**:
- [ ] AGC参数可配置
- [ ] 幅度计算使用CORDIC
- [ ] 添加频率跟踪模式

---

**检查人**: GitHub Copilot  
**审核状态**: 待修复后验证  
**下一步**: 立即执行P0级修复
