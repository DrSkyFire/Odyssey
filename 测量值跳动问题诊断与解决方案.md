# 测量值跳动问题诊断与解决方案

## 📋 问题描述
- **现象**：所有测量值（频率、幅度、占空比、THD）大幅跳动
- **触发条件**：启用Hann窗后立即出现
- **日期**：2025-11-06

---

## 🔍 根本原因

### Hann窗导致跳动的机制

```
Hann窗函数：w(n) = 0.5 - 0.5*cos(2πn/N)

特性：
  - 两端接近0（前后各2048点几乎衰减100%）
  - 中心接近1（只有中间4096点有效）
  - 能量损失不均匀（取决于信号在窗内的位置）
```

**跳动原因**：
1. **采样相位敏感**：每次FFT采样起始点不同
2. **能量分布不均**：低频信号（如1kHz）在8192点窗内仅1-2个周期
3. **有效样本数变化**：信号可能主要落在窗的强衰减区或有效区
4. **EMA滤波器无效**：这种跳动是系统性的，不是随机噪声

### 示例分析（1kHz信号，35MHz采样）

```
1kHz周期 = 1ms = 35000个采样点
8192点窗 = 234μs = 0.234个周期

情况1：信号峰值在窗中心
  → 能量保留70% → FFT幅度高 → 测量值大

情况2：信号峰值在窗边缘  
  → 能量保留10% → FFT幅度低 → 测量值小

跳动幅度：700% 差异！
```

---

## ✅ 解决方案

### 方案1: 禁用窗函数（推荐，已实施）⭐⭐⭐⭐⭐

**修改文件**: `dual_channel_fft_controller.v`

**配置参数**:
```verilog
// 第91行
parameter ENABLE_WINDOW = 0;  // 0=禁用（矩形窗），1=启用Hann窗
```

**设置为0（默认）** - 禁用窗函数

**优点**:
- ✅ 测量值稳定，无跳动
- ✅ 适合固定频率信号（赛题场景）
- ✅ EMA滤波器可有效抑制随机噪声
- ✅ 幅度准确（无窗函数衰减）

**缺点**:
- ⚠️ FFT噪声底噪高18dB（-13dB vs -31dB）
- ⚠️ 频谱泄漏较大（但对固定频率影响小）

---

### 方案2: 增强EMA滤波器（已实施）⭐⭐⭐⭐

**修改文件**: `signal_parameter_measure.v`

**当前配置**:
```verilog
// 频率滤波器（第544行）
localparam FREQ_ALPHA_SHIFT = 3;  // α = 1/8（等效8次平均）

// 幅度滤波器（第983行）
localparam AMP_ALPHA_SHIFT = 3;   // α = 1/8（等效8次平均）

// 占空比滤波器（第1480行）
localparam DUTY_ALPHA_SHIFT = 3;  // α = 1/8（等效8次平均）

// THD滤波器（第1661行）
localparam THD_ALPHA_SHIFT = 3;   // α = 1/8（等效8次平均）
```

**调整策略**:
| ALPHA_SHIFT | α值 | 等效平均 | 响应时间 | 平滑强度 |
|-------------|-----|---------|---------|---------|
| 2 | 0.25 | 4次 | 200ms | 弱 ⭐⭐ |
| 3 | 0.125 | 8次 | 400ms | 中 ⭐⭐⭐⭐（当前）|
| 4 | 0.0625 | 16次 | 800ms | 强 ⭐⭐⭐⭐⭐ |
| 5 | 0.03125 | 32次 | 1600ms | 极强（不推荐）|

**如果仍跳动**：将所有ALPHA_SHIFT改为4

---

### 方案3: 切换到Flat-Top窗（未实施，长期方案）⭐⭐⭐

**原理**: Flat-Top窗专为幅度测量设计，主瓣宽而平

**优点**:
- ✅ 幅度精度±0.01dB（vs Hann的±1.5dB）
- ✅ 对采样相位不敏感
- ✅ 测量值稳定

**缺点**:
- ⚠️ 频率分辨率降低50%
- ⚠️ 需要重新生成窗系数文件

**实施步骤**（如需要）:
1. 修改`generate_hann_window.py`生成Flat-Top系数
2. 替换窗系数文件
3. 设置`ENABLE_WINDOW = 1`

---

## 🛠️ 快速配置指南

### 配置1: 稳定优先（推荐）✅ **当前配置**

```verilog
// dual_channel_fft_controller.v
parameter ENABLE_WINDOW = 0;  // 禁用窗函数

// signal_parameter_measure.v
localparam FREQ_ALPHA_SHIFT = 3;   // α = 0.125
localparam AMP_ALPHA_SHIFT = 3;    // α = 0.125
localparam DUTY_ALPHA_SHIFT = 3;   // α = 0.125
localparam THD_ALPHA_SHIFT = 3;    // α = 0.125
```

**特性**:
- 测量值稳定 ✅
- 响应时间：400ms
- 噪声抑制：中等

---

### 配置2: 快速响应（如果不跳动）

```verilog
// dual_channel_fft_controller.v
parameter ENABLE_WINDOW = 0;  // 禁用窗函数

// signal_parameter_measure.v
localparam FREQ_ALPHA_SHIFT = 2;   // α = 0.25
localparam AMP_ALPHA_SHIFT = 2;    // α = 0.25
localparam DUTY_ALPHA_SHIFT = 2;   // α = 0.25
localparam THD_ALPHA_SHIFT = 2;    // α = 0.25
```

**特性**:
- 测量值可能轻微抖动 ⚠️
- 响应时间：200ms ⚡
- 噪声抑制：弱

---

### 配置3: 极致平滑（如果仍跳动）

```verilog
// dual_channel_fft_controller.v
parameter ENABLE_WINDOW = 0;  // 禁用窗函数

// signal_parameter_measure.v
localparam FREQ_ALPHA_SHIFT = 4;   // α = 0.0625
localparam AMP_ALPHA_SHIFT = 4;    // α = 0.0625
localparam DUTY_ALPHA_SHIFT = 4;   // α = 0.0625
localparam THD_ALPHA_SHIFT = 4;    // α = 0.0625
```

**特性**:
- 测量值极其稳定 ✅✅
- 响应时间：800ms（与原滑动平均相同）
- 噪声抑制：强

---

### 配置4: 尝试启用Hann窗（实验性）

```verilog
// dual_channel_fft_controller.v
parameter ENABLE_WINDOW = 1;  // ⚠️ 启用Hann窗

// signal_parameter_measure.v
localparam FREQ_ALPHA_SHIFT = 4;   // α = 0.0625（必须强滤波）
localparam AMP_ALPHA_SHIFT = 4;    // α = 0.0625
localparam DUTY_ALPHA_SHIFT = 4;   // α = 0.0625
localparam THD_ALPHA_SHIFT = 4;    // α = 0.0625
```

**特性**:
- FFT噪声底噪低18dB ✅
- 可能仍有轻微跳动 ⚠️
- 响应时间：800ms

---

## 📊 配置对比表

| 配置 | 窗函数 | α值 | 响应时间 | 稳定性 | FFT噪声 | 推荐场景 |
|------|--------|-----|---------|--------|---------|---------|
| **配置1（当前）** | 矩形 | 0.125 | 400ms | ⭐⭐⭐⭐⭐ | -13dB | **通用推荐** |
| 配置2 | 矩形 | 0.25 | 200ms | ⭐⭐⭐ | -13dB | 快速响应需求 |
| 配置3 | 矩形 | 0.0625 | 800ms | ⭐⭐⭐⭐⭐ | -13dB | 跳动严重时 |
| 配置4 | Hann | 0.0625 | 800ms | ⭐⭐⭐ | -31dB | 强噪声环境 |

---

## 🧪 测试验证

### 测试步骤
1. **编译下载**：使用当前配置（配置1）
2. **观察跳动**：
   - 设置1kHz正弦波输入
   - 观察频率显示是否稳定
   - 记录跳动范围（如1000Hz±10Hz）
3. **评估效果**：
   - 如果跳动<±20Hz → ✅ 配置1满足需求
   - 如果跳动>±50Hz → 🔧 切换到配置3

### 判断标准
| 参数 | 可接受跳动 | 不可接受跳动 |
|------|-----------|-------------|
| 频率 | ±20Hz | >±50Hz |
| 幅度 | ±10mV | >±30mV |
| 占空比 | ±0.5% | >±2% |
| THD | ±1% | >±5% |

---

## 🔄 快速切换方法

### 方法1: 修改参数（推荐）

**只需修改2个文件的参数值**：

1. `dual_channel_fft_controller.v` 第91行
2. `signal_parameter_measure.v` 第544、983、1480、1661行

**无需修改其他代码**！

### 方法2: Git分支切换

```bash
# 如果当前配置不满意，回退到原始滑动平均
git checkout main

# 或创建新配置分支
git checkout -b config/stable-alpha-0.0625
```

---

## 📝 当前实施状态

### ✅ 已实施（2025-11-06）

1. **禁用窗函数**（默认配置）
   - `ENABLE_WINDOW = 0`
   - 文件：`dual_channel_fft_controller.v`

2. **增强EMA滤波**（α=0.125）
   - 所有滤波器：`ALPHA_SHIFT = 3`
   - 文件：`signal_parameter_measure.v`

3. **可配置架构**
   - 使用parameter和localparam
   - 无需重写代码即可调整

---

## 💡 建议

### 立即行动
1. ✅ 使用当前配置（配置1）编译测试
2. ✅ 观察测量值稳定性
3. ✅ 如果满意，无需进一步调整

### 如果仍跳动
1. 🔧 将所有`ALPHA_SHIFT`从3改为4
2. 🔧 重新编译测试
3. 🔧 应该可以解决99%的跳动问题

### 长期优化（可选）
1. 📚 研究Flat-Top窗实现
2. 📚 添加自适应α系数（根据信号变化率动态调整）
3. 📚 实现中值滤波+EMA组合

---

## ⚠️ 重要提醒

**Hann窗不适合您的应用场景**：
- ✅ 适合：宽带噪声环境、频谱分析、信号识别
- ❌ 不适合：固定频率测量、低频信号、幅度精度要求高

**您的场景（竞赛信号源）**：
- 信号稳定、频率固定
- 无需-31dB旁瓣抑制
- 矩形窗+EMA滤波器足够 ✅

---

**配置已完成，建议测试配置1（当前默认配置）**
