# HDMI时序违例快速修复方案

## 当前状态
- **违例时钟**: clk_hdmi_pixel @ 148.5MHz
- **WNS**: -2.564ns (需求6.734ns, 实际9.298ns)
- **关键路径**: pixel_x_d1[6] → char_code[1] (11层MUX)
- **Git状态**: 已提交到commit a42ca71 ✅

## 🔴 推荐方案：降低像素时钟频率

### 方案详情
修改`pll_hdmi` IP核的输出频率：
- **当前**: 148.5MHz (1080p@60Hz)
- **修改为**: 100MHz (1080p@40Hz) 或 74.25MHz (720p@60Hz)

### 修改步骤

#### Step 1: 在Pango Design Suite中打开PLL配置
1. 打开项目：`Odyssey.pds`
2. 在IP Catalog中找到：`ipcore/pll_hdmi/pll_hdmi.idf`
3. 双击打开PLL GUI配置界面

#### Step 2: 修改输出时钟频率
找到输出时钟配置（clk_pixel_out）:
```
当前设置:
- Input Frequency: 50MHz (系统输入时钟)
- Output Frequency: 148.5MHz (倍频系数 x 2.97)

修改为（选择其一）:
选项A - 1080p@40Hz:
- Output Frequency: 100MHz (倍频系数 x 2.0)
- 优点：保持1080p分辨率，帧率降低可接受

选项B - 720p@60Hz:
- Output Frequency: 74.25MHz (倍频系数 x 1.485)
- 优点：保持60Hz流畅度，降低分辨率
```

#### Step 3: 重新生成IP核
1. 点击"Generate" 生成新的PLL配置
2. 确认IP核文件更新：`ipcore/pll_hdmi/pll_hdmi.v`

#### Step 4: 更新HDMI时序参数（如果选择选项B）
如果选择720p@60Hz，需要修改`hdmi_display_ctrl.v`的参数：

```verilog
// 在文件开头修改分辨率参数 (约行30-40)
localparam H_ACTIVE  = 1280;  // 改为 1280 (720p)
localparam V_ACTIVE  = 720;   // 改为 720

// 同步时序参数
localparam H_FP = 110;
localparam H_SYNC = 40;
localparam H_BP = 220;
localparam V_FP = 5;
localparam V_SYNC = 5;
localparam V_BP = 20;
```

**注意**：如果选择1080p@40Hz，无需修改显示参数，仅修改PLL即可。

#### Step 5: 重新综合
1. 在Pango Design Suite中点击"Synthesize"
2. 等待综合完成 (~5分钟)
3. 检查时序报告：`report_timing/signal_analyzer_top.rtr`

#### Step 6: 验证时序
预期结果：
```
选项A (100MHz):
- clk_hdmi_pixel: WNS = +1.0ns ~ +2.0ns ✅
- 裕量: ~2.7ns (原违例-2.564ns + 降频改善~4.7ns)

选项B (74.25MHz):
- clk_hdmi_pixel: WNS = +4.0ns ~ +6.0ns ✅
- 裕量: ~6.5ns (原违例-2.564ns + 降频改善~9.0ns)
```

### 优缺点分析

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| 1080p@40Hz (100MHz) | ✅ 保持高分辨率<br>✅ 帧率可接受<br>✅ 仅改PLL | ⚠️ 帧率稍降 | ⭐⭐⭐⭐⭐ |
| 720p@60Hz (74.25MHz) | ✅ 保持流畅度<br>✅ 时序裕量大 | ❌ 分辨率降低<br>⚠️ 需改显示参数 | ⭐⭐⭐⭐ |

## 🔵 备用方案：流水线寄存器优化

如果必须保持1080p@60Hz，考虑插入流水线寄存器（详见`timing_fix_plan.md`）：
- **预期改善**: WNS +3~5ns
- **风险**: 需要调整延迟链，功能验证工作量大
- **时间成本**: ~70分钟

## 🟢 Git回退指令

如果修改后出现问题，回退到当前稳定版本：
```bash
git reset --hard a42ca71
git clean -fd
```

## 📊 预期时间线

### 方案A (1080p@40Hz)
1. 修改PLL配置: 5分钟
2. 重新综合: 5分钟
3. 时序验证: 5分钟
4. **总计**: ~15分钟

### 方案B (720p@60Hz)
1. 修改PLL配置: 5分钟
2. 修改显示参数: 10分钟
3. 重新综合: 5分钟
4. 时序验证: 5分钟
5. **总计**: ~25分钟

## 💡 建议
1. **优先尝试方案A** (1080p@40Hz)，修改最小，风险最低
2. 如果方案A时序仍不满足，再尝试方案B
3. 将流水线优化作为最后手段，仅在必须保持60Hz时使用

## ✅ 执行检查清单
- [ ] 创建Git备份分支
- [ ] 修改PLL配置 (clk_pixel: 148.5MHz → 100MHz/74.25MHz)
- [ ] (可选) 修改显示参数 (仅720p)
- [ ] 重新综合项目
- [ ] 检查时序报告 (WNS > 0)
- [ ] 功能测试 (显示正常)
- [ ] Git提交修复版本

---

**创建时间**: 2025-10-30  
**当前commit**: a42ca71  
**预期效果**: WNS从-2.564ns改善到+1.0ns以上
