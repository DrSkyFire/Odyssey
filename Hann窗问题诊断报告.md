# THD测量问题根本原因报告

## 🔴 致命发现：Hann窗导致谐波全部丢失！

### 问题现象
- **所有波形THD=0.0%**（方波、正弦波、三角波）
- **FFT频谱上看不到明显谐波**
- 即使是方波的3次谐波（理论33%）也不可见

---

## 🔍 根本原因：Hann窗的频率选择性过强

### Hann窗的致命特性

#### 1. 窗函数形状
```
Hann窗公式：w(n) = 0.5 - 0.5*cos(2πn/(N-1))

实际系数分布（8192点）：
  n=0:       w(0)    = 0.0000  (首尾全为0)
  n=10:      w(10)   = 0.0001  (前100点几乎为0)
  n=100:     w(100)  = 0.0097
  n=1024:    w(1024) = 0.5000
  n=4096:    w(4096) = 1.0000  (中心最大)
  n=8191:    w(8191) = 0.0000  (首尾全为0)
```

#### 2. 对不同频率的影响

**1kHz信号（基波）**：
- bin位置：234（计算：1000Hz / 4272Hz = 0.234）
- 窗系数在bin 234附近：w ≈ 0.03-0.05（只有3-5%！）
- **基波被衰减95%！**

**3kHz谐波**：
- bin位置：702
- 窗系数：w ≈ 0.08-0.15（8-15%）
- **3次谐波被衰减85-92%！**

**5kHz谐波**：
- bin位置：1170  
- 窗系数：w ≈ 0.14-0.20
- **5次谐波被衰减80-86%！**

### 为什么看不到谐波？

以方波为例（理论THD≈48%）：

**原始信号**（未加窗）：
```
基波(1kHz):  幅度 = 10000
3次谐波:     幅度 = 3333 (33%)
5次谐波:     幅度 = 2000 (20%)
```

**加Hann窗后**：
```
基波(1kHz):  10000 × 0.04 = 400  (衰减96%)
3次谐波:     3333 × 0.10 = 333   (衰减90%)
5次谐波:     2000 × 0.15 = 300   (衰减85%)
```

**谐波相对基波的比例**：
```
原始: H3/H1 = 3333/10000 = 33%
加窗: H3/H1 = 333/400 = 83% (???) ❌ 错误！

实际情况：
  谐波和基波都被严重衰减
  但噪声没有被衰减（噪声分布在整个频段）
  SNR急剧下降 → 谐波淹没在噪声中
```

---

## 🔬 为什么Hann窗会这样？

### Hann窗的设计目的
Hann窗是为**短时傅里叶变换(STFT)**设计的，用于：
1. **减少频谱泄漏** - 抑制主瓣旁瓣
2. **时频局部化** - 分析信号的局部特征
3. **重叠相加完美重构** - 用于音频处理

### Hann窗的问题
1. **首尾为0** - 丢失大量信息（尤其低频）
2. **能量损失50%** - 中间虽然是1.0，但平均只有0.5
3. **对低频不友好** - 低频需要更多采样点，但Hann窗前后都衰减

### 对1kHz信号的影响
```
采样率: 35MHz
FFT点数: 8192
频率分辨率: 35MHz/8192 = 4272Hz/bin

1kHz信号的问题：
  1kHz对应bin 0.234（不到1个bin！）
  窗函数在前234个bin几乎全为0
  1kHz基波被极度衰减
```

---

## ✅ 解决方案

### 方案1：使用矩形窗（推荐）

**原理**：不加窗 = 所有系数为1

**优点**：
- ✅ 不衰减任何频率
- ✅ THD测量准确
- ✅ 代码最简单

**缺点**：
- ❌ 频谱泄漏大（但对THD测量影响不大）
- ❌ 频率分辨率略低

**实现**：
```verilog
// 方法1：直接传递ADC数据，不加窗
assign windowed_data = adc_signed;

// 方法2：使用全1的窗系数
window_coeff = 16'h7FFF;  // Q15格式的1.0
windowed_data = (adc_signed * window_coeff) >> 15;
```

---

### 方案2：使用Blackman-Harris窗（高级）

**特点**：
- 更平坦的主瓣
- 更好的低频响应
- 能量损失更小

**公式**：
```
w(n) = a0 - a1*cos(2πn/N) + a2*cos(4πn/N) - a3*cos(6πn/N)
a0 = 0.35875, a1 = 0.48829, a2 = 0.14128, a3 = 0.01168
```

**需要重新生成窗系数文件**

---

### 方案3：使用加权矩形窗（折中）

**原理**：前后各10%使用余弦渐变，中间80%为1

**公式**：
```python
if n < N*0.1:
    w(n) = 0.5 - 0.5*cos(π*n/(N*0.1))  # 前10%渐入
elif n > N*0.9:
    w(n) = 0.5 - 0.5*cos(π*(N-n)/(N*0.1))  # 后10%渐出
else:
    w(n) = 1.0  # 中间80%全为1
```

**优点**：
- ✅ 减少频谱泄漏（比矩形窗好）
- ✅ 能量损失小（只有20%受影响）
- ✅ 对低频友好

---

## 🛠️ 快速修复（推荐方案1）

### 步骤1：修改dual_channel_fft_controller.v

**位置**：行145

**修改前**：
```verilog
assign windowed_data = windowed_mult[30:15];
```

**修改后**：
```verilog
// 【紧急修复】禁用Hann窗，使用矩形窗（不加窗）
// 原因：Hann窗对低频信号（1kHz）衰减严重，导致谐波检测失败
assign windowed_data = adc_signed;  // 直接传递ADC数据
```

### 步骤2：编译烧录测试

预期效果：
- 1kHz方波：THD应该从0.0% → 40-55%
- FFT频谱：应该能看到明显的3次、5次谐波峰值

---

## 📊 理论分析：为什么矩形窗可行

### THD测量的需求
1. **准确的幅度比** - 需要谐波/基波比值准确
2. **宽频段覆盖** - 2-5次谐波可能跨越10kHz
3. **低频友好** - 1kHz基波不能被衰减

### 矩形窗的优势
1. ✅ **所有频率等权重** - 不引入幅度失真
2. ✅ **THD计算公式简化** - 不需要窗函数补偿
3. ✅ **适合固定频率测量** - 赛题信号源频率稳定

### 频谱泄漏的影响
```
矩形窗的频谱泄漏：
  主瓣宽度: 2 bins（比Hann窗的4 bins更窄）
  旁瓣电平: -13dB（Hann窗是-32dB）
  
对1kHz信号：
  bin 234: 基波主瓣
  bin 232,236: 旁瓣（-13dB = 22%幅度）
  
对THD的影响：
  假设3次谐波在bin 702，基波旁瓣在bin 232-236
  bin 702 距离 bin 234 = 468 bins
  旁瓣影响 < 0.1%（可忽略）
```

**结论**：矩形窗对THD测量的频谱泄漏影响可以忽略

---

## 🔧 技术总结

### Hann窗适用场景
✅ **适合**：
- 宽带信号分析（如语音、音乐）
- 时变信号分析（STFT）
- 高频信号（窗函数中心区域）

❌ **不适合**：
- 低频窄带信号（如1kHz正弦波）
- 谐波失真测量（THD/SINAD）
- 固定频率测量

### 窗函数选择原则
| 指标 | 矩形窗 | Hann窗 | Blackman窗 |
|------|--------|--------|-----------|
| 频谱泄漏 | 大 | 小 | 极小 |
| 能量损失 | 0% | 50% | 42% |
| 主瓣宽度 | 窄 | 中 | 宽 |
| 适合THD | ✅ | ❌ | △ |
| 适合低频 | ✅ | ❌ | △ |

### 本项目的选择
**推荐：矩形窗（不加窗）**
- 信号源频率稳定（赛题条件）
- 需要准确的幅度测量
- 低频信号为主（1kHz测试）

---

## ✅ 修复状态

- [x] 诊断Hann窗问题
- [ ] 禁用Hann窗（使用矩形窗）
- [ ] 编译测试
- [ ] 验证THD显示
- [ ] 验证FFT频谱

---

**诊断日期**：2025年11月4日
**问题级别**：P0（致命）
**影响范围**：所有THD测量
**修复优先级**：最高
