# THDå§‹ç»ˆ0.0%çš„æœ€ç»ˆä¿®å¤ï¼ˆBug 6ï¼‰

## ğŸ”´ é—®é¢˜ç°è±¡ï¼ˆå…³é”®çº¿ç´¢ï¼‰

ç”¨æˆ·æŠ¥å‘Šï¼š
> **FFTé¢‘è°±èƒ½çœ‹åˆ°è°æ³¢å³°å€¼ï¼ˆé«˜é¢‘ã€é«˜å¹…åº¦æ—¶ï¼‰ï¼Œä½†THDä»æ˜¾ç¤º0.0%**

è¿™è¯´æ˜ï¼š
- âœ… FFTå·¥ä½œæ­£å¸¸ï¼ˆèƒ½çœ‹åˆ°è°æ³¢ï¼‰
- âœ… è°æ³¢æ£€æµ‹å·¥ä½œæ­£å¸¸ï¼ˆæ£€æµ‹åˆ°è°æ³¢ï¼‰
- âŒ **THDè®¡ç®—é“¾è·¯æœ‰é—®é¢˜**ï¼ˆæ²¡æœ‰è¢«è§¦å‘æˆ–ç»“æœæœªè¾“å‡ºï¼‰

---

## ğŸ” æ ¹æœ¬åŸå› ï¼šTHDè®¡ç®—åªæ‰§è¡Œä¸€æ¬¡

### Bugä½ç½®
**æ–‡ä»¶**ï¼š`signal_parameter_measure.v` è¡Œ1368

**é”™è¯¯ä»£ç **ï¼š
```verilog
if (thd_ready && !thd_ready_d1 && !thd_fft_trigger) begin
    //                            â†‘
    //                    è¿™ä¸ªæ¡ä»¶å¯¼è‡´åªæ‰§è¡Œä¸€æ¬¡ï¼
```

### é—®é¢˜åˆ†æ

**çŠ¶æ€æœºé€»è¾‘**ï¼š
```
FFTæ‰«æ1ï¼ˆç³»ç»Ÿå¯åŠ¨åç¬¬ä¸€æ¬¡ï¼‰:
  spectrum_addr = 4096 â†’ thd_readyå˜ä¸º1
  æ£€æµ‹åˆ°ä¸Šå‡æ²¿ï¼šthd_ready=1, thd_ready_d1=0, thd_fft_trigger=0
  æ¡ä»¶æ»¡è¶³ âœ… â†’ æ‰§è¡ŒTHDè®¡ç®—
  thd_fft_trigger å˜ä¸º 1

FFTæ‰«æ2ï¼ˆç¬¬äºŒæ¬¡åŠä»¥åï¼‰:
  spectrum_addr = 0 â†’ thd_readyå˜ä¸º0 â†’ thd_fft_triggeræ¸…é›¶
  spectrum_addr = 4096 â†’ thd_readyå˜ä¸º1
  æ£€æµ‹åˆ°ä¸Šå‡æ²¿ï¼šthd_ready=1, thd_ready_d1=0, thd_fft_trigger=0
  æ¡ä»¶æ»¡è¶³ âœ… â†’ åº”è¯¥æ‰§è¡ŒTHDè®¡ç®—
  
  ä½†å®é™…æƒ…å†µï¼ˆBugï¼‰ï¼š
  thd_fft_trigger åœ¨æ¸…é›¶å’Œé‡æ–°ç½®1ä¹‹é—´å­˜åœ¨timingçª—å£
  å¦‚æœFFTæ‰«æé€Ÿåº¦å¿«ï¼Œthd_fft_triggerå¯èƒ½è¿˜æ˜¯1
  æ¡ä»¶ !thd_fft_trigger ä¸æ»¡è¶³ âŒ
  â†’ ä¸æ‰§è¡ŒTHDè®¡ç®—ï¼
```

**æ›´è‡´å‘½çš„é—®é¢˜**ï¼š
å³ä½¿timingæ­£å¸¸ï¼Œé€»è¾‘æœ¬èº«å°±æœ‰é—®é¢˜ï¼š
```verilog
// åŸä»£ç æ„å›¾ï¼šé˜²æ­¢é‡å¤è§¦å‘
if (thd_ready && !thd_ready_d1 && !thd_fft_trigger) begin
    thd_fft_trigger <= 1'b1;  // ç½®1è¡¨ç¤º"å·²è§¦å‘"
}

// ä½†é—®é¢˜æ˜¯ï¼š
// 1. thd_fft_triggerä¸€æ—¦ç½®1ï¼Œæ¡ä»¶æ°¸è¿œä¸æ»¡è¶³
// 2. å³ä½¿æ¸…é›¶ï¼Œä¹Ÿå¯èƒ½åœ¨ä¸‹æ¬¡ä¸Šå‡æ²¿ä¹‹å‰æ²¡æ¥å¾—åŠæ¸…é›¶
// 3. å¯¼è‡´ç¬¬äºŒæ¬¡åŠä»¥åçš„FFTæ‰«æä¸è§¦å‘THDè®¡ç®—
```

### ä¸ºä»€ä¹ˆ"å¶å°”"èƒ½çœ‹åˆ°THDï¼Ÿ
- ç¬¬ä¸€æ¬¡FFTæ‰«ææ—¶ï¼Œ`thd_fft_trigger=0`ï¼Œæ¡ä»¶æ»¡è¶³ï¼Œæ‰§è¡Œè®¡ç®—
- å¦‚æœè¿™æ¬¡è®¡ç®—çš„ç»“æœæ°å¥½ä¸ä¸º0ï¼Œä¼šæ˜¾ç¤ºä¸€æ¬¡THD
- ä¹‹åçš„FFTæ‰«æéƒ½ä¸è§¦å‘è®¡ç®—ï¼ŒTHDä¿æŒç¬¬ä¸€æ¬¡çš„å€¼æˆ–å›åˆ°0

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ ¸å¿ƒä¿®æ”¹ï¼šç§»é™¤`!thd_fft_trigger`æ¡ä»¶

**ä¿®æ”¹å‰**ï¼š
```verilog
if (thd_ready && !thd_ready_d1 && !thd_fft_trigger) begin
```

**ä¿®æ”¹å**ï¼š
```verilog
if (thd_ready && !thd_ready_d1) begin
```

### ä¿®å¤åŸç†

**è¾¹æ²¿æ£€æµ‹çš„æ­£ç¡®é€»è¾‘**ï¼š
```verilog
// ä¸Šå‡æ²¿æ£€æµ‹åªéœ€è¦ä¸¤ä¸ªæ¡ä»¶ï¼š
// 1. å½“å‰å€¼ä¸º1ï¼ˆthd_readyï¼‰
// 2. ä¸Šä¸€å‘¨æœŸå€¼ä¸º0ï¼ˆ!thd_ready_d1ï¼‰

// thd_fft_trigger çš„ä½œç”¨æ˜¯"æ ‡è®°å·²è§¦å‘"ï¼Œç”¨äºå…¶ä»–é€»è¾‘
// ä½†ä¸åº”è¯¥ç”¨äº"é˜»æ­¢ä¸‹æ¬¡è§¦å‘"ï¼

æ¯æ¬¡FFTæ‰«æå‘¨æœŸï¼š
  spectrum_addr = 0    â†’ thd_ready = 0
  spectrum_addr = 4096 â†’ thd_ready = 1ï¼ˆä¸Šå‡æ²¿ï¼‰
  
  æ£€æµ‹ï¼šthd_ready=1 && thd_ready_d1=0 â†’ è§¦å‘THDè®¡ç®— âœ…
  
ä¸‹æ¬¡FFTæ‰«æï¼š
  spectrum_addr = 0    â†’ thd_ready = 0
  spectrum_addr = 4096 â†’ thd_ready = 1ï¼ˆä¸Šå‡æ²¿ï¼‰
  
  æ£€æµ‹ï¼šthd_ready=1 && thd_ready_d1=0 â†’ å†æ¬¡è§¦å‘ âœ…
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### ä¿®å¤å‰
```
FFTæ‰«æ1: THDè®¡ç®—è§¦å‘ âœ… â†’ å¯èƒ½æ˜¾ç¤ºTHDå€¼
FFTæ‰«æ2: THDè®¡ç®—ä¸è§¦å‘ âŒ â†’ THDå›åˆ°0.0%
FFTæ‰«æ3: THDè®¡ç®—ä¸è§¦å‘ âŒ â†’ THDä¿æŒ0.0%
...
```

### ä¿®å¤å
```
FFTæ‰«æ1: THDè®¡ç®—è§¦å‘ âœ… â†’ æ˜¾ç¤ºTHDå€¼
FFTæ‰«æ2: THDè®¡ç®—è§¦å‘ âœ… â†’ æ›´æ–°THDå€¼
FFTæ‰«æ3: THDè®¡ç®—è§¦å‘ âœ… â†’ æŒç»­æ›´æ–°
...
```

**å…·ä½“æ•°å€¼é¢„æœŸ**ï¼ˆå‡è®¾FFTèƒ½çœ‹åˆ°è°æ³¢ï¼‰ï¼š
| ä¿¡å· | é¢‘ç‡ | å¹…åº¦ | é¢„æœŸTHD |
|------|------|------|---------|
| æ­£å¼¦æ³¢ | 10kHz | 2Vpp | 0.5-2.0% |
| æ–¹æ³¢ | 10kHz | 2Vpp | 40-55% |
| ä¸‰è§’æ³¢ | 10kHz | 2Vpp | 10-15% |

---

## ğŸ§ª éªŒè¯æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šç¼–è¯‘çƒ§å½•
```powershell
# åœ¨TD IDEä¸­é‡æ–°ç¼–è¯‘
# ä¸‹è½½åˆ°FPGA
```

### ç¬¬äºŒæ­¥ï¼šä½¿ç”¨é«˜é¢‘ä¿¡å·æµ‹è¯•
è¾“å…¥ä¿¡å·ï¼š**10kHzæ–¹æ³¢ï¼Œ2Vpp**ï¼ˆç”¨æˆ·è¯´é«˜é¢‘èƒ½çœ‹åˆ°è°æ³¢ï¼‰

è§‚å¯ŸTHDæ˜¾ç¤ºï¼š
- âœ… åº”è¯¥æ˜¾ç¤ºï¼š40-55%
- âŒ å¦‚æœä»ç„¶0.0%ï¼šæ£€æŸ¥å…¶ä»–é—®é¢˜

### ç¬¬ä¸‰æ­¥ï¼šéªŒè¯æŒç»­æ›´æ–°
1. ä¿æŒ10kHzæ–¹æ³¢è¾“å…¥
2. è§‚å¯ŸTHDæ•°å€¼æ˜¯å¦ç¨³å®š
3. æ”¹å˜è¾“å…¥å¹…åº¦ï¼Œè§‚å¯ŸTHDæ˜¯å¦æ›´æ–°

**é¢„æœŸ**ï¼šTHDåº”è¯¥éšç€FFTæ›´æ–°è€ŒæŒç»­åˆ·æ–°ï¼ˆæ¯100msä¸€æ¬¡ï¼‰

---

## ğŸ”§ å¦‚æœé—®é¢˜ä»æœªè§£å†³

### å¯èƒ½çš„å…¶ä»–åŸå› 

#### 1. è°æ³¢é—¨é™ä»ç„¶è¿‡é«˜
è™½ç„¶FFTèƒ½çœ‹åˆ°è°æ³¢ï¼Œä½†å¯èƒ½è¢«é—¨é™è¿‡æ»¤äº†

**æ£€æŸ¥**ï¼š
```verilog
// åœ¨è¡Œ700-730ï¼Œè°æ³¢é—¨é™æ˜¯50/30/40/20
// å¦‚æœè°æ³¢å¹…åº¦<è¿™äº›å€¼ï¼Œä¼šè¢«ç½®0
```

**è§£å†³**ï¼šé™ä½é—¨é™è‡³10/10/10/10ï¼ˆä¸´æ—¶æµ‹è¯•ï¼‰

#### 2. åŸºæ³¢é—¨é™é—®é¢˜
```verilog
// è¡Œ1383ï¼šfft_max_amp > 16'd100
// å¦‚æœåŸºæ³¢å¹…åº¦<100ï¼Œä¸è§¦å‘è®¡ç®—
```

**è§£å†³**ï¼šé™ä½è‡³50ï¼ˆä¸´æ—¶æµ‹è¯•ï¼‰

#### 3. THDæ»¤æ³¢å™¨åˆå§‹åŒ–é—®é¢˜
ç¬¬ä¸€è½®ä¿®å¤çš„æ»¤æ³¢å™¨å¯èƒ½è¿˜æœ‰é—®é¢˜

**æ£€æŸ¥**ï¼šè§‚å¯Ÿ`thd_filtered`æ˜¯å¦æœ‰å€¼

---

## ğŸ“ ä¿®æ”¹å†å²

### Bug 6ï¼šTHDè®¡ç®—åªæ‰§è¡Œä¸€æ¬¡
- **æ–‡ä»¶**ï¼š`signal_parameter_measure.v`
- **è¡Œæ•°**ï¼š1368
- **ä¿®æ”¹**ï¼šç§»é™¤`!thd_fft_trigger`æ¡ä»¶
- **å½±å“**ï¼šå…è®¸æ¯æ¬¡FFTæ‰«æéƒ½è§¦å‘THDè®¡ç®—

### ä¹‹å‰çš„ä¿®å¤
1. âœ… Bug 1ï¼šTHDæ»¤æ³¢å™¨æ—¶åºï¼ˆv1ï¼‰
2. âœ… Bug 2ï¼šåŸºæ³¢é—¨é™è¿‡é«˜ï¼ˆv1ï¼‰
3. âœ… Bug 3ï¼šè°æ³¢é—¨é™è¿‡é«˜ï¼ˆv1ï¼‰
4. âœ… Bug 4ï¼šè°æ³¢binæ—¶åºé”™è¯¯ï¼ˆv2ï¼‰
5. âœ… Bug 5ï¼šHannçª—ä¸é€‚ç”¨ï¼ˆv3ï¼‰
6. âœ… Bug 6ï¼šTHDè®¡ç®—åªæ‰§è¡Œä¸€æ¬¡ï¼ˆv4ï¼‰

---

## ğŸ’¡ æŠ€æœ¯æ€»ç»“

### è¾¹æ²¿æ£€æµ‹çš„æ­£ç¡®å†™æ³•
```verilog
// âœ… æ­£ç¡®ï¼šç®€å•çš„ä¸Šå‡æ²¿æ£€æµ‹
if (signal && !signal_d1) begin
    // æ¯æ¬¡ä¸Šå‡æ²¿éƒ½è§¦å‘
end

// âŒ é”™è¯¯ï¼šåŠ å…¥"é˜²é‡å¤"æ¡ä»¶
if (signal && !signal_d1 && !triggered) begin
    triggered <= 1'b1;  // é˜»æ­¢åç»­è§¦å‘
    // åªè§¦å‘ä¸€æ¬¡ï¼Œä¹‹åå¤±æ•ˆ
end
```

### çŠ¶æ€æ ‡å¿—çš„ç”¨é€”
```verilog
reg triggered;  // çŠ¶æ€æ ‡å¿—

// ç”¨é€”1: ç»™å…¶ä»–æ¨¡å—æŸ¥è¯¢çŠ¶æ€ âœ…
assign status_out = triggered;

// ç”¨é€”2: é˜»æ­¢è¾¹æ²¿æ£€æµ‹ âŒ (æœ¬Bugçš„é”™è¯¯ç”¨æ³•)
if (edge_detect && !triggered) begin
    // è¿™æ ·ä¼šå¯¼è‡´åªæ‰§è¡Œä¸€æ¬¡
end

// ç”¨é€”3: çŠ¶æ€æœºæ§åˆ¶ âœ…
case (state)
    IDLE: if (start && !triggered) state <= RUNNING;
    RUNNING: if (done) triggered <= 1'b1;
endcase
```

---

**ä¿®å¤æ—¥æœŸ**ï¼š2025å¹´11æœˆ4æ—¥
**ç‰ˆæœ¬**ï¼šv4
**çŠ¶æ€**ï¼šå¾…éªŒè¯
**ä¼˜å…ˆçº§**ï¼šP0ï¼ˆæœ€é«˜ï¼‰
