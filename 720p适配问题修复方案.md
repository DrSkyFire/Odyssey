# 720p适配问题修复方案

**修复日期**: 2025年11月1日  
**问题来源**: 从1080p转换为720p后的遗留问题

## 问题列表

### 问题1: 字符大小映射未适配720p ✓ 需修改
**现象**: 数据测量区只显示4行，其他内容超出屏幕外  
**原因**: 字符高度仍为32像素(1080p设置)，行间距未按比例缩放  

**修改方案**:
- 字符高度: 32像素 → 21像素 (×0.65625)
- 行间距调整:
  ```
  第1行: Y=580-612  → Y=580-601  (PARAM_Y_START + 0)
  第2行: Y=615-647  → Y=603-624  (PARAM_Y_START + 23)
  第3行: Y=650-682  → Y=626-647  (PARAM_Y_START + 46)
  第4行: Y=685-717  → Y=649-670  (PARAM_Y_START + 69)
  第5行: Y=720-752  → Y=672-693  (PARAM_Y_START + 92)
  第6行: Y=755-787  → Y=695-716  (PARAM_Y_START + 115)
  ```

**修改文件**: `hdmi_display_ctrl.v`
- 第1018行: `PARAM_Y_START + 32` → `PARAM_Y_START + 21`
- 第1232行: `PARAM_Y_START + 35` → `PARAM_Y_START + 23`, `+ 67` → `+ 44`
- 第1367行: `PARAM_Y_START + 70` → `PARAM_Y_START + 46`, `+ 102` → `+ 67`
- 第1512行: `PARAM_Y_START + 105` → `PARAM_Y_START + 69`, `+ 137` → `+ 90`
- 第1647行: `PARAM_Y_START + 140` → `PARAM_Y_START + 92`, `+ 172` → `+ 113`
- 第1828行: `PARAM_Y_START + 175` → `PARAM_Y_START + 115`, `+ 207` → `+ 136`

同时更新注释中的行号说明。

---

### 问题2: 频率测量单位错误 ⚠️ 关键问题
**现象**: 输入500kHz，显示43.3kHz  
**误差分析**: 500/43.3 = 11.55倍  

**可能原因**:
1. **ADC采样率配置错误** (最可能)
   - 代码中设置: 35MHz
   - 实际可能是: 35MHz / 12 = 2.916MHz
   - 验证: 500kHz × (2.916/35) = 41.66kHz ≈ 43.3kHz ✓

2. **分频比错误**
   - PLL配置问题导致clk_adc不是35MHz

3. **频率计算公式错误**
   - `signal_parameter_measure.v`中的公式可能有误

**验证步骤**:
```verilog
// 检查 signal_analyzer_top.v 中的采样率配置
// 检查 PLL配置是否真的输出35MHz
// 使用chipscope抓取clk_adc频率
```

**临时解决**: 修改`signal_parameter_measure.v`中的频率计算公式，乘以12倍系数

---

### 问题3: 占空比测量误差 ⚠️ 次要问题
**现象**: 输入50%，显示49.1%  
**误差**: 1.8% (理论误差应为0.14%)

**可能原因**:
1. 高/低电平阈值不准确 (ADC零点漂移)
2. 计数器边界误差 (上升沿/下降沿检测延迟)
3. 采样率不匹配导致周期计数不准

**修改方案**:
- 检查`signal_parameter_measure.v`第195-240行的占空比计算
- 添加阈值自校准逻辑
- 验证`high_cnt`和`period_cnt`是否准确

---

### 问题4: 通道二频域不显示 🔴 严重问题
**现象**: 只有通道一的频域显示，通道二无显示  

**排查步骤**:
1. ✓ 检查`ch2_enable`信号状态
2. ✓ 检查`ch2_data`数据流
3. ✓ 检查频谱显示逻辑中的通道选择

**可能原因**:
```verilog
// hdmi_display_ctrl.v 第652-653行
spectrum_data_q <= ch1_enable ? ch1_data : ch2_data;
// ↑ 这行可能有问题，频谱模式应该同时显示两个通道
```

**预期行为**: 
- 频谱模式应同时绘制CH1和CH2
- 使用不同颜色区分（绿色/红色）
- 重叠部分显示黄色

**修改方案**: 
检查2000-2080行的频谱显示逻辑，确保`ch2_spec_hit`和`ch2_spectrum_calc_d1`正确使用。

---

### 问题5: 时域无波形显示 🔴 最严重问题
**现象**: 时域模式完全没有波形  

**可能原因**:
1. ✓ **spectrum_addr映射修改导致时域采样错误**
   - 我们修改了spectrum_addr的计算公式
   - 时域模式：`addr = (h_offset << 2) + (h_offset << 1) + (h_offset >> 1)`
   - 最大值: 7975 (应该是8191)

2. ✓ **work_mode判断错误**
   - `work_mode == 2'b00` 应该是时域模式
   - 检查是否混淆了时域/频域的判断

3. ✓ **RAM读取地址错误**
   - `ch1_ram_addr` / `ch2_ram_addr`可能未正确映射spectrum_addr

**关键代码检查**:
```verilog
// hdmi_display_ctrl.v 第2006-2016行
// 工作模式判断：
if (work_mode_d4 == 2'b00) begin
    // 时域波形绘制
    // 应该使用ch1_hit和ch2_hit
end else begin
    // 频谱绘制
end
```

**验证方法**:
- 添加调试信号输出`work_mode_d4`
- 检查`ch1_data_q`/`ch2_data_q`是否有有效数据
- 验证`ch1_hit`/`ch2_hit`是否被正确计算

---

## 修复优先级

### 高优先级 (P0 - 立即修复)
1. **问题5 - 时域无波形** - 系统核心功能失效
2. **问题4 - 通道二频域不显示** - 双通道功能失效

### 中优先级 (P1 - 尽快修复)  
3. **问题2 - 频率测量单位错误** - 影响使用体验
4. **问题1 - 字符大小映射** - 界面显示不完整

### 低优先级 (P2 - 后续优化)
5. **问题3 - 占空比测量误差** - 误差在可接受范围内

---

## 批量修改命令 (字符高度适配)

由于文本编码问题，推荐使用以下查找替换命令：

```
查找: pixel_y_d1 >= PARAM_Y_START \&\& pixel_y_d1 < PARAM_Y_START \+ 32
替换: pixel_y_d1 >= PARAM_Y_START && pixel_y_d1 < PARAM_Y_START + 21

查找: PARAM_Y_START \+ 35.*PARAM_Y_START \+ 67
替换: PARAM_Y_START + 23 && pixel_y_d1 < PARAM_Y_START + 44

查找: PARAM_Y_START \+ 70.*PARAM_Y_START \+ 102  
替换: PARAM_Y_START + 46 && pixel_y_d1 < PARAM_Y_START + 67

查找: PARAM_Y_START \+ 105.*PARAM_Y_START \+ 137
替换: PARAM_Y_START + 69 && pixel_y_d1 < PARAM_Y_START + 90

查找: PARAM_Y_START \+ 140.*PARAM_Y_START \+ 172
替换: PARAM_Y_START + 92 && pixel_y_d1 < PARAM_Y_START + 113

查找: PARAM_Y_START \+ 175.*PARAM_Y_START \+ 207
替换: PARAM_Y_START + 115 && pixel_y_d1 < PARAM_Y_START + 136

查找: - 12'd35
替换: - 12'd23

查找: - 12'd70
替换: - 12'd46

查找: - 12'd105
替换: - 12'd69

查找: - 12'd140
替换: - 12'd92

查找: - 12'd175
替换: - 12'd115
```

---

## 下一步行动

1. **立即执行**: 检查时域波形为什么不显示 (问题5)
2. **然后执行**: 检查通道二频域为什么不显示 (问题4)
3. **后续执行**: 批量修改字符高度参数 (问题1)
4. **深入分析**: 频率测量误差根源 (问题2)
5. **优化调整**: 占空比测量精度 (问题3)
