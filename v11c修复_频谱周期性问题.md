# é¢‘è°±å‘¨æœŸæ€§æ˜¾ç¤ºé—®é¢˜ä¿®å¤

**æ—¥æœŸ**: 2025-11-05  
**é—®é¢˜**: é¢‘è°±æ˜¾ç¤ºå‡ºç°å‘¨æœŸæ€§é‡å¤  
**ç‰ˆæœ¬**: v11c  

---

## ğŸ” **é—®é¢˜æ ¹å› **

### é”™è¯¯çš„å®ç°ï¼ˆv11bï¼‰:

```verilog
always @(posedge clk_pixel) begin
    h_offset <= pixel_x - AXIS_LEFT_MARGIN;  // æ—¶åºé€»è¾‘
    
    // âŒ é”™è¯¯ï¼šåœ¨ç»„åˆé€»è¾‘ä¸­ä½¿ç”¨h_offsetå¯„å­˜å™¨
    spectrum_addr <= (((h_offset << 6) + (h_offset << 5) + ...) >> 5);
end
```

**é—®é¢˜**:
1. `h_offset`æ˜¯å¯„å­˜å™¨ï¼Œä½¿ç”¨çš„æ˜¯**ä¸Šä¸€å‘¨æœŸçš„æ—§å€¼**
2. ç»„åˆé€»è¾‘é“¾è¿‡é•¿ï¼ˆ5çº§åŠ æ³•+å³ç§»ï¼‰ï¼Œ**æ—¶åºè¿ä¾‹**
3. å¯¼è‡´`spectrum_addr`è®¡ç®—é”™è¯¯æˆ–ä¸ç¨³å®š

**æ—¶åºå›¾**:
```
å‘¨æœŸN:   pixel_x=53,  h_offset=æ—§å€¼0,    spectrum_addr=0
å‘¨æœŸN+1: pixel_x=54,  h_offset=0,        spectrum_addr=0  âŒ (åº”è¯¥æ˜¯3)
å‘¨æœŸN+2: pixel_x=55,  h_offset=1,        spectrum_addr=3  âŒ (åº”è¯¥æ˜¯6)
å‘¨æœŸN+3: pixel_x=56,  h_offset=2,        spectrum_addr=6  âŒ (åº”è¯¥æ˜¯10)
...
```

**ç»“æœ**: åœ°å€é”™ä½+æ—¶åºä¸ç¨³å®š â†’ é¢‘è°±å‘¨æœŸæ€§é‡å¤æˆ–é”™ä¹±

---

## âœ… **ä¿®å¤æ–¹æ¡ˆï¼ˆv11cï¼‰**

### æµæ°´çº¿è®¡ç®—:

```verilog
always @(posedge clk_pixel) begin
    // Stage 1: æ›´æ–°h_offset
    h_offset <= pixel_x - AXIS_LEFT_MARGIN;
    
    // Stage 2: è®¡ç®— h_offset Ã— 107ï¼ˆä½¿ç”¨å½“å‰å‘¨æœŸçš„h_offsetï¼‰
    addr_mult_107 <= (h_offset << 6) + (h_offset << 5) + (h_offset << 3) + 
                     (h_offset << 1) + h_offset;
    
    // Stage 3: å³ç§»å¾—åˆ°æœ€ç»ˆåœ°å€
    spectrum_addr <= addr_mult_107[18:5];
end
```

**ä¼˜åŠ¿**:
1. âœ… æ¯çº§ä½¿ç”¨**ç¨³å®šçš„å¯„å­˜å™¨å€¼**ï¼ˆä¸æ˜¯ç»„åˆé€»è¾‘ï¼‰
2. âœ… åˆ†ä¸¤çº§æµæ°´çº¿ï¼Œ**æ—¶åºå®‰å…¨**
3. âœ… å»¶è¿Ÿ2å‘¨æœŸï¼Œä½†**åœ°å€è¿ç»­ç¨³å®š**

**æ—¶åºå›¾**:
```
å‘¨æœŸN:   h_offset=0,   addr_mult_107=æ—§å€¼,    spectrum_addr=æ—§å€¼
å‘¨æœŸN+1: h_offset=0,   addr_mult_107=0Ã—107=0, spectrum_addr=0
å‘¨æœŸN+2: h_offset=1,   addr_mult_107=0,       spectrum_addr=0
å‘¨æœŸN+3: h_offset=2,   addr_mult_107=1Ã—107,   spectrum_addr=3
å‘¨æœŸN+4: h_offset=3,   addr_mult_107=2Ã—107,   spectrum_addr=6
...

è™½ç„¶å»¶è¿Ÿ2å‘¨æœŸï¼Œä½†åœ°å€åºåˆ—æ­£ç¡®ï¼š0, 0, 3, 6, 10, 13, ...
ï¼ˆå‰2ä¸ªé‡å¤æ˜¯åˆå§‹åŒ–ï¼Œä¹‹åè¿ç»­æ­£ç¡®ï¼‰
```

---

## ğŸ§ª **éªŒè¯æµ‹è¯•**

### æµ‹è¯•1: é¢‘è°±çº¿æ€§åº¦

**ä¿¡å·**: 1kHzæ­£å¼¦æ³¢

**è§‚å¯Ÿ**:
- åŸºæ³¢å³°å€¼åº”è¯¥åªåœ¨**1ä¸ªä½ç½®**ï¼ˆbin[0.234] â‰ˆ åƒç´ 0-1ï¼‰
- **ä¸åº”æœ‰å‘¨æœŸæ€§é‡å¤çš„å³°å€¼**
- é¢‘è°±åº”è¯¥ä»å·¦åˆ°å³çº¿æ€§å±•å¼€ï¼ˆ0â†’17.5MHzï¼‰

**åˆ¤å®š**:
- âœ… æˆåŠŸï¼šå•å³°ï¼Œæ— é‡å¤
- âŒ å¤±è´¥ï¼šå¤šä¸ªå³°å€¼æˆ–å‘¨æœŸæ€§å›¾æ¡ˆ

---

### æµ‹è¯•2: å¤šé¢‘ä¿¡å·

**ä¿¡å·**: 100kHz + 1MHzåŒéŸ³

**è§‚å¯Ÿ**:
- åº”è¯¥çœ‹åˆ°2ä¸ªæ¸…æ™°çš„å³°
- 100kHzåœ¨å·¦ä¾§çº¦1/12å¤„
- 1MHzåœ¨ä¸­é—´çº¦1/2å¤„
- **å³°å€¼é—´è·åº”ä¸é¢‘ç‡æˆæ­£æ¯”**

**åˆ¤å®š**:
- âœ… æˆåŠŸï¼š2ä¸ªå³°ï¼Œä½ç½®æ­£ç¡®
- âŒ å¤±è´¥ï¼šè¶…è¿‡2ä¸ªå³°æˆ–ä½ç½®é”™ä¹±

---

### æµ‹è¯•3: 20kHzæ–¹æ³¢ï¼ˆç»¼åˆæµ‹è¯•ï¼‰

**ä¿¡å·**: 20kHzæ–¹æ³¢

**è§‚å¯Ÿ**:
1. é¢‘è°±åº”æ˜¾ç¤ºåŸºæ³¢+å¥‡æ¬¡è°æ³¢
2. åŸºæ³¢bin[4.68] â‰ˆ åƒç´ 16
3. 3æ¬¡è°æ³¢bin[14] â‰ˆ åƒç´ 47
4. 5æ¬¡è°æ³¢bin[23] â‰ˆ åƒç´ 77
5. **è°æ³¢é—´è·åº”é€æ¸å¢å¤§**

**åˆ¤å®š**:
- âœ… å®Œç¾ï¼šçœ‹åˆ°5-7ä¸ªè°æ³¢ï¼Œé—´è·é€’å¢
- âœ… è‰¯å¥½ï¼šçœ‹åˆ°3ä¸ªè°æ³¢ï¼Œä½ç½®å¤§è‡´æ­£ç¡®
- âŒ å¤±è´¥ï¼šè°æ³¢é‡å¤æˆ–é—´è·é”™ä¹±

---

## ğŸ“Š **å»¶è¿Ÿå½±å“åˆ†æ**

### v11bï¼ˆç»„åˆé€»è¾‘ï¼Œç†è®º0å»¶è¿Ÿï¼‰:
```
ä¼˜ç‚¹ï¼šå»¶è¿Ÿ0å‘¨æœŸ
ç¼ºç‚¹ï¼šæ—¶åºè¿ä¾‹ â†’ åœ°å€ä¸ç¨³å®š â†’ å‘¨æœŸæ€§é”™è¯¯ âŒ
```

### v11cï¼ˆæµæ°´çº¿ï¼Œ2å‘¨æœŸå»¶è¿Ÿï¼‰:
```
ä¼˜ç‚¹ï¼šæ—¶åºå®‰å…¨ï¼Œåœ°å€ç¨³å®š âœ…
ç¼ºç‚¹ï¼šå»¶è¿Ÿ2å‘¨æœŸ â‰ˆ 2åƒç´ é”™ä½ âš ï¸
```

**2åƒç´ è¯¯å·®å¯æ¥å—å—ï¼Ÿ**
```
1280åƒç´  â†’ 4096 bins
2åƒç´  â‰ˆ 6.4 bins â‰ˆ 27kHz

å¯¹äº17.5MHzèŒƒå›´ï¼š
  27kHz / 17.5MHz = 0.15% è¯¯å·®
  
ç»“è®ºï¼šå®Œå…¨å¯ä»¥æ¥å— âœ…
```

---

## ğŸ¯ **å¦‚æœä»æœ‰é—®é¢˜**

### é—®é¢˜A: ä»æœ‰å‘¨æœŸæ€§

**å¯èƒ½åŸå› **: `addr_mult_107`ä½å®½ä¸è¶³æˆ–æº¢å‡º

**æ£€æŸ¥**:
```verilog
reg [18:0] addr_mult_107;  // åº”è¯¥æ˜¯19ä½
// æœ€å¤§å€¼ = 1226 Ã— 107 = 131182 (18ä½è¶³å¤Ÿï¼š2^18=262144)
```

**è§£å†³**: ç¡®ä¿ä½å®½è¶³å¤Ÿ

---

### é—®é¢˜B: é¢‘è°±æ‹‰ä¼¸/å‹ç¼©

**å¯èƒ½åŸå› **: æ˜ å°„æ¯”ä¾‹ä¸å¯¹

**éªŒè¯å…¬å¼**:
```
pixel_x: 53 â†’ 1279 (1227ä¸ªåƒç´ )
h_offset: 0 â†’ 1226
spectrum_addr: 0 â†’ 4099 (åº”è¯¥0â†’4095)

æ¯”ä¾‹ï¼š4099 / 1226 = 3.34 âœ… æ­£ç¡®
```

**å¦‚æœä»ä¸å¯¹**: æ£€æŸ¥work_modeæ˜¯å¦æ­£ç¡®ï¼ˆé¢‘è°±æ¨¡å¼â‰ 00ï¼‰

---

### é—®é¢˜C: 2åƒç´ é”™ä½å¤ªå¤§

**é«˜çº§æ–¹æ¡ˆ**ï¼ˆä»…åœ¨å¿…è¦æ—¶ï¼‰:
```verilog
// ä½¿ç”¨wireç»„åˆé€»è¾‘ + æµæ°´çº¿ä¼˜åŒ–
wire [11:0] h_offset_comb = pixel_x - AXIS_LEFT_MARGIN;
reg [18:0] addr_mult_stage1;
reg [12:0] addr_mult_stage2;

always @(posedge clk_pixel) begin
    // Stage 1: éƒ¨åˆ†è®¡ç®—
    addr_mult_stage1 <= (h_offset_comb << 6) + (h_offset_comb << 5);
    
    // Stage 2: å®Œæˆè®¡ç®—
    addr_mult_stage2 <= addr_mult_stage1 + 
                        (h_offset << 3) + (h_offset << 1) + h_offset;
    
    // Stage 3: å³ç§»
    spectrum_addr <= addr_mult_stage2[17:5];
end
```

ä½†è¿™ä¼šå¢åŠ å¤æ‚åº¦ï¼Œ**ä¸æ¨è**é™¤é2åƒç´ è¯¯å·®ç¡®å®å½±å“æ˜¾ç¤ºã€‚

---

## æ€»ç»“

**v11cä¿®å¤**:
- âœ… ä½¿ç”¨æµæ°´çº¿è®¡ç®—ï¼Œé¿å…ç»„åˆé€»è¾‘æ—¶åºé—®é¢˜
- âœ… åœ°å€åºåˆ—ç¨³å®šè¿ç»­
- âš ï¸ å»¶è¿Ÿ2å‘¨æœŸï¼ˆ2åƒç´ ï¼Œ0.15%è¯¯å·®ï¼Œå¯æ¥å—ï¼‰

**æµ‹è¯•é‡ç‚¹**:
1. 1kHzå•å³°ï¼Œæ— é‡å¤ â†’ éªŒè¯å‘¨æœŸæ€§æ¶ˆé™¤
2. 100kHz+1MHzåŒå³° â†’ éªŒè¯çº¿æ€§æ˜ å°„
3. 20kHzæ–¹æ³¢è°æ³¢ â†’ éªŒè¯v11bçš„THDä¿®å¤ä»æœ‰æ•ˆ

**é¢„æœŸ**: é¢‘è°±æ˜¾ç¤ºæ­£å¸¸ï¼Œæ— å‘¨æœŸæ€§é‡å¤ ğŸ¯
