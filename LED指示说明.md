# LED状态指示说明

## LED灯位定义 (从右到左: LED0-LED7)

### 🔴 LED0 - 运行状态
- **亮**: 系统运行中 (run_flag = 1)
- **灭**: 系统停止
- **用途**: 确认系统是否在采集数据

### 🟡 LED1 - 工作模式 Bit0
- **工作模式编码**:
  - `LED2 LED1` = `0 0` → 时域模式 (示波器)
  - `LED2 LED1` = `0 1` → **频域模式 (FFT频谱)** ← 应该是这个!
  - `LED2 LED1` = `1 0` → 参数测量模式

### 🟡 LED2 - 工作模式 Bit1
- 配合LED1显示工作模式
- **正常状态**: 频域模式时 LED2=0, LED1=1

### 🟢 LED3 - FFT频谱数据有效
- **亮**: FFT正在输出频谱数据 (ch1_spectrum_valid = 1)
- **灭**: FFT未输出数据
- **关键指标**: 
  - 如果LED0亮但LED3不闪烁 → FFT可能未工作
  - 应该看到周期性闪烁 (约每0.3-0.5秒一次)

### 🔴 LED4 - 通道1 ADC溢出
- **亮**: 输入信号超出ADC量程 (>3.3V)
- **灭**: 正常
- **警告**: 如果常亮说明输入信号过大

### 🔴 LED5 - 通道2 ADC溢出
- **亮**: 通道2输入信号超出量程
- **灭**: 正常

### 🔵 LED6 - PLL1锁定状态
- **亮**: PLL1已锁定 (100MHz时钟正常)
- **灭**: PLL1未锁定 (系统无法工作)

### 🔵 LED7 - PLL2锁定状态
- **亮**: PLL2已锁定 (HDMI时钟正常)
- **灭**: PLL2未锁定 (HDMI显示异常)

---

## 🎯 快速诊断指南

### 正常工作状态 (频域模式)
```
LED7 LED6 LED5 LED4 LED3 LED2 LED1 LED0
 ✅   ✅   ⚪   ⚪   🔁   ⚪   ✅   ✅

✅ = 常亮
⚪ = 熄灭
🔁 = 周期性闪烁 (约2-3Hz)
```

**LED状态说明**:
- LED0 = ✅ (运行中)
- LED1 = ✅ (work_mode[0] = 1)
- LED2 = ⚪ (work_mode[1] = 0)
- LED3 = 🔁 (FFT频谱数据周期性输出)
- LED4/5 = ⚪ (无溢出)
- LED6/7 = ✅ (PLL锁定)

### 异常状态分析

#### ❌ 问题1: LED3不闪烁
```
LED3 = 熄灭或微弱闪烁
```
**原因**: FFT模块未工作
**检查**:
1. work_mode是否为1? (LED2=0, LED1=1)
2. run_flag是否为1? (LED0亮)
3. 如果LED0和LED1都亮但LED3不闪→ FFT模块故障

#### ❌ 问题2: 工作模式不是01
```
LED2 LED1 = 00 (时域模式) 或 10 (参数测量)
```
**原因**: 系统不在频域模式
**解决**: 按下模式切换按钮直到LED2=0, LED1=1

#### ❌ 问题3: LED0不亮
```
LED0 = 熄灭
```
**原因**: 系统未运行
**解决**: 
1. 等待0.5秒自动启动
2. 或按下start按钮

#### ❌ 问题4: LED6或LED7不亮
```
LED6 = 熄灭 或 LED7 = 熄灭
```
**原因**: PLL未锁定
**解决**: 
1. 重新上电
2. 检查晶振是否正常
3. 重新烧录bit文件

#### ❌ 问题5: LED4或LED5常亮
```
LED4/LED5 = 常亮
```
**原因**: 输入信号超出3.3V量程
**解决**: 
1. 降低信号发生器输出幅度
2. 使用衰减器
3. 检查信号发生器是否设置了DC偏置

---

## 🔧 当前问题诊断

根据你的测试数据异常，请检查以下LED状态:

### 步骤1: 检查基本状态
- [ ] LED0是否亮? (运行状态)
- [ ] LED6和LED7是否都亮? (PLL锁定)

### 步骤2: 检查工作模式
- [ ] LED1是什么状态? ⚪熄灭 / ✅常亮
- [ ] LED2是什么状态? ⚪熄灭 / ✅常亮

**预期**: LED2=熄灭, LED1=常亮 (频域模式)

### 步骤3: 检查FFT工作状态
- [ ] LED3是否周期性闪烁? (约2-3次/秒)

**如果LED3不闪烁或闪烁很慢**:
→ FFT可能未正常工作
→ 这可能是测量数据异常的根本原因

### 步骤4: 检查信号幅度
- [ ] LED4是否常亮? (通道1溢出)
- [ ] LED5是否常亮? (通道2溢出)

**如果常亮**: 输入信号过大,降低幅度

---

## 📊 LED状态记录表

| LED编号 | 名称 | 当前状态 | 预期状态 | 结论 |
|---------|------|----------|----------|------|
| LED0 | 运行状态 | ⚪/✅ | ✅常亮 | |
| LED1 | 模式Bit0 | ⚪/✅ | ✅常亮 | |
| LED2 | 模式Bit1 | ⚪/✅ | ⚪熄灭 | |
| LED3 | FFT数据有效 | ⚪/🔁 | 🔁闪烁 | |
| LED4 | 通道1溢出 | ⚪/✅ | ⚪熄灭 | |
| LED5 | 通道2溢出 | ⚪/✅ | ⚪熄灭 | |
| LED6 | PLL1锁定 | ⚪/✅ | ✅常亮 | |
| LED7 | PLL2锁定 | ⚪/✅ | ✅常亮 | |

**填写说明**:
- ⚪ = 熄灭
- ✅ = 常亮
- 🔁 = 闪烁

---

## 🎓 工作模式切换方法

### 按键定义 (需要确认你的硬件)
- **模式切换**: user_button[1] (Mode按钮)
- **启动/停止**: user_button[2] (Start/Stop)

### 模式循环顺序
1. 时域模式 (LED2=0, LED1=0) → 示波器波形
2. **频域模式 (LED2=0, LED1=1)** → FFT频谱图 ← 应该在这里
3. 参数测量 (LED2=1, LED1=0) → (预留)
4. 循环回时域模式

### 切换到频域模式
1. 观察LED1和LED2的状态
2. 如果不是 `LED2=熄灭, LED1=亮`
3. 按下Mode按钮直到达到目标状态
4. 观察HDMI屏幕是否显示频谱图

---

## 💡 建议操作

1. **立即检查LED状态**:
   - 记录所有8个LED的当前状态
   - 填写上面的LED状态记录表

2. **确认工作模式**:
   - 如果LED1不亮 → 不在频域模式
   - 按下Mode按钮切换到频域模式

3. **观察LED3闪烁**:
   - 应该看到周期性闪烁 (约0.3秒间隔)
   - 如果不闪烁 → FFT未工作

4. **重新测试**:
   - 输入1kHz, 1Vpp正弦波
   - 观察屏幕显示的频率值
   - 预期: 996-1004 Hz

---

## 🚨 紧急提示

### 如果LED3 (FFT数据有效) 不闪烁:
这说明FFT模块没有输出数据,可能的原因:
1. **work_mode不是1** → 检查LED1/LED2
2. **run_flag = 0** → 检查LED0是否亮
3. **FFT模块内部问题** → 需要用ILA调试

### 测量数据异常的根本原因分析:
根据你的测试数据:
- 频率严重偏离 (100Hz→47kHz)
- 幅度只有4%-40%
- THD恒为0

**90%的概率**: FFT模块未工作,系统回退到时域测量

**验证方法**: 观察LED3是否闪烁
- ✅ 闪烁 → FFT工作,问题在别处
- ❌ 不闪烁 → FFT未工作,这就是根本原因

---

**请先检查LED状态并反馈,这样我们才能确定下一步操作!**
