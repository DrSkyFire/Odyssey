# THD显示0.0%紧急修复（Bug 7）

## 🔴 问题现象

**测试条件**：1MHz方波，3Vpp
**FFT频谱**：能看到显著的谐波峰值 ✅
**THD显示**：仍然是0.0% ❌

**这说明**：
- ✅ FFT工作正常
- ✅ 谐波确实存在
- ❌ **谐波被门限过滤掉了**

---

## 🔍 根本原因：谐波门限阻止了所有谐波

### Bug位置
**文件**：`signal_parameter_measure.v` 行698-730

**问题代码**：
```verilog
// 扫描结束，锁存谐波幅度
else if (spectrum_addr == (FFT_POINTS/2)) begin
    // 2次谐波门限检查
    if (harm2_amp > 16'd50)  // ❌ 门限50
        fft_harmonic_2 <= harm2_amp;
    else
        fft_harmonic_2 <= 16'd0;  // 谐波被置0！
    
    // 3次谐波门限检查
    if (harm3_amp > 16'd30)  // ❌ 门限30
        fft_harmonic_3 <= harm3_amp;
    else
        fft_harmonic_3 <= 16'd0;
    // ... H4, H5类似
}
```

### 问题分析

**实际情况**（推测）：
```
1MHz方波，3Vpp输入：
  ADC采样：约600个level (3V / 5V × 1024)
  FFT输出（无Hann窗）：
    基波幅度(bin 234): ~5000-8000（估计）
    3次谐波(bin 702): ~1500-2500（理论33%）
    5次谐波(bin 1170): ~1000-1600（理论20%）

但检测到的幅度可能偏低：
  harm3_amp = 25（低于门限30） → fft_harmonic_3 = 0
  harm5_amp = 15（低于门限20） → fft_harmonic_5 = 0
  
结果：
  所有谐波被置0
  thd_harmonic_sum = 0
  不满足触发条件（谐波和>0）
  THD = 0.0%
```

**为什么会偏低？**
1. FFT输出幅度取决于很多因素（窗函数、增益等）
2. 之前禁用了Hann窗，但可能还有其他衰减因素
3. 谐波搜索窗口±3 bin可能太小，错过真实峰值
4. 门限设计基于理想假设，实际系统有偏差

---

## ✅ 修复方案

### 紧急修复：完全禁用谐波门限

**策略**：
1. 先禁用所有门限，确认THD计算链路工作
2. 观察实际谐波幅度值
3. 再根据实际值设计合理门限

**修改代码**：
```verilog
// 直接锁存检测到的谐波幅度，无门限检查
fft_harmonic_2 <= harm2_amp;
fft_harmonic_3 <= harm3_amp;
fft_harmonic_4 <= harm4_amp;
fft_harmonic_5 <= harm5_amp;
```

---

## 📊 预期效果

### 修复前（有门限）
```
谐波检测：
  harm3_amp = 25 (实际检测到)
  门限检查：25 > 30? ❌
  fft_harmonic_3 = 0 (被过滤)
  
THD计算：
  谐波和 = 0
  条件不满足，不计算
  THD = 0.0%
```

### 修复后（无门限）
```
谐波检测：
  harm3_amp = 25 (实际检测到)
  门限检查：无 ✅
  fft_harmonic_3 = 25 (直接锁存)
  
THD计算：
  谐波和 = 25 + 15 + ... > 0 ✅
  触发计算
  THD = (40/5000) × 1000 = 8% (示例)
```

**1MHz方波预期THD**：40-55%

---

## 🧪 验证步骤

### 第一步：编译烧录
```powershell
# 在TD IDE中编译
# 下载到FPGA
```

### 第二步：测试1MHz方波
输入信号：**1MHz方波，3Vpp**

**观察THD显示**：
- ✅ 应该显示：40-55%
- ❌ 如果仍然0.0%：检查其他问题

### 第三步：测试不同波形
| 信号 | 频率 | 幅度 | 预期THD | 实测THD | 状态 |
|------|------|------|---------|---------|------|
| 正弦波 | 1MHz | 3Vpp | <5% | _____ % | □ |
| 方波 | 1MHz | 3Vpp | 40-55% | _____ % | □ |
| 三角波 | 1MHz | 3Vpp | 10-15% | _____ % | □ |

---

## 🔧 后续优化

### 第一步：观察实际谐波幅度

**如果THD能正常显示了**，说明门限确实是问题。

**下一步**：
1. 记录不同信号的实际谐波幅度
2. 设计合理的自适应门限

### 第二步：设计智能门限

**策略**：基于基波幅度的百分比
```verilog
// 例如：谐波幅度 > 基波的1%
wire [15:0] threshold_h3 = fft_max_amp >> 7;  // 基波/128 ≈ 0.8%

if (harm3_amp > threshold_h3)
    fft_harmonic_3 <= harm3_amp;
else
    fft_harmonic_3 <= 16'd0;
```

### 第三步：添加噪声抑制

**如果无门限导致噪声干扰**：
```verilog
// 混合策略：自适应门限 + 绝对最小门限
wire [15:0] threshold = (fft_max_amp >> 7) > 16'd10 ? 
                        (fft_max_amp >> 7) : 16'd10;
```

---

## 📁 修改历史

### Bug 7：谐波门限过滤掉所有谐波
- **文件**：`signal_parameter_measure.v`
- **行数**：698-730
- **修改**：禁用谐波门限，直接锁存检测到的幅度
- **影响**：允许所有检测到的谐波进入THD计算

### 之前的修复
1. ✅ Bug 1：THD滤波器时序
2. ✅ Bug 2：基波门限过高
3. ✅ Bug 3：谐波门限过高（第一次）
4. ✅ Bug 4：谐波bin时序错误
5. ✅ Bug 5：Hann窗不适用
6. ✅ Bug 6：THD计算只执行一次
7. ✅ Bug 7：谐波门限完全禁用（紧急）

---

## 💡 经验教训

### 门限设计的原则

1. **先无门限测试**
   - 确保功能链路完整
   - 观察实际数据范围
   - 再添加门限优化

2. **门限应该是优化，不是必需**
   - 主功能应该在无门限时就能工作
   - 门限的作用是抑制噪声，不是过滤信号

3. **自适应优于固定**
   - 固定门限对不同幅度信号不适用
   - 基于基波的相对门限更稳健

4. **保守优于激进**
   - 宁可允许一些噪声，也不要过滤真实信号
   - 噪声可以后期滤波，信号丢失无法恢复

---

## ⚠️ 临时副作用

禁用门限可能导致：
1. **噪声干扰** - 微弱噪声也被当作谐波
2. **THD虚高** - 正弦波THD可能>5%（实际应<2%）
3. **数值跳动** - 噪声导致THD不稳定

**解决方法**：
- 测试通过后，重新设计智能门限
- 使用基波相对门限：`threshold = fft_max_amp / 100`
- 添加滑动平均滤波（已有）

---

**修复日期**：2025年11月4日
**版本**：v5
**状态**：紧急修复，待验证
**优先级**：P0（最高）

---

## 🎯 预期的测试结果

使用1MHz方波，3Vpp测试：

**如果成功**：
- THD显示：40-55% ✅
- 能区分方波和正弦波
- 数值相对稳定

**如果仍然0.0%**：
问题在THD计算链路的其他环节，需要进一步调试：
1. 检查`thd_harmonic_sum`是否>0
2. 检查`thd_calc_trigger`是否被触发
3. 检查`thd_pipe_valid`流水线
4. 检查`thd_filtered`是否有值

请立即编译测试！
