# THD测量问题修复报告v2

## 📋 问题追踪

### 第一轮修复（已完成）
**问题**：THD显示始终为0.0%
**原因**：
1. THD滤波器时序错误
2. 基波门限过高（200）
3. 谐波检测门限过高

**修复结果**：✅ THD有显示数值了

---

### 第二轮问题（当前）
**现象**：
- 1kHz方波(2Vpp)：THD显示20.2%-86.0%跳动，主稳定20.2%
- 1kHz正弦波(2Vpp)：THD显示20.2%-90%跳动，主稳定20.2%
- 1kHz三角波(2Vpp)：THD与上述相同

**问题分析**：
1. ❌ **所有波形THD都相同** - 应该方波>三角波>正弦波
2. ❌ **数值跳动很大** - 20.2%到90%之间剧烈跳动
3. ❌ **无法区分波形** - 说明谐波检测有严重问题

---

## 🔍 根本原因分析

### 🔴 Bug 4：谐波bin计算时序错误（最严重）

**位置**：原 `signal_parameter_measure.v` 行643-651

**问题代码**：
```verilog
// 前1/4扫描：持续更新谐波bin位置（跟随基波峰值）
if (spectrum_addr <= (FFT_POINTS/4)) begin
    harm2_bin <= (fft_peak_bin << 1);  // ❌ 使用当前扫描的fft_peak_bin
    harm3_bin <= (fft_peak_bin << 1) + fft_peak_bin;
    // ...
end
```

**致命问题**：

#### 1. 时序错位
```
扫描流程：
  t=0    spectrum_addr=0      fft_peak_bin = 上次扫描的值（如234）
  t=1    spectrum_addr=1-2047 基波检测进行中，fft_peak_bin持续更新
  t=100  spectrum_addr=234    找到当前基波峰值，fft_peak_bin=234
  t=200  spectrum_addr=500    fft_peak_bin=234（锁定）
  
谐波bin计算：
  在 spectrum_addr <= 2048（前1/4）时：
    harm2_bin = fft_peak_bin × 2
  
  问题：此时fft_peak_bin还在变化！
  - 如果在spectrum_addr=100时计算，harm2_bin = 旧值×2
  - 如果在spectrum_addr=234时计算，harm2_bin = 234×2 = 468（正确）
  - 但前面已经错过了468附近的检测！
```

#### 2. 使用上次扫描的基波bin
由于timing问题，实际使用的是**上次FFT扫描确定的基波bin**来计算谐波位置。

**为什么所有波形THD相同？**
1. 所有波形基波频率都是1kHz → fft_peak_bin都约等于234（1kHz对应bin）
2. 谐波bin计算：harm2_bin = 234×2 = 468, harm3_bin = 234×3 = 702...
3. **关键**：方波、正弦波、三角波的基波bin相同（都是234）
4. 所以检测的谐波位置也相同（468, 702, 936, 1170）
5. 但正弦波在这些位置**几乎没有谐波**，只有噪声底噪
6. 所有波形检测到的都是**相同的噪声底噪** → THD相同！

#### 3. 实际检测到的是什么？
```
正弦波（理想情况）：
  Bin 234: 基波幅度 = 10000（假设）
  Bin 468: 2次谐波 ≈ 50（噪声）
  Bin 702: 3次谐波 ≈ 30（噪声）
  → THD = (50+30+...) / 10000 × 100% ≈ 1-2%  ❌ 实测20%

方波：
  Bin 234: 基波幅度 = 8000
  Bin 468: 2次谐波 ≈ 50（理论应为0，实际是噪声）
  Bin 702: 3次谐波 ≈ 3000（理论应很大！）❌ 但如果检测时机错误可能漏检
  → THD应该 >40%，但实测也是20%
```

**结论**：谐波bin位置计算和检测时机都错了，导致：
- 正弦波：检测到噪声，THD虚高（20%而非<2%）
- 方波：漏检真实谐波，THD虚低（20%而非>40%）
- 三角波：同样漏检，THD错误

---

## ✅ 修复方案

### 方案：两次扫描策略

**原理**：
1. **第一次扫描**（当前扫描）：只检测基波峰值bin
2. **第二次扫描**（下次扫描）：基于**上次确定的基波bin**检测谐波

**实现**：
```verilog
// 在spectrum_addr=0（扫描开始）时：
if (spectrum_addr == 13'd0) begin
    // 【关键】使用上一次扫描确定的基波bin
    harm_detect_base_bin <= fft_peak_bin;  // 锁定基波bin
    
    // 立即计算所有谐波bin（基于锁定的基波bin）
    harm2_bin <= (fft_peak_bin << 1);                    // 2×基波
    harm3_bin <= (fft_peak_bin << 1) + fft_peak_bin;     // 3×基波
    harm4_bin <= (fft_peak_bin << 2);                    // 4×基波
    harm5_bin <= (fft_peak_bin << 2) + fft_peak_bin;     // 5×基波
    
    // 清空上次结果
    harm2_amp <= 16'd0;
    harm3_amp <= 16'd0;
    // ...
end

// 整个扫描过程中：谐波bin保持不变
else if (spectrum_addr >= 1 && spectrum_addr < FFT_POINTS/2) begin
    // 检测2次谐波（bin位置已锁定）
    if (spectrum_addr >= (harm2_bin - 3) && 
        spectrum_addr <= (harm2_bin + 3)) begin
        if (spectrum_data > harm2_amp)
            harm2_amp <= spectrum_data;
    end
    // ... 其他谐波类似
end
```

**优势**：
1. ✅ 谐波bin在扫描开始时就确定，整个扫描过程保持不变
2. ✅ 基于上次扫描的稳定基波bin，避免timing问题
3. ✅ 扩大搜索范围到±3 bin，提高容错性
4. ✅ 不同波形的谐波幅度差异能正确反映在THD中

---

## 📊 预期效果

### 修复前（当前）
| 波形 | 实测THD | 预期THD | 问题 |
|------|---------|---------|------|
| 正弦波 | 20.2% | <2% | ❌ 检测到噪声，虚高 |
| 方波 | 20.2% | 40-50% | ❌ 漏检谐波，虚低 |
| 三角波 | 20.2% | 10-15% | ❌ 漏检谐波，虚高 |

### 修复后（预期）
| 波形 | 预期THD | 说明 |
|------|---------|------|
| 正弦波 | 0.5-2.0% | ✅ 纯正弦波，谐波很小 |
| 方波 | 40-55% | ✅ 奇次谐波丰富（H3≈33%, H5≈20%） |
| 三角波 | 10-15% | ✅ 谐波比方波少（H3≈11%, H5≈4%） |

**跳动问题改善**：
- 修复前：20.2%-90%剧烈跳动（因为检测位置不稳定）
- 修复后：预期±2%小幅波动（正常的FFT噪声）

---

## 🧪 验证步骤

### 第一步：编译烧录
```powershell
# 在TD IDE中重新编译
# 烧录到FPGA
```

### 第二步：基础验证
输入信号：1kHz方波，2Vpp

**观察THD显示**：
- ✅ 应显示：40-55%
- ❌ 如仍显示20%：谐波检测仍有问题

### 第三步：波形区分度测试
| 波形 | 频率 | 幅度 | 预期THD | 实测THD | 状态 |
|------|------|------|---------|---------|------|
| 正弦波 | 1kHz | 2Vpp | <2% | _____ % | □ |
| 方波 | 1kHz | 2Vpp | 40-55% | _____ % | □ |
| 三角波 | 1kHz | 2Vpp | 10-15% | _____ % | □ |

**关键验证点**：
- 方波THD **必须明显高于**正弦波（至少20倍）
- 三角波THD 介于方波和正弦波之间
- 数值跳动应 <5%（不再是90%）

---

## 🔧 调试技巧

### 如果方波THD仍然偏低（<30%）

可能原因：
1. **谐波门限仍然过高** - 降低H3门限至10-20
2. **搜索窗口太小** - 已改为±3 bin
3. **Hann窗衰减过大** - 检查窗函数系数

### 如果正弦波THD仍然偏高（>5%）

可能原因：
1. **输入信号失真** - 检查信号源THD指标
2. **ADC非线性** - 正常，10位ADC本身有0.5-1%失真
3. **噪声底噪** - 降低谐波门限可能增加噪声误检

---

## 📁 修改文件清单

| 文件 | 修改内容 | 行数 | 状态 |
|------|----------|------|------|
| `signal_parameter_measure.v` | 谐波检测时序修复 | 620-730 | ✅ 已修复 |
| `signal_parameter_measure.v` | 新增harm_detect_base_bin信号 | 91 | ✅ 已添加 |
| `signal_parameter_measure.v` | 扩大谐波搜索范围±3 bin | 660-700 | ✅ 已修复 |

---

## 💡 技术总结

### 关键教训：FFT谐波检测的正确方法

❌ **错误方法**：在当前扫描中动态更新谐波bin
```verilog
// 问题：fft_peak_bin在扫描过程中变化
if (spectrum_addr <= FFT_POINTS/4)
    harm2_bin <= fft_peak_bin << 1;  // ❌ 不稳定
```

✅ **正确方法**：基于上次扫描的稳定基波bin
```verilog
// 在扫描开始时锁定谐波bin
if (spectrum_addr == 0) begin
    harm2_bin <= fft_peak_bin << 1;  // ✅ 基于上次扫描的稳定值
    // 整个扫描过程保持不变
end
```

### THD计算公式回顾
```
简化公式（本项目使用）：
THD = (H2 + H3 + H4 + H5) / H1 × 100%

标准公式（更准确）：
THD = √(H2² + H3² + H4² + H5²) / H1 × 100%

简化公式误差分析：
- 单一主导谐波：误差<5%（如方波的H3）
- 均匀分布谐波：误差约10%（偏保守）
- 对比赛题要求：简化公式已足够
```

### 理论THD参考值
```
方波（奇次谐波）：
  H3 = H1 × 1/3 = 33.3%
  H5 = H1 × 1/5 = 20.0%
  THD ≈ (0 + 33% + 0 + 20%) / 100% = 53%（简化公式）
  THD ≈ 48%（标准公式）

三角波：
  H3 = H1 × 1/9 = 11.1%
  H5 = H1 × 1/25 = 4.0%
  THD ≈ (0 + 11% + 0 + 4%) / 100% = 15%（简化公式）
  THD ≈ 12%（标准公式）

正弦波（理想）：
  H2,H3,H4,H5 ≈ 0
  THD ≈ 0%
  
正弦波（实际10位ADC）：
  ADC量化误差+非线性 → THD ≈ 0.5-2%
```

---

## ✅ 修复状态

- [x] Bug 1：THD滤波器时序 - v1修复
- [x] Bug 2：基波门限200→100 - v1修复
- [x] Bug 3：谐波检测门限过高 - v1修复
- [x] Bug 4：谐波bin计算时序错误 - v2修复
- [ ] 编译测试 - 待执行
- [ ] 上板验证 - 待执行
- [ ] 性能测试 - 待执行

---

**修复日期**：2025年11月4日
**版本**：v2
**状态**：已完成Bug 4修复，等待验证
