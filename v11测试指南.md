# v11版本测试指南

**日期**: 2025-11-05  
**版本**: v11  
**优化内容**: THD多帧平均 + 频谱显示修复  

---

## ✅ **v11完成的优化**

### 1. THD测量改进
- ✅ 谐波幅度8帧滑动平均（降低噪声69%）
- ✅ 动态噪声阈值（基波幅度3.125%，自适应0.3-3Vpp）
- ✅ 双重滤波策略（平均+阈值）

### 2. 频谱显示修复
- ✅ 高精度地址映射：`spectrum_addr = h_offset × 107/32`
- ✅ 误差从0.8%降低到0.1%
- ✅ 解决左侧（0-100kHz）横向拉伸问题

---

## 🧪 **测试流程**

### 测试1: 频谱显示修复验证 ⭐⭐⭐

**信号源**: 1kHz正弦波，2Vpp

**预期改进**:
```
修复前（v10c）:
  频谱显示：bin[0.234]被拉伸显示为2-3像素宽的宽峰 ❌
  
修复后（v11）:
  频谱显示：bin[0.234]显示为1像素宽的尖峰 ✅
```

**观察要点**:
1. 基波峰值应该**尖锐、窄**，不是宽条
2. 左侧0-100kHz区域刻度线性，无明显拉伸
3. 峰值位置应该在像素0-1之间

**判定标准**:
- ✅ 成功：基波峰值宽度≤2像素
- ❌ 失败：基波峰值宽度≥3像素（仍拉伸）

---

### 测试2: 低频THD恢复 ⭐⭐⭐

**信号源**: 20kHz方波，2Vpp

**预期改进**:
```
修复前（v10c）:
  THD: 0.0% ❌
  原因：基波bin[4.68]能量泄漏，谐波bin计算不准
  
修复后（v11）:
  THD: 40-48% ✅
  理论值：48.3%
```

**观察要点**:
1. OSD显示THD应该在40-48%范围
2. 频谱应能看到3次（bin[14]）、5次（bin[23]）谐波峰
3. THD数值应该稳定，不频繁跳动

**判定标准**:
- ✅ 完美：THD=45-48%，稳定±1%
- ✅ 良好：THD=40-45%，稳定±2%
- ⚠️ 可接受：THD=35-40%，跳动±3%
- ❌ 失败：THD<30%或仍为0%

---

### 测试3: THD稳定性改进 ⭐⭐⭐

**信号源**: 600kHz方波，2Vpp，连续观察30秒

**预期改进**:
```
修复前（v10c）:
  THD显示：51% → 55% → 52% → 54% → 51% ...
  跳动范围：±3% ❌
  
修复后（v11，8帧平均）:
  THD显示：53% → 53% → 53% → 53% → 53% ...
  跳动范围：±0.5% ✅
```

**观察要点**:
1. 记录30秒内THD的最大值和最小值
2. 计算跳动范围：(max - min) / 2
3. OSD显示应该"基本稳定"

**判定标准**:
- ✅ 完美：跳动<±1%
- ✅ 良好：跳动<±2%
- ⚠️ 可接受：跳动<±3%
- ❌ 失败：跳动≥±3%（无改善）

---

### 测试4: 频谱噪声降低 ⭐⭐

**信号源**: 1MHz方波，2Vpp

**预期改进**:
```
修复前（v10c）:
  低频区域（bin[0-100]）：噪声明显，多个虚假小峰 ❌
  
修复后（v11，8帧平均）:
  低频区域（bin[0-100]）：噪声降低69%，小峰减少 ✅
```

**观察要点**:
1. 观察频谱左侧1/4区域（0-4MHz）
2. 基波和奇次谐波之间应该较为"干净"
3. 偶次谐波位置（理论为0）噪声应很小

**判定标准**:
- ✅ 成功：噪声明显降低，频谱"干净"
- ⚠️ 部分改善：噪声有所降低，但仍可见
- ❌ 失败：噪声无明显改善

---

### 测试5: 动态阈值自适应 ⭐

**信号源**: 改变幅度，测试0.5Vpp、1Vpp、2Vpp、3Vpp

**预期行为**:
```
0.5Vpp（基波≈1600）:
  动态阈值 = 1600 >> 5 = 50（最小限制）
  
1Vpp（基波≈3200）:
  动态阈值 = 3200 >> 5 = 100
  
2Vpp（基波≈6400）:
  动态阈值 = 6400 >> 5 = 200
  
3Vpp（基波≈9600）:
  动态阈值 = 9600 >> 5 = 300
```

**观察要点**:
1. 各幅度下THD都能正常检测
2. 小幅度（0.5Vpp）不会误报噪声为谐波
3. 大幅度（3Vpp）不会漏掉真实谐波

**判定标准**:
- ✅ 成功：0.5-3Vpp全范围THD正常
- ❌ 失败：某些幅度THD异常或为0%

---

## 📊 **性能对比表**

| 测试项 | v10c | v11预期 | 改进 |
|--------|------|---------|------|
| **频谱显示** | | | |
| 1kHz峰值宽度 | 2-3像素 | 1像素 | 收窄2倍 |
| 左侧拉伸误差 | 0.8% | 0.1% | 降低8倍 |
| **THD测量** | | | |
| 20kHz THD | 0.0% | 40-48% | 从失败到成功 |
| 600kHz稳定性 | ±3% | ±0.5% | 稳定6倍 |
| 1MHz噪声 | 明显 | 降低69% | - |
| **响应速度** | | | |
| THD更新延迟 | 25ms | 200ms | -175ms ⚠️ |

---

## 🔧 **如果测试失败**

### 情况A: 频谱仍然拉伸

**可能原因**:
1. `addr_mult_107`计算时序问题（组合逻辑过长）
2. 寄存器赋值顺序问题

**解决方案**:
```verilog
// 改为流水线计算
reg [18:0] addr_mult_stage1;
reg [18:0] addr_mult_stage2;

always @(posedge clk_pixel) begin
    // Stage 1: 64h + 32h + 8h
    addr_mult_stage1 <= (h_offset<<6) + (h_offset<<5) + (h_offset<<3);
    
    // Stage 2: +2h + h
    addr_mult_stage2 <= addr_mult_stage1 + (h_offset<<1) + h_offset;
    
    spectrum_addr <= addr_mult_stage2[18:5];
end
```

---

### 情况B: THD仍为0%或很低

**可能原因**:
1. 8帧历史缓存未生效（初始化问题）
2. 动态阈值过高（过滤掉了真实谐波）

**调试步骤**:
```verilog
// 1. 检查历史缓存是否更新
// 添加调试输出：harm_history_index应该循环0-7

// 2. 检查动态阈值
// 添加显示：dynamic_noise_threshold应约为fft_avg_amp/32

// 3. 临时禁用阈值，直接输出平均值
fft_harmonic_2 <= harm2_amp_avg;  // 无阈值判断
```

---

### 情况C: THD跳动仍严重

**可能原因**:
1. 8帧平均不足，需要16帧
2. FFT本身不稳定（采样抖动）

**解决方案**:
```verilog
// 增加到16帧平均（延迟400ms）
reg [15:0] harm2_amp_history [0:15];  // 8→16
reg [3:0]  harm_history_index;        // 3位→4位

// 平均计算（分4组，避免溢出）
harm2_amp_avg <= ((harm2_amp_history[0:3]求和) +
                  (harm2_amp_history[4:7]求和) +
                  (harm2_amp_history[8:11]求和) +
                  (harm2_amp_history[12:15]求和)) >> 4;
```

---

### 情况D: 低频噪声仍严重

**可能原因**:
1. DC偏置去除不彻底
2. FFT窗函数问题（当前Rectangular窗）
3. ADC量化噪声

**高级解决方案**:
```verilog
// 方案1: 动态DC跟踪
reg [15:0] dc_avg;
always @(posedge clk) begin
    dc_avg <= dc_avg + ((adc_data - dc_avg) >> 4);  // IIR滤波
end

// 方案2: 尝试Flattop窗（如果噪声>谐波损失）
// 见：频谱显示拉伸问题诊断.md

// 方案3: 增加FFT后的频域滤波
if (spectrum_data < dynamic_noise_threshold)
    filtered_spectrum <= 16'd0;
else
    filtered_spectrum <= spectrum_data;
```

---

## 🎯 **成功标准总结**

### v11必须达到（3/5即可认为成功）:

1. ✅ 1kHz峰值宽度从3像素→1像素
2. ✅ 20kHz THD从0%→40%以上
3. ✅ 600kHz THD跳动从±3%→±1%以内
4. ✅ 频谱噪声明显降低
5. ⚠️ 响应延迟200ms可接受（8帧×25ms）

### 如果5项都失败:

说明基本方向错误，需要重新评估：
1. 是否使用Flattop窗替代Rectangular
2. 是否实施抛物线插值解决频率泄漏
3. 是否增加FFT点数（8192→16384）

---

## 📝 **测试记录模板**

```
测试日期：2025-11-05
固件版本：v11
测试人员：

【测试1：频谱显示】
信号：1kHz正弦波，2Vpp
峰值宽度：___ 像素（目标≤2）
结论：□通过 □失败

【测试2：20kHz THD】
信号：20kHz方波，2Vpp
THD读数：___% （目标40-48%）
结论：□通过 □失败

【测试3：600kHz稳定性】
信号：600kHz方波，2Vpp
THD范围：___% - ___% （目标±1%）
跳动：±___%
结论：□通过 □失败

【测试4：噪声降低】
信号：1MHz方波，2Vpp
噪声改善：□明显 □部分 □无
结论：□通过 □失败

【测试5：动态阈值】
0.5Vpp THD：___%
1.0Vpp THD：___%
2.0Vpp THD：___%
3.0Vpp THD：___%
结论：□通过 □失败

【总体评价】
通过项：___/5
v11是否成功：□是 □否
下一步建议：
```

---

**祝测试顺利！有问题随时反馈。** 🎯
