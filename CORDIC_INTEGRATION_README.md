# CORDIC算法集成说明文档

## 概述
本文档说明如何在FPGA智能信号分析系统中使用集成的CORDIC算法功能。CORDIC（COordinate Rotation DIgital Computer）算法已成功集成到`signal_analyzer_top.v`中，支持多种三角函数和双曲函数的实时计算。

## 功能特性

### 支持的CORDIC模式
1. **模式0 (禁用)**: CORDIC功能关闭
2. **模式1 (Sin/Cos)**: 正弦和余弦计算
   - 输入范围：-180° ~ +180°
   - 输出：sin(θ) 和 cos(θ)
   
3. **模式2 (Sinh/Cosh)**: 双曲正弦和双曲余弦计算
   - 输入范围：-1.13 ~ +1.13
   - 输出：sinh(x) 和 cosh(x)
   
4. **模式3 (Exp)**: 指数函数计算
   - 输入范围：-1.13 ~ +1.13
   - 输出：e^x
   
5. **模式4 (Ln)**: 自然对数计算
   - 输入范围：0.1 ~ 9.58
   - 输出：ln(x)
   
6. **模式5 (Arctanh)**: 反双曲正切计算
   - 输入范围：-1 ~ +1
   - 输出：arctanh(x)

## 硬件接口

### 按键控制
- **user_button[1]**: CORDIC模式切换按键（第2个按键）
  - 每次按下循环切换模式: 0→1→2→3→4→5→0
  - 配合按键消抖模块，确保稳定触发
  - 注：原为"启动"按键，因采用常开方式已不需要，重新分配为CORDIC控制

### 完整按键分配表
| 按键编号 | 功能 | 说明 |
|---------|------|------|
| user_button[0] | 工作模式切换 | 时域/频域/参数测量模式 |
| **user_button[1]** | **CORDIC模式切换** | **控制CORDIC计算模式** |
| user_button[2] | （保留/未使用） | 原停止按键，常开模式下已不需要 |
| user_button[3] | 通道1开关 | 开启/关闭通道1显示 |
| user_button[4] | 触发模式切换 | Auto/Normal触发模式 |
| user_button[5] | 自动测试 | 启动/停止自动测试功能 |
| user_button[6] | 通道2开关 | 开启/关闭通道2显示 |
| user_button[7] | 测试模式 | 内部测试信号发生器开关 |

### LED指示
- 系统LED可通过现有的LED控制逻辑反映CORDIC状态
- 建议通过UART输出查看详细的CORDIC模式和计算结果

## 数据流

### 输入数据源
CORDIC算法的输入数据来自ADC采集通道：
- 使用`selected_adc_data`（16位）作为原始输入
- 根据不同的CORDIC模式自动进行数据映射和转换
- ADC数据范围0-1023被映射到相应的CORDIC输入范围

### 数据转换映射
```
模式1 (Sin/Cos):   ADC[0-1023] → 角度[-180°, +180°]
模式2 (Sinh/Cosh): ADC[0-1023] → [-1.13, +1.13]
模式3 (Exp):       ADC[0-1023] → [-1.13, +1.13]
模式4 (Ln):        ADC[0-1023] → [0.1, 9.58]
模式5 (Arctanh):   ADC[0-1023] → [-1, +1]
```

### 输出数据
- **cordic_result_1**: 第一个计算结果（32位定点数，16位小数）
  - Sin/Cos模式: sin值
  - Sinh/Cosh模式: sinh值
  - Exp模式: e^x
  - Ln模式: ln(x)
  - Arctanh模式: arctanh(x)

- **cordic_result_2**: 第二个计算结果（32位定点数，16位小数）
  - Sin/Cos模式: cos值
  - Sinh/Cosh模式: cosh值
  - 其他模式: 0

## 流水线架构

### 时序特性
- **流水线级数**: 16级
- **额外延迟**: 2个时钟周期
- **总延迟**: 18个时钟周期（PIPELINE + 2）
- **工作时钟**: 100MHz (clk_100m)

### 时序对齐
- 使用`data_delay`模块对ADC数据进行延迟对齐
- 延迟级数设置为18，匹配CORDIC流水线总延迟
- 确保输入数据和计算结果时间同步

## UART输出格式

### 调试信息输出
系统每秒通过UART发送一次状态信息（115200波特率），包含CORDIC模式和计算结果：

```
===STATUS===
Mode:X Run:X CH1:X CH2:X Trig:X FIFO:XXXX FFT:XXX Test:X CORDIC:M R1:±XXXXXXXX R2:±XXXXXXXX
```

#### CORDIC字段说明
- **CORDIC:M**: 当前CORDIC模式
  - D = Disabled (禁用)
  - S = Sin/Cos (正弦/余弦)
  - H = Sinh/Cosh (双曲正弦/余弦)
  - E = Exp (指数)
  - L = Ln (自然对数)
  - A = Arctanh (反双曲正切)

- **R1:±XXXXXXXX**: 第一个结果（8位十六进制）
  - ± 表示符号（+/-）
  - XXXXXXXX 为32位定点数的十六进制表示

- **R2:±XXXXXXXX**: 第二个结果（8位十六进制）
  - 仅在Sin/Cos和Sinh/Cosh模式下有效

### 示例输出
```
===STATUS===
Mode:F Run:1 CH1:1 CH2:0 Trig:0 FIFO:1024 FFT:512 Test:0 CORDIC:S R1:+00009C40 R2:+0000FB14
```
解读：
- CORDIC模式为Sin/Cos (S)
- R1 = 0x00009C40 (约0.6，sin值)
- R2 = 0x0000FB14 (约0.98，cos值)

## 定点数格式

所有CORDIC计算使用32位定点数表示，其中：
- **整数位**: 16位 (bit[31:16])
- **小数位**: 16位 (bit[15:0])
- **数值范围**: -32768.0 ~ +32767.9999

### 定点数转换
要将CORDIC输出转换为浮点数：
```
实际值 = (signed_int32) / 65536.0
```

例如：
- 0x00010000 = 1.0
- 0x00008000 = 0.5
- 0xFFFF0000 = -1.0

## 集成的模块文件

以下CORDIC相关文件已复制到项目中：
1. `cordic_sin_cos.v` - 正弦/余弦计算模块
2. `cordic_sinh_cosh.v` - 双曲正弦/余弦计算模块
3. `cordic_exp.v` - 指数函数计算模块
4. `cordic_In.v` - 自然对数计算模块
5. `cordic_arctanh.v` - 反双曲正切计算模块
6. `data_delay.v` - 数据延迟对齐模块

## 使用示例

### 示例1: 计算正弦和余弦
1. 按下`user_button[1]`（第2个按键）切换到模式1 (Sin/Cos)
2. 调节输入信号（ADC输入）
3. ADC值512对应0°，0对应-180°，1023对应+180°
4. 通过UART查看实时计算结果

### 示例2: 计算指数函数
1. 按下`user_button[1]`多次，切换到模式3 (Exp)
2. ADC值512对应e^0 = 1.0
3. ADC值小于512计算e^(-x)，大于512计算e^(+x)
4. 结果通过UART以十六进制格式输出

## 性能指标

- **计算精度**: 约15-16位有效精度（受限于16级流水线迭代）
- **吞吐率**: 最高100MHz（每时钟周期接受一个新输入）
- **延迟**: 18个时钟周期（180ns @ 100MHz）
- **资源占用**: 
  - 每个CORDIC模块约占用200-300个LUT
  - 5个CORDIC模块共占用约1000-1500个LUT

## 注意事项

1. **输入范围检查**: 确保输入数据在各模式的有效范围内，超出范围可能导致计算结果不准确

2. **定点溢出**: 虽然CORDIC算法内部有增益补偿，但极端输入仍可能导致溢出

3. **模式切换**: 切换CORDIC模式时，当前计算会被中断，新模式从下一个有效输入开始

4. **与原功能兼容**: CORDIC功能作为附加功能，不影响原有的信号分析、FFT、参数测量等功能

5. **时钟域**: 所有CORDIC模块工作在100MHz时钟域，与主系统同步

## 故障排除

### 问题1: UART无CORDIC输出
- 检查按键是否正确连接到`user_button[1]`（第2个按键）
- 确认CORDIC模式已切换到非0模式
- 验证UART波特率为115200

### 问题2: 计算结果异常
- 检查ADC输入数据范围
- 确认CORDIC模式与预期一致
- 验证定点数格式解析正确

### 问题3: 系统资源不足
- 可选择性注释掉不需要的CORDIC模式模块实例
- 减少流水线级数（修改PIPELINE参数，但会降低精度）

## 扩展建议

1. **HDMI显示集成**: 将CORDIC结果显示到HDMI屏幕上（需修改`hdmi_display_ctrl.v`）

2. **查找表对比**: 添加LUT（查找表）方法与CORDIC结果对比，验证精度

3. **自动测试**: 集成到自动测试模块，对CORDIC各模式进行批量测试

4. **参数可配**: 添加寄存器接口，允许运行时配置CORDIC流水线级数

## 版本历史

- **v1.0 (2025-10-26)**: 初始集成版本
  - 支持5种CORDIC计算模式
  - UART调试输出
  - 按键模式切换
  - 与原系统完全兼容

## 作者与许可

- **集成作者**: AI Assistant
- **原CORDIC模块**: cordic_fpga-main项目
- **顶层系统**: signal_analyzer_top.v (DrSkyFire)
- **日期**: 2025年10月26日

---

**欢迎反馈和改进建议！**
