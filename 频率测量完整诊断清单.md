# é¢‘ç‡æµ‹é‡æ¨¡å—å®Œæ•´è¯Šæ–­æ¸…å•

**è¯Šæ–­æ—¥æœŸ**: 2025-11-04  
**è¯Šæ–­æ¨¡å—**: `signal_parameter_measure.v` å’Œ `hdmi_display_ctrl.v`  

---

## å·²ä¿®å¤çš„å…³é”®Bug âœ…

### Bug #1: kHzæ¨¡å¼é¢‘ç‡è®¡ç®—é”™è¯¯
- **ä¸¥é‡æ€§**: ğŸ”´ é«˜ï¼ˆå¯¼è‡´100kHz+ä¿¡å·æ˜¾ç¤ºé”™è¯¯ï¼‰
- **ä½ç½®**: `signal_parameter_measure.v` ç¬¬406-450è¡Œ
- **çŠ¶æ€**: âœ… å·²ä¿®å¤
- **è¯¦æƒ…**: è§ã€Šé¢‘ç‡æ˜¾ç¤ºBugä¿®å¤æŠ¥å‘Š.mdã€‹

---

## å‘ç°çš„å…¶ä»–é—®é¢˜

### é—®é¢˜ #1: FFTé¢‘ç‡æµ‹é‡è¢«ç¦ç”¨ âš ï¸

**ä½ç½®**: `signal_parameter_measure.v` ç¬¬1360-1369è¡Œ

**ä»£ç çŠ¶æ€**:
```verilog
// FFTæµ‹é‡æš‚æ—¶æ³¨é‡Šæ‰ç”¨äºè¯Šæ–­
// if (use_fft_freq && fft_freq_ready) begin
//     if (fft_freq_hz >= 32'd100000) begin
//         freq_is_khz <= 1'b1;
//         freq_out <= (fft_freq_hz / 32'd100);
//     end else begin
//         freq_is_khz <= 1'b0;
//         freq_out <= fft_freq_hz[15:0];
//     end
//     amplitude_out <= fft_max_amp;
// end
```

**å½±å“åˆ†æ**:
- âŒ å½“å‰ä»…ä½¿ç”¨**æ—¶åŸŸè¿‡é›¶æ£€æµ‹**æµ‹é‡é¢‘ç‡
- âŒ æ—¶åŸŸæµ‹é‡ç²¾åº¦ï¼šçº¦1%ï¼ˆå—å™ªå£°ã€ä¿¡å·è´¨é‡å½±å“ï¼‰
- âŒ æ— æ³•è¾¾åˆ°èµ›é¢˜è¦æ±‚çš„<0.1%ç²¾åº¦

**FFTæµ‹é‡ä¼˜åŠ¿**:
- âœ… ç²¾åº¦ï¼š<0.1%ï¼ˆé¢‘ç‡åˆ†è¾¨ç‡4272Hzï¼Œæ’å€¼åæ›´é«˜ï¼‰
- âœ… æŠ—å™ªå£°èƒ½åŠ›å¼ºï¼ˆé¢‘åŸŸæ»¤æ³¢ï¼‰
- âœ… åŒæ—¶è·å¾—å¹…åº¦å’ŒTHDä¿¡æ¯

**å»ºè®®**:
1. **ç«‹å³å¯ç”¨FFTæµ‹é‡**ï¼ˆè§£é™¤æ³¨é‡Šï¼‰
2. ä¿®å¤FFTä¸­çš„é™¤æ³•é—®é¢˜ï¼ˆè§é—®é¢˜#2ï¼‰
3. æ·»åŠ è‡ªé€‚åº”æ¨¡å¼åˆ‡æ¢ï¼š
   - é«˜é¢‘(>10kHz): ä½¿ç”¨FFTï¼ˆç²¾åº¦ä¼˜å…ˆï¼‰
   - ä½é¢‘(<10kHz): ä½¿ç”¨è¿‡é›¶ï¼ˆé¿å…FFTé¢‘ç‡åˆ†è¾¨ç‡ä¸è¶³ï¼‰

---

### é—®é¢˜ #2: FFTè¾“å‡ºä¸­çš„é™¤æ³•è¿ç®— âš ï¸

**ä½ç½®**: `signal_parameter_measure.v` ç¬¬1361è¡Œï¼ˆè¢«æ³¨é‡Šï¼‰

**é—®é¢˜ä»£ç **:
```verilog
freq_out <= (fft_freq_hz / 32'd100);
```

**é—®é¢˜**:
- ä½¿ç”¨é™¤æ³•è¿ç®—ç¬¦ `/` ä¼šç»¼åˆæˆé™¤æ³•å™¨
- é™¤æ³•å™¨èµ„æºæ¶ˆè€—å¤§ã€å»¶è¿Ÿé«˜ï¼ˆå¯èƒ½>10nsï¼‰
- ä¸å…¶ä»–LUTé™¤æ³•è®¾è®¡ä¸ä¸€è‡´

**ä¿®å¤å»ºè®®**:
```verilog
// æ›¿æ¢ä¸ºå®šç‚¹ä¹˜æ³•è¿‘ä¼¼
// fft_freq_hz / 100 â‰ˆ (fft_freq_hz * 655) >> 16
if (fft_freq_hz >= 32'd100000) begin
    freq_is_khz <= 1'b1;
    freq_out <= (fft_freq_hz * 32'd655) >> 16;  // Ã·100
end else begin
    freq_is_khz <= 1'b0;
    freq_out <= fft_freq_hz[15:0];
end
```

---

### é—®é¢˜ #3: é¢‘ç‡åˆ†è¾¨ç‡å¸¸é‡å¯èƒ½ä¸å‡†ç¡® âš ï¸

**ä½ç½®**: `signal_parameter_measure.v` ç¬¬65è¡Œ

**å½“å‰ä»£ç **:
```verilog
localparam FREQ_RES = 4272;  // é¢‘ç‡åˆ†è¾¨ç‡ 35MHz/8192 â‰ˆ 4272 Hz/bin
```

**éªŒè¯**:
- é‡‡æ ·ç‡: 35MHz
- FFTç‚¹æ•°: 8192
- ç†è®ºåˆ†è¾¨ç‡: 35,000,000 / 8192 = 4272.46 Hz/bin âœ…

**çŠ¶æ€**: âœ… æ­£ç¡®ï¼ˆè¯¯å·®0.01%ï¼‰

---

### é—®é¢˜ #4: FFTå³°å€¼æœç´¢èµ·å§‹bin âš ï¸

**ä½ç½®**: `signal_parameter_measure.v` ç¬¬493è¡Œ

**å½“å‰ä»£ç **:
```verilog
// ã€å…³é”®ä¿®å¤ã€‘å³°å€¼æœç´¢ä»bin 1å¼€å§‹ï¼ˆä¸è·³è¿‡ä½é¢‘ï¼‰
// 1kHzåœ¨bin 0.234ï¼Œå¿…é¡»ä»bin 1å¼€å§‹æ‰èƒ½æ£€æµ‹åˆ°
else if (fft_scan_active && spectrum_addr >= 13'd1 && spectrum_addr < (FFT_POINTS/2)) begin
```

**æ½œåœ¨é—®é¢˜**:
- 1kHzä¿¡å·åœ¨bin â‰ˆ 0.234ï¼ˆä¸åˆ°1ä¸ªbinï¼‰
- ä»bin 1å¼€å§‹ï¼Œå¯èƒ½æ¼æ£€<4.27kHzçš„ä¿¡å·

**éªŒè¯è®¡ç®—**:
- 1kHz: bin = 1000 / 4272 â‰ˆ 0.234
- 4kHz: bin = 4000 / 4272 â‰ˆ 0.936
- 5kHz: bin = 5000 / 4272 â‰ˆ 1.17 âœ…

**å»ºè®®**:
- å¦‚æœéœ€è¦æµ‹é‡<5kHzä¿¡å·ï¼Œåº”ä»bin 0å¼€å§‹
- ä½†bin 0æ˜¯DCåˆ†é‡ï¼Œå¯èƒ½å¼•å…¥è¯¯å·®
- **æŠ˜ä¸­æ–¹æ¡ˆ**: ä»bin 1å¼€å§‹ï¼Œä½äº5kHzç”¨æ—¶åŸŸè¿‡é›¶

---

### é—®é¢˜ #5: è¿‡é›¶æ£€æµ‹çŠ¶æ€æœºé‡ç½®æ—¶æœº âš ï¸

**ä½ç½®**: `signal_parameter_measure.v` ç¬¬272-290è¡Œ

**å½“å‰é€»è¾‘**:
```verilog
if (measure_done) begin  // ã€ä¿®å¤ã€‘æµ‹é‡å‘¨æœŸç»“æŸæ—¶é‡ç½®çŠ¶æ€
    zero_cross <= 1'b0;
    zero_cross_state <= 1'b0;  // æ¸…é™¤çŠ¶æ€ï¼Œå‡†å¤‡ä¸‹ä¸€å‘¨æœŸ
end
```

**æ½œåœ¨é—®é¢˜**:
- `measure_done` åªæ˜¯1ä¸ªæ—¶é’Ÿå‘¨æœŸçš„è„‰å†²
- å¦‚æœä¿¡å·æ­£å¥½å¤„äºé«˜ç”µå¹³ï¼Œä¸‹ä¸€å‘¨æœŸå¼€å§‹æ—¶ `zero_cross_state` è¢«æ¸…é›¶
- å¯èƒ½å¯¼è‡´ç¬¬ä¸€ä¸ªè¿‡é›¶æ£€æµ‹å»¶è¿Ÿ

**å»ºè®®**:
- ä¿æŒå½“å‰é€»è¾‘ï¼ˆå·²ç»æ˜¯æœ€ä¼˜æ–¹æ¡ˆï¼‰
- æˆ–è€…ï¼šåœ¨æµ‹é‡å‘¨æœŸç»“æŸæ—¶**ä¸æ¸…é›¶**ï¼Œä¿æŒçŠ¶æ€è¿ç»­æ€§
  - ä¼˜ç‚¹ï¼šæ— ä¸¢å¤±è¿‡é›¶
  - ç¼ºç‚¹ï¼šé•¿å‘¨æœŸå¯èƒ½ç´¯ç§¯è¯¯å·®

**æµ‹è¯•éªŒè¯**: éœ€è¦å®æµ‹å¯¹æ¯”ä¸¤ç§æ–¹æ¡ˆçš„ç²¾åº¦å·®å¼‚

---

### é—®é¢˜ #6: è‡ªé€‚åº”é˜ˆå€¼æ›´æ–°ç­–ç•¥ âš ï¸

**ä½ç½®**: `signal_parameter_measure.v` ç¬¬827-860è¡Œ

**å½“å‰ç­–ç•¥**:
```verilog
if (time_cnt == TIME_100MS - 2) begin
    // å‘¨æœŸå³å°†ç»“æŸæ—¶æ›´æ–°é˜ˆå€¼ï¼ˆä½¿ç”¨å®Œæ•´çš„max/minæ•°æ®ï¼‰
    adaptive_threshold <= (max_val + min_val) >> 1;
    ...
end else if (sample_valid_sync) begin
    // å®æ—¶å¾®è°ƒé˜ˆå€¼ï¼ˆåŸºäºå½“å‰max/minï¼‰
    adaptive_threshold <= (max_val + min_val) >> 1;
    ...
end
```

**é—®é¢˜**:
- æ¯æ¬¡é‡‡æ ·éƒ½æ›´æ–°é˜ˆå€¼ï¼ˆ35MHzé‡‡æ ·ç‡ï¼‰
- é«˜é¢‘ç‡æ›´æ–°å¯èƒ½å¯¼è‡´é˜ˆå€¼æŠ–åŠ¨
- å½±å“è¿‡é›¶æ£€æµ‹ç¨³å®šæ€§

**å»ºè®®**:
- ä»…åœ¨å‘¨æœŸç»“æŸæ—¶æ›´æ–°ï¼ˆå·²æœ‰çš„ç¬¬ä¸€ä¸ªifåˆ†æ”¯ï¼‰
- åˆ é™¤å®æ—¶å¾®è°ƒé€»è¾‘ï¼ˆç¬¬äºŒä¸ªelse ifï¼‰
- æˆ–è€…ï¼šé™ä½æ›´æ–°é¢‘ç‡ï¼ˆå¦‚æ¯1000æ¬¡é‡‡æ ·æ›´æ–°ä¸€æ¬¡ï¼‰

**ä¿®å¤ä»£ç **:
```verilog
if (time_cnt == TIME_100MS - 2) begin
    // å‘¨æœŸå³å°†ç»“æŸæ—¶æ›´æ–°é˜ˆå€¼
    adaptive_threshold <= (max_val + min_val) >> 1;
    if ((max_val - min_val) > 10'd256)
        threshold_hysteresis <= (max_val - min_val) >> 5;
    else
        threshold_hysteresis <= 10'd8;
    
    // è®¡ç®—è¿Ÿæ»ä¸Šä¸‹é™ï¼ˆç§»åˆ°æ­¤å¤„ï¼Œæ¯å‘¨æœŸæ›´æ–°ä¸€æ¬¡ï¼‰
    if (adaptive_threshold + threshold_hysteresis > 10'd1023)
        threshold_hyst_high <= 10'd1023;
    else
        threshold_hyst_high <= adaptive_threshold + threshold_hysteresis;
        
    if (adaptive_threshold < threshold_hysteresis)
        threshold_hyst_low <= 10'd0;
    else
        threshold_hyst_low <= adaptive_threshold - threshold_hysteresis;
end
// åˆ é™¤å®æ—¶å¾®è°ƒéƒ¨åˆ†
```

---

### é—®é¢˜ #7: æ»‘åŠ¨å¹³å‡æ»¤æ³¢å™¨çª—å£å¤§å° â„¹ï¸

**ä½ç½®**: `signal_parameter_measure.v` ç¬¬455-466è¡Œ

**å½“å‰é…ç½®**:
- é¢‘ç‡ï¼š4æ¬¡å¹³å‡
- å¹…åº¦ï¼š4æ¬¡å¹³å‡
- å ç©ºæ¯”ï¼š8æ¬¡å¹³å‡

**åˆ†æ**:
- æ›´æ–°ç‡ï¼š10Hzï¼ˆ100msæµ‹é‡å‘¨æœŸï¼‰
- 4æ¬¡å¹³å‡å»¶è¿Ÿï¼š400ms
- 8æ¬¡å¹³å‡å»¶è¿Ÿï¼š800ms

**æƒè¡¡**:
- âœ… ä¼˜ç‚¹ï¼šæ»¤æ³¢æ•ˆæœå¥½ï¼Œæ˜¾ç¤ºç¨³å®š
- âŒ ç¼ºç‚¹ï¼šå“åº”æ…¢ï¼Œä¸é€‚åˆå¿«é€Ÿå˜åŒ–çš„ä¿¡å·

**å»ºè®®**:
- ä¿æŒå½“å‰é…ç½®ï¼ˆé’ˆå¯¹ç¨³æ€æµ‹é‡ä¼˜åŒ–ï¼‰
- æˆ–è€…ï¼šæ·»åŠ è‡ªé€‚åº”æ»¤æ³¢å™¨
  - ä¿¡å·ç¨³å®šæ—¶ï¼š8æ¬¡å¹³å‡ï¼ˆå¹³æ»‘ä¼˜å…ˆï¼‰
  - ä¿¡å·å˜åŒ–æ—¶ï¼š2æ¬¡å¹³å‡ï¼ˆå“åº”ä¼˜å…ˆï¼‰

---

### é—®é¢˜ #8: HDMIæ˜¾ç¤ºçš„é™¤æ³•è¿ç®— âš ï¸

**ä½ç½®**: `hdmi_display_ctrl.v` ç¬¬463ã€468è¡Œ

**é—®é¢˜ä»£ç **:
```verilog
ch1_freq_display <= ch1_freq / 16'd1000;  // é™¤æ³•1
...
ch1_freq_d1 <= (ch1_freq_display / 5'd10) % 4'd10;  // é™¤æ³•2
ch1_freq_d2 <= (ch1_freq_display / 7'd100) % 4'd10;  // é™¤æ³•3
...
```

**é—®é¢˜**:
- å¤šå¤„ä½¿ç”¨é™¤æ³•å’Œå–æ¨¡è¿ç®—
- åœ¨74.25MHzåƒç´ æ—¶é’Ÿä¸‹æ‰§è¡Œï¼Œæ—¶åºå‹åŠ›å¤§
- å¯èƒ½å¯¼è‡´æ—¶åºè¿ä¾‹

**å½“å‰ç¼“è§£æªæ–½**:
- åœ¨åœºæ¶ˆéšæœŸé—´æ›´æ–°ï¼ˆv_cnt==0ï¼‰
- åˆ†æ•£åˆ°å¤šä¸ªæ—¶é’Ÿå‘¨æœŸï¼ˆh_cnt=10,15,20...ï¼‰

**çŠ¶æ€**: âš ï¸ éœ€è¦å…³æ³¨æ—¶åºæŠ¥å‘Š
- å¦‚æœå‡ºç°æ—¶åºè¿ä¾‹ï¼Œè€ƒè™‘ï¼š
  1. é¢„è®¡ç®—BCDè½¬æ¢è¡¨ï¼ˆLUTï¼‰
  2. å¢åŠ æµæ°´çº¿çº§æ•°
  3. é™ä½åƒç´ æ—¶é’Ÿé¢‘ç‡

---

## ä»£ç ä¸€è‡´æ€§æ£€æŸ¥

### âœ… è·¨æ—¶é’ŸåŸŸåŒæ­¥
- é‡‡æ ·æ—¶é’Ÿ(35MHz) â†’ ç³»ç»Ÿæ—¶é’Ÿ(100MHz): âœ… å·²åŒæ­¥
- ä½¿ç”¨è¾¹æ²¿æ£€æµ‹+åŒçº§å¯„å­˜å™¨: âœ… æ­£ç¡®
- æ•°æ®é”å­˜ç­–ç•¥: âœ… åˆç†

### âœ… æµæ°´çº¿å¯¹é½
- é¢‘ç‡è®¡ç®—ï¼š4çº§æµæ°´çº¿ âœ…
- å¹…åº¦è®¡ç®—ï¼š3çº§æµæ°´çº¿ âœ…
- å ç©ºæ¯”è®¡ç®—ï¼š3çº§æµæ°´çº¿ âœ…
- THDè®¡ç®—ï¼š3çº§æµæ°´çº¿ âœ…

### âœ… èµ„æºä¼˜åŒ–
- ä½¿ç”¨LUTä»£æ›¿é™¤æ³•å™¨ âœ…
- é¿å…å¤§ä¹˜æ³•å™¨ï¼ˆåˆ†è§£ä¸ºç§»ä½+åŠ æ³•ï¼‰âœ…
- BRAMä½¿ç”¨åˆç†ï¼ˆFFT IPæ ¸ï¼‰âœ…

---

## ä¼˜å…ˆçº§æ’åº

### P0 - ç«‹å³ä¿®å¤
1. âœ… **Bug #1: kHzæ¨¡å¼è®¡ç®—é”™è¯¯** - å·²ä¿®å¤

### P1 - é«˜ä¼˜å…ˆçº§ï¼ˆå½±å“æ€§èƒ½ï¼‰
1. âš ï¸ **é—®é¢˜ #1: å¯ç”¨FFTæµ‹é‡** - æé«˜ç²¾åº¦åˆ°<0.1%
2. âš ï¸ **é—®é¢˜ #2: FFTé™¤æ³•ä¼˜åŒ–** - é¿å…æ—¶åºé—®é¢˜

### P2 - ä¸­ä¼˜å…ˆçº§ï¼ˆä¼˜åŒ–ä½“éªŒï¼‰
1. âš ï¸ **é—®é¢˜ #6: é˜ˆå€¼æ›´æ–°ç­–ç•¥** - æé«˜ç¨³å®šæ€§
2. âš ï¸ **é—®é¢˜ #8: HDMIé™¤æ³•è¿ç®—** - å…³æ³¨æ—¶åº

### P3 - ä½ä¼˜å…ˆçº§ï¼ˆåŠŸèƒ½å®Œå–„ï¼‰
1. â„¹ï¸ **é—®é¢˜ #4: FFTèµ·å§‹bin** - æä½é¢‘æµ‹é‡
2. â„¹ï¸ **é—®é¢˜ #7: è‡ªé€‚åº”æ»¤æ³¢** - å¿«é€Ÿå“åº”

### P4 - è§‚å¯Ÿï¼ˆéœ€è¦å®æµ‹éªŒè¯ï¼‰
1. â„¹ï¸ **é—®é¢˜ #5: çŠ¶æ€æœºé‡ç½®** - ç²¾åº¦å½±å“å¾…æµ‹

---

## æµ‹è¯•å»ºè®®

### å•å…ƒæµ‹è¯•
- [ ] é¢‘ç‡è®¡ç®—æµæ°´çº¿ï¼ˆ100Hz-10MHzï¼‰
- [ ] å•ä½åˆ‡æ¢é€»è¾‘ï¼ˆ99.9kHz vs 100.1kHzï¼‰
- [ ] æ»¤æ³¢å™¨å“åº”é€Ÿåº¦
- [ ] è·¨æ—¶é’ŸåŸŸæ•°æ®å®Œæ•´æ€§

### é›†æˆæµ‹è¯•
- [ ] HDMIæ˜¾ç¤ºåˆ·æ–°ç‡ï¼ˆ10Hzï¼‰
- [ ] å¤šé€šé“åŒæ­¥æ€§ï¼ˆCH1 vs CH2ï¼‰
- [ ] FFT vs æ—¶åŸŸæµ‹é‡å¯¹æ¯”
- [ ] æé™é¢‘ç‡æµ‹è¯•ï¼ˆ10Hz, 17.5MHzï¼‰

### å‹åŠ›æµ‹è¯•
- [ ] é•¿æ—¶é—´è¿è¡Œç¨³å®šæ€§ï¼ˆ24å°æ—¶ï¼‰
- [ ] é¢‘ç‡å¿«é€Ÿæ‰«æï¼ˆ1Hz/sï¼‰
- [ ] å¹…åº¦åŠ¨æ€èŒƒå›´ï¼ˆ10mV-3.3Vï¼‰
- [ ] å™ªå£°ä¿¡å·æµ‹è¯•ï¼ˆSNR<20dBï¼‰

---

## æ€»ç»“

### å·²å®Œæˆ
- âœ… ä¿®å¤kHzæ¨¡å¼æ ¸å¿ƒBugï¼ˆBug #1ï¼‰
- âœ… å®Œæˆä»£ç å®¡æŸ¥å’Œé—®é¢˜è¯Šæ–­
- âœ… ç”Ÿæˆè¯¦ç»†ä¿®å¤æŠ¥å‘Š

### å¾…å¤„ç†
- âš ï¸ å¯ç”¨FFTæµ‹é‡ï¼ˆæé«˜ç²¾åº¦ï¼‰
- âš ï¸ ä¼˜åŒ–é™¤æ³•è¿ç®—ï¼ˆFFTå’ŒHDMIï¼‰
- âš ï¸ è°ƒä¼˜æ»¤æ³¢å’Œé˜ˆå€¼ç­–ç•¥

### é£é™©æç¤º
- å½“å‰ä»…æ—¶åŸŸæµ‹é‡ï¼Œç²¾åº¦å¯èƒ½ä¸è¶³<0.1%
- HDMIæ˜¾ç¤ºé™¤æ³•å¯èƒ½æœ‰æ—¶åºé£é™©
- æ»¤æ³¢å™¨å“åº”è¾ƒæ…¢ï¼ˆ400-800msï¼‰

---

**è¯Šæ–­äººå‘˜**: AI Assistant  
**çŠ¶æ€**: å¾…éªŒè¯  
**ä¸‹ä¸€æ­¥**: ç¡¬ä»¶æµ‹è¯• + FFTå¯ç”¨
