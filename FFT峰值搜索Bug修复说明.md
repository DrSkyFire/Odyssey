# FFT峰值搜索Bug修复说明

## 🐛 发现的Bug

### Bug 1：FFT峰值搜索范围错误

**原代码**：
```verilog
// Line 398
else if (fft_scan_active && spectrum_addr >= 13'd10 && ...) begin
    if (spectrum_data > fft_max_amp) begin
        fft_max_amp <= spectrum_data;
        fft_peak_bin <= spectrum_addr;
    end
end
```

**问题分析**：
- 峰值搜索从 **bin 10** 开始
- 1kHz 信号对应 bin = 1000 / 4272 ≈ **0.234**
- **bin 0-9 完全被跳过！**
- 结果：检测到 bin 10-14 的噪声峰值（对应 40-60kHz）

**修复**：
```verilog
// 从 bin 1 开始（只跳过 DC 分量）
else if (fft_scan_active && spectrum_addr >= 13'd1 && ...) begin
```

---

### Bug 2：输出逻辑冲突

**原代码**：
```verilog
if (fft_freq_ready && use_fft_freq) begin
    freq_out <= fft_freq_hz[15:0];      // FFT数据
    amplitude_out <= fft_max_amp;
end else if (measure_done) begin
    freq_out <= freq_calc;              // 时域数据（每100ms覆盖）
    amplitude_out <= amplitude_calc;
end
```

**问题**：
- `measure_done` 是 100ms 的周期脉冲
- 即使 FFT 数据有效，每 100ms 也会被时域数据覆盖
- 导致显示在 FFT 和时域数据之间快速切换

**修复**：
```verilog
if (measure_done) begin
    // 每100ms更新一次
    if (use_fft_freq && fft_freq_ready) begin
        // 优先使用FFT数据
        freq_out <= fft_freq_hz[15:0];
        amplitude_out <= fft_max_amp;
    end else begin
        // 回退到时域数据
        freq_out <= freq_calc;
        amplitude_out <= amplitude_calc;
    end
end
```

---

## 📊 实测数据分析

### 修复前的测试结果（1kHz 正弦波）

| 参数 | 实测值 | 异常分析 |
|------|--------|----------|
| **频率** | 40000-60000 Hz 跳动 | bin 10-14 的噪声峰值 |
| **幅度** | 36-40 mV | 时域峰峰值（错误） |
| **THD** | 19% / 0% 跳动 | FFT谐波检测不稳定 |
| **占空比** | 20.6% | 自适应阈值算法bug |

### 数据验证计算

**FFT bin 频率对照表**（采样率 35MHz，8192点FFT）：
```
频率分辨率 = 35,000,000 / 8192 = 4272 Hz/bin

bin 0:   0 Hz (DC)
bin 1:   4272 Hz
bin 10:  42720 Hz  ← 原代码搜索起点
bin 14:  59808 Hz
bin 0.234: 1000 Hz  ← 1kHz应该在这里（被跳过）
```

**实测频率 40-60kHz 对应**：
- 40000 / 4272 ≈ bin 9.4
- 60000 / 4272 ≈ bin 14

**结论**：系统检测到了 bin 10-14 范围内的噪声峰值！

---

## 🎯 修复后预期

### 频率测量

| 输入频率 | 修复前 | 修复后预期 |
|---------|--------|-----------|
| 100 Hz | 42720-59808 Hz | 90-110 Hz |
| 1 kHz | 40000-60000 Hz | 996-1004 Hz |
| 10 kHz | 40000-60000 Hz | 9.96-10.04 kHz |
| 100 kHz | 正常 | 99.6-100.4 kHz |

**原理**：
- 100 Hz → bin 0.023 ✅ 现在会检测到
- 1 kHz → bin 0.234 ✅ 现在会检测到
- 10 kHz → bin 2.34 ✅ 现在会检测到

---

### 幅度测量

| 输入幅度 | 修复前 | 修复后预期 |
|---------|--------|-----------|
| 1.0 Vpp | 36-40 mV | 900-1100 mV |
| 100 mVpp | 40 mV | 90-110 mV |

**原理**：
- FFT 基波幅度正确反映信号能量
- 时域峰峰值受噪声影响大

---

### THD测量

| 信号类型 | 修复前 | 修复后预期 |
|---------|--------|-----------|
| 纯正弦波 | 19%/0% 跳动 | <5% 稳定 |
| 方波 | 19%/0% 跳动 | >30% 稳定 |

**原理**：
- 基波频率正确后，谐波检测才能工作
- 2次谐波 = 基波bin × 2
- 如果基波bin错误，谐波检测也错误

---

## 🔧 测试验证步骤

### 1. 重新编译下载（5分钟）
```
综合 → 布局布线 → 生成比特流 → 下载
```

### 2. 标准测试（1kHz 正弦波 1Vpp）

**期望结果**：
```
频率显示：996-1004 Hz  ✅ 稳定
幅度显示：900-1100 mV  ✅ 稳定
THD显示：<5%           ✅ 稳定
占空比显示：48-52%     ✅ 稳定（如果自适应阈值正常）
```

### 3. 低频测试（100Hz 正弦波）

**期望结果**：
```
频率显示：90-110 Hz    ✅ 修复前是 46992 Hz
```

### 4. 多频率测试

| 频率 | 期望显示 | 实测 | 状态 |
|------|---------|------|------|
| 100 Hz | 90-110 Hz | _____ | □ |
| 1 kHz | 996-1004 Hz | _____ | □ |
| 10 kHz | 9.96-10.04 kHz | _____ | □ |
| 100 kHz | 99.6-100.4 kHz | _____ | □ |
| 1 MHz | 0.996-1.004 MHz | _____ | □ |

---

## 🚨 已知剩余问题

### 占空比测量偏低（20.6% vs 期望50%）

**可能原因**：
1. 自适应阈值算法计算错误
2. 迟滞比较器参数不当
3. 时域采样同步问题

**需要进一步诊断**：
- 检查 `adaptive_threshold` 计算逻辑
- 检查 `hysteresis_high/low` 的计算
- 可能需要调整阈值系数

---

## 📈 性能提升预期

| 指标 | Bug修复前 | Bug修复后 | 提升 |
|------|----------|----------|------|
| 低频精度 | 470倍误差 | <1% | **470倍** |
| 中频精度 | 4-5倍误差 | <0.5% | **8-10倍** |
| 幅度精度 | 96%误差 | <10% | **10倍** |
| 测量稳定性 | 快速跳动 | 稳定 | **质变** |

---

**请重新编译下载，测试 1kHz 信号，并报告结果！**
