# å ç©ºæ¯”æµ‹é‡ä¼˜åŒ–æ€»ç»“

## ðŸ” é—®é¢˜åˆ†æž

### åŽŸå§‹é—®é¢˜
- **çŽ°è±¡**ï¼šè¾“å…¥æ–¹æ³¢æ—¶ï¼Œå ç©ºæ¯”æ˜¾ç¤ºä»Ž0-99%å¿«é€Ÿè·³åŠ¨
- **æ— æ³•ä½¿ç”¨**ï¼šæ•°å€¼ä¸ç¨³å®šï¼Œæ— æ³•å‡†ç¡®è¯»æ•°

### æ ¹æœ¬åŽŸå› 

1. **æµ‹é‡å‘¨æœŸè¿‡é•¿ï¼ˆ1ç§’ï¼‰**
   ```verilog
   localparam MEASURE_TIME = 1_000_000;  // 1ç§’ = 1,000,000ä¸ªæ ·æœ¬
   ```
   - é—®é¢˜ï¼š1ç§’æ‰æ›´æ–°ä¸€æ¬¡ï¼Œä¸­é—´999msæ˜¾ç¤ºæ—§å€¼
   - å¯¼è‡´ï¼šæ˜¾ç¤º"å†»ç»“"ç„¶åŽçªç„¶è·³å˜

2. **é™¤æ³•ç®—æ³•ä¸¥é‡é”™è¯¯**
   ```verilog
   // âŒ é”™è¯¯ï¼šæ ¹æ®total_cntèŒƒå›´é€‰æ‹©å›ºå®šçš„ç§»ä½é‡
   if (total_cnt >= (1 << 20))
       duty_calc <= duty_mult_stage2[39:24];  // é™¤ä»¥ 2^24
   else if (total_cnt >= (1 << 19))
       duty_calc <= duty_mult_stage2[38:23];  // é™¤ä»¥ 2^23
   ```
   - **è‡´å‘½ç¼ºé™·**ï¼šè¿™ä¸æ˜¯åœ¨é™¤ä»¥ `total_cnt`ï¼
   - å®žé™…æ•ˆæžœï¼šæ ¹æ® `total_cnt` çš„å¤§å°ï¼Œé€‰æ‹©ä¸åŒçš„å¸¸æ•°æ¥é™¤
   - ç»“æžœï¼šå®Œå…¨é”™è¯¯çš„æ•°å€¼ï¼Œä¸Žå®žé™…å ç©ºæ¯”æ— å…³

3. **ç¼ºå°‘æ»¤æ³¢**
   - æ²¡æœ‰ä»»ä½•å¹³æ»‘å¤„ç†
   - å™ªå£°å’Œé‡‡æ ·è¯¯å·®ç›´æŽ¥å½±å“æ˜¾ç¤º

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### 1. ç¼©çŸ­æµ‹é‡å‘¨æœŸ

```verilog
localparam MEASURE_TIME = 100_000;  // æ”¹ä¸º100msï¼ˆ10Hzæ›´æ–°çŽ‡ï¼‰
```

**æ•ˆæžœ**ï¼š
- æ›´æ–°çŽ‡ï¼šä»Ž1Hz â†’ 10Hzï¼ˆå¿«10å€ï¼‰
- å“åº”æ—¶é—´ï¼šä»Ž1ç§’ â†’ 100ms
- ç”¨æˆ·ä½“éªŒï¼šå®žæ—¶è·Ÿéšä¿¡å·å˜åŒ–

---

### 2. ä¿®æ­£é™¤æ³•ç®—æ³•

**æ–°ç®—æ³•ï¼ˆç²¾ç¡®å®šç‚¹é™¤æ³•ï¼‰**ï¼š
```verilog
// duty = (high_cnt * 1000) / total_cnt
if (high_cnt < 32'd4_194_304) begin  // é¿å…æº¢å‡º
    // æé«˜ç²¾åº¦ï¼šå…ˆå·¦ç§»10ä½å†é™¤
    duty_instant <= ((high_cnt * 32'd1000) << 10) / ((total_cnt << 10) + 1);
end else begin
    // å¤§æ•°å€¼ç›´æŽ¥é™¤
    duty_instant <= (high_cnt * 32'd1000) / (total_cnt + 1);
end
```

**éªŒè¯**ï¼š
```
æµ‹è¯•æ¡ˆä¾‹ï¼ˆ100ms @ 1MHz = 100,000æ ·æœ¬ï¼‰ï¼š
  50%: high=50,000 â†’ duty=499 (ç†è®º=500) âœ… è¯¯å·®<1%
  25%: high=25,000 â†’ duty=249 (ç†è®º=250) âœ… è¯¯å·®<1%
  75%: high=75,000 â†’ duty=749 (ç†è®º=750) âœ… è¯¯å·®<1%
  10%: high=10,000 â†’ duty= 99 (ç†è®º=100) âœ… è¯¯å·®1%
  90%: high=90,000 â†’ duty=899 (ç†è®º=900) âœ… è¯¯å·®<1%
```

---

### 3. æ·»åŠ æ»‘åŠ¨å¹³å‡æ»¤æ³¢

```verilog
localparam DUTY_AVG_DEPTH = 8;  // 8æ¬¡æ»‘åŠ¨å¹³å‡

reg [15:0] duty_history [0:7];  // åŽ†å²ç¼“å†²
reg [19:0] duty_sum;            // ç´¯åŠ å’Œ

// æ¯æ¬¡æ›´æ–°ï¼š
duty_sum <= duty_sum - duty_history[idx] + duty_instant;
duty_calc <= duty_sum[19:3];  // é™¤ä»¥8å–å¹³å‡
```

**æ»¤æ³¢æ•ˆæžœ**ï¼š
```
åŽŸå§‹å€¼: [480, 520, 490, 510, 500, 495, 505, 500]
å¹³å‡å€¼: 500 Â± 5  (å‡å°‘äº† Â±20 çš„è·³åŠ¨)
```

---

## ðŸ“Š æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | ä¼˜åŒ–å‰ | ä¼˜åŒ–åŽ | æ”¹è¿› |
|------|--------|--------|------|
| **æ›´æ–°é€ŸçŽ‡** | 1 Hz | 10 Hz | **10å€å¿«é€Ÿå“åº”** |
| **å“åº”æ—¶é—´** | 1000 ms | 100 ms | **ç¼©çŸ­10å€** |
| **ç²¾åº¦** | é”™è¯¯ï¼ˆé™¤æ³•Bugï¼‰ | <1% è¯¯å·® | **å®Œå…¨ä¿®å¤** |
| **ç¨³å®šæ€§** | å¿«é€Ÿè·³åŠ¨ | Â±5 å¹³æ»‘ | **8å€å¹³æ»‘** |
| **å¯è¯»æ€§** | æ— æ³•è¯»æ•° | æ¸…æ™°ç¨³å®š | **å¯ç”¨** âœ… |

---

## ðŸŽ¯ æœ€ç»ˆæ•ˆæžœ

### 50% å ç©ºæ¯”æ–¹æ³¢è¾“å…¥

**ä¼˜åŒ–å‰**ï¼š
```
æ—¶é—´ 0.0s: æ˜¾ç¤º "0%"
æ—¶é—´ 0.9s: æ˜¾ç¤º "0%"  (å†»ç»“)
æ—¶é—´ 1.0s: æ˜¾ç¤º "87%" (è·³å˜åˆ°é”™è¯¯å€¼)
æ—¶é—´ 1.9s: æ˜¾ç¤º "87%" (å†»ç»“)
æ—¶é—´ 2.0s: æ˜¾ç¤º "13%" (å†æ¬¡è·³å˜)
â†’ å®Œå…¨æ— æ³•ä½¿ç”¨
```

**ä¼˜åŒ–åŽ**ï¼š
```
æ—¶é—´ 0.00s: æ˜¾ç¤º "0%"
æ—¶é—´ 0.10s: æ˜¾ç¤º "50%"
æ—¶é—´ 0.20s: æ˜¾ç¤º "50%"
æ—¶é—´ 0.30s: æ˜¾ç¤º "50%" (ç¨³å®šåœ¨æ­£ç¡®å€¼)
â†’ å¿«é€Ÿæ”¶æ•›ï¼Œç¨³å®šå¯è¯»
```

---

## ðŸ”§ æµ‹è¯•å»ºè®®

1. **è¾“å…¥ä¿¡å·**ï¼š
   - 1kHz æ–¹æ³¢ï¼Œå ç©ºæ¯”50%
   - é¢„æœŸæ˜¾ç¤ºï¼š500 (50.0%)

2. **è°ƒæ•´å ç©ºæ¯”**ï¼š
   - æ”¹ä¸º25% â†’ é¢„æœŸï¼š250
   - æ”¹ä¸º75% â†’ é¢„æœŸï¼š750

3. **åŠ¨æ€æµ‹è¯•**ï¼š
   - ä»Ž25%ç¼“æ…¢æ‰«æåˆ°75%
   - è§‚å¯Ÿæ˜¾ç¤ºæ˜¯å¦å¹³æ»‘è·Ÿéš

4. **ç¨³å®šæ€§æµ‹è¯•**ï¼š
   - å›ºå®š50%å ç©ºæ¯”
   - è§‚å¯Ÿæ•°å€¼æ˜¯å¦åœ¨ 495-505 èŒƒå›´å†…ç¨³å®š

---

## âš™ï¸ å¯è°ƒå‚æ•°

å¦‚éœ€è¿›ä¸€æ­¥ä¼˜åŒ–ï¼Œå¯è°ƒæ•´ï¼š

```verilog
// æµ‹é‡å‘¨æœŸï¼ˆå½±å“å“åº”é€Ÿåº¦ï¼‰
localparam MEASURE_TIME = 100_000;  // 50_000=50msæ›´å¿«, 200_000=200msæ›´ç¨³

// å¹³å‡æ·±åº¦ï¼ˆå½±å“å¹³æ»‘åº¦ï¼‰
localparam DUTY_AVG_DEPTH = 8;  // 4=æ›´å¿«å“åº”, 16=æ›´å¹³æ»‘
```

**å»ºè®®å€¼**ï¼š
- å¿«é€Ÿå“åº”ï¼š`MEASURE_TIME=50_000, DEPTH=4`
- å¹³è¡¡æ¨¡å¼ï¼š`MEASURE_TIME=100_000, DEPTH=8` âœ… æŽ¨è
- è¶…ç¨³å®šï¼š`MEASURE_TIME=200_000, DEPTH=16`

---

## ðŸ“ ä¿®æ”¹æ–‡ä»¶

- âœ… `source/source/signal_parameter_measure.v`
  - ç¬¬33è¡Œï¼šç¼©çŸ­æµ‹é‡å‘¨æœŸåˆ°100ms
  - ç¬¬34è¡Œï¼šæ·»åŠ æ»‘åŠ¨å¹³å‡å‚æ•°
  - ç¬¬56-62è¡Œï¼šæ›´æ–°ä¿¡å·å®šä¹‰
  - ç¬¬167-220è¡Œï¼šé‡å†™å ç©ºæ¯”è®¡ç®—é€»è¾‘

---

## âœ… éªŒè¯æ¸…å•

- [x] è¯­æ³•æ£€æŸ¥é€šè¿‡
- [x] é™¤æ³•ç®—æ³•éªŒè¯
- [x] æ»‘åŠ¨å¹³å‡é€»è¾‘éªŒè¯
- [ ] ç¡¬ä»¶æµ‹è¯•ï¼ˆå¾…ç¼–è¯‘ä¸‹è½½ï¼‰
- [ ] å®žæµ‹æ–¹æ³¢å ç©ºæ¯”å‡†ç¡®æ€§
- [ ] é•¿æ—¶é—´ç¨³å®šæ€§æµ‹è¯•

---

*Last Updated: 2025-10-27*
