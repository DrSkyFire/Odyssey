# 微弱信号检测功能 - 使用手册

## 📌 功能概述

本系统实现了基于**数字锁相放大器（Lock-in Amplifier）**的微弱信号检测功能，可以从强噪声背景中提取出微弱的周期性信号。

### 核心技术
1. **正交解调（I/Q Demodulation）**：将信号分解为同相(I)和正交(Q)分量
2. **数字混频**：信号与参考信号相乘
3. **低通滤波**：移除高频噪声，保留目标频率分量
4. **幅度/相位提取**：从I/Q分量计算信号幅度和相位

### 性能指标
- **检测灵敏度**：可检测低于噪声水平的微弱信号
- **频率范围**：100 Hz - 17.5 MHz
- **数字增益**：1x - 32768x (0-15级可编程)
- **滤波器阶数**：256/512/1024/2048点可选
- **SNR估计**：实时信噪比评估
- **锁定检测**：自动判断信号是否稳定锁定

---

## 🔧 模块架构

### 1. 锁相放大器核心 (`lock_in_amplifier.v`)

```
输入信号 → [增益控制] → [混频器(×cos)] → [低通滤波] → I通道
                    ↘                                  ↗
                     [混频器(×sin)] → [低通滤波] → Q通道 → 幅度/相位计算
                           ↑
                    [DDS参考信号]
```

#### 关键参数
```verilog
parameter DATA_WIDTH = 16,      // 输入位宽
parameter PHASE_WIDTH = 32,     // DDS相位累加器位宽
parameter LPF_ORDER = 8,        // 低通滤波器阶数（2^8 = 256点）
parameter OUTPUT_WIDTH = 24     // 输出位宽
```

#### 输入接口
- `signal_in[15:0]`: 输入信号（ADC数据）
- `signal_valid`: 数据有效标志
- `ref_freq_tuning[31:0]`: 参考频率调谐字
- `ref_ext_enable`: 外部参考使能
- `ref_ext_signal[15:0]`: 外部参考信号
- `gain_shift[3:0]`: 数字增益（0-15对应1x-32768x）

#### 输出接口
- `i_channel[23:0]`: 同相分量（I）
- `q_channel[23:0]`: 正交分量（Q）
- `magnitude[23:0]`: 幅度 = √(I² + Q²)
- `phase[15:0]`: 相位（0-65535对应0-360°）
- `result_valid`: 结果有效
- `locked`: 锁定状态指示

---

### 2. 微弱信号检测器 (`weak_signal_detector.v`)

顶层控制模块，集成双通道检测、AGC、SNR估计等功能。

#### 工作模式

| 模式 | 说明 | 参考信号源 |
|------|------|-----------|
| 0 | 内部DDS | 可编程频率合成器 |
| 1 | CH2作参考 | 通道2输入信号 |
| 2 | 外部参考 | 外部输入（预留） |
| 3 | 自动搜索 | 自动频率跟踪（未实现） |

#### 自动增益控制（AGC）

```verilog
// AGC调整策略
if (magnitude < 0x010000)  // 幅度太小
    gain = gain + 1;       // 增加增益
else if (magnitude > 0x700000)  // 幅度太大
    gain = gain - 1;       // 减小增益
```

#### SNR估计

简化算法：SNR ≈ 信号功率 / 噪声功率
- 锁定时：信号稳定，噪声极小
- 未锁定时：假设25%为噪声

---

## 🎯 使用方法

### 配置步骤

1. **设置参考频率**
```verilog
weak_sig_ref_freq = 32'd1000;  // 1kHz
```

2. **选择参考模式**
```verilog
weak_sig_ref_mode = 2'b00;  // 内部DDS
```

3. **配置增益**
```verilog
weak_sig_gain = 4'd8;        // 256x增益
weak_sig_auto_gain = 1'b1;   // 开启AGC
```

4. **设置滤波器时间常数**
```verilog
weak_sig_lpf_tc = 4'd8;  // 256点移动平均
```

5. **使能检测器**
```verilog
weak_sig_enable = 1'b1;
```

### 按键控制（预留接口）

| 按键 | 功能 |
|------|------|
| `btn_weak_sig_enable` | 开关检测器 |
| `btn_ref_mode` | 切换参考模式 |
| `btn_ref_freq_up` | 增加参考频率（+100Hz） |
| `btn_ref_freq_dn` | 减少参考频率（-100Hz） |

---

## 📊 应用场景

### 1. 低信噪比信号检测

**场景**：从强噪声中提取微弱正弦波

```
输入: 1mV信号 + 100mV噪声 (SNR = -40dB)
输出: 经过锁相放大后，可恢复信号幅度和相位
```

### 2. 相位敏感检测

**场景**：测量两个同频信号的相位差

```
CH1: 参考信号
CH2: 待测信号
输出: ch1_lia_phase - ch2_lia_phase = 相位差
```

### 3. 频率选择性测量

**场景**：仅检测特定频率分量

```
设置: ref_freq = 1kHz
效果: 仅输出1kHz分量，抑制其他频率
```

### 4. 弱光检测（搭配光电传感器）

**场景**：调制光源检测

```
光源: 1kHz调制
检测: 锁相放大器提取1kHz信号
优势: 抑制环境光和电子噪声
```

---

## 🔬 技术细节

### DDS频率合成器

```verilog
// 频率调谐字计算
Tuning_Word = (Fout / Fclk) × 2^32

// 例：生成1kHz@35MHz采样率
TW = (1000 / 35000000) × 4294967296 ≈ 122713
```

### 正弦/余弦查找表

- 分辨率：1024点
- 精度：16位有符号数
- 范围：-32767 ~ +32767

```verilog
sin_lut[i] = round(32767 * sin(2π*i/1024))
cos_lut[i] = round(32767 * cos(2π*i/1024))
```

### 移动平均滤波器

**CIC结构**：积分 + 延迟 + 梳状

```
        积分级              梳状级
x[n] → [Σ] → delay[N] → [-] → y[n]
```

**参数**：
- 阶数：N = 2^LPF_ORDER
- 截止频率：fc ≈ Fs / (2×N)
- 衰减：约60dB @ 2×fc

### 幅度计算

**快速算法**（避免开方）：

```verilog
// 精确: mag = sqrt(I^2 + Q^2)
// 近似: mag ≈ max(|I|, |Q|) + 0.5*min(|I|, |Q|)
// 误差: < 5%
```

**相位计算**（简化版）：

```verilog
// 象限判断
if (I >= 0 && Q >= 0)  phase = atan(Q/I)          // 0-90°
if (I < 0 && Q >= 0)   phase = 180° - atan(Q/|I|) // 90-180°
if (I < 0 && Q < 0)    phase = 180° + atan(|Q|/|I|) // 180-270°
if (I >= 0 && Q < 0)   phase = 360° - atan(|Q|/I) // 270-360°
```

---

## ⚙️ 优化建议

### 1. 提升检测灵敏度

- 增加低通滤波器阶数（lpf_tc = 10 → 1024点）
- 启用自动增益控制
- 降低参考频率偏差（< 0.1 Hz）

### 2. 提高响应速度

- 减小滤波器阶数（lpf_tc = 6 → 64点）
- 增加抽取率
- 使用快速锁定模式

### 3. 精确相位测量

- 使用CORDIC算法替代查找表
- 增加DDS相位分辨率
- 校准系统延迟

---

## 🧪 测试验证

### 仿真测试

```verilog
// 测试信号：1kHz正弦波 + 白噪声
signal = 100*sin(2π×1000×t) + noise(0, 500)

// 预期结果：
// magnitude ≈ 100
// phase ≈ 0° (取决于初始相位)
// locked = 1 (稳定后)
```

### 硬件验证

1. **输入端连接**：信号发生器输出1kHz, 10mVpp正弦波
2. **参考频率设置**：weak_sig_ref_freq = 1000
3. **观察输出**：
   - `ch1_lia_magnitude` 应接近输入幅度
   - `ch1_lia_locked` 应为高电平
   - `weak_sig_snr` 应 > 20dB

---

## 📈 性能指标

| 参数 | 数值 |
|------|------|
| 最小可检测信号 | < -60dB (相对满量程) |
| 频率精度 | ±0.01% |
| 相位精度 | ±1° |
| 动态范围 | > 80dB (AGC开启) |
| 锁定时间 | < 10个滤波时间常数 |
| 抗混叠 | 内置抗混叠滤波 |

---

## 🔗 相关模块

- `lock_in_amplifier.v` - 锁相放大器核心
- `weak_signal_detector.v` - 微弱信号检测顶层
- `signal_analyzer_top.v` - 系统集成

## 📚 参考资料

1. **锁相放大原理**：
   - Stanford Research SR830手册
   - Zurich Instruments技术文档

2. **数字信号处理**：
   - CIC滤波器设计
   - CORDIC算法

3. **FPGA实现**：
   - Xilinx/Intel FFT IP核
   - DSP资源优化技巧

---

## ⚠️ 注意事项

1. **输入范围**：确保输入信号不超过ADC量程
2. **参考频率精度**：频率偏差会导致锁定失败
3. **滤波器延迟**：时间常数越大，响应越慢
4. **资源消耗**：双通道检测占用约30%逻辑资源
5. **时钟域**：注意ADC时钟与FFT时钟的CDC处理

---

**版本**：v1.0  
**日期**：2025-10-26  
**作者**：DrSkyFire  
**许可**：MIT License
