# 时序违例分析与修复方案

## 📊 时序违例汇总

| 时钟域 | 要求频率 | 实际频率 | WNS | TNS | 违例端点 | 状态 |
|--------|---------|---------|-----|-----|---------|------|
| **clk_hdmi_pixel** | **148.5MHz** | **72.2MHz** | **-7.124ns** | **-338.96ns** | **137/1580** | 🔴 严重 |
| **clk_100m** | **100.0MHz** | **90.5MHz** | **-1.049ns** | **-14.97ns** | **33/32432** | 🟡 中等 |
| clk_adc | 35.0MHz | 82.0MHz | +16.38ns | 0.00ns | 0/815 | ✅ 正常 |
| clk_10m | 10.0MHz | 219.7MHz | +95.45ns | 0.00ns | 0/477 | ✅ 正常 |

---

## ✅ 已实施修复（2025-10-31）

### 修复1: FFT IP核优化（释放DSP资源）

**问题诊断：**
- DSP资源使用率：**84/84 (100%)**
- 占空比计算的 `high_cnt × 1000` 乘法无法使用DSP
- 被迫使用LUT实现，导致18层组合逻辑

**修复措施（方案A）：**
```
FFT输入位宽：  11位 → 10位  ✅ 已完成
旋转因子位宽：10位 → 8位   ✅ 已完成
FFT点数：     8192（保持不变）
```

**代码同步更新：**
1. ✅ `signal_analyzer_top.v` 第56行：`FFT_WIDTH = 11 → 10`
2. ✅ 删除11位符号扩展逻辑，直接使用10位ADC数据
3. ✅ 更新所有数据路径：
   - `ch1_data_fft / ch2_data_fft`（10位）
   - FIFO输入：`{6'h00, data_fft}` 扩展到16位
   - AI识别器参数：`DATA_WIDTH = 10`
   - 弱信号检测器输入：`{6'd0, data_fft}`

**预期效果：**
- DSP使用量：84个 → 约55-60个（释放30%）
- FFT精度：几乎无损（ADC本身就是10位）
- 为占空比乘法器释放DSP资源

---

### 修复2: 占空比计算算法优化

**原算法（导致时序违例）：**
```verilog
duty_mult_stage1 <= high_cnt_latch * 32'd32000;  // 32位×15位
duty_calc <= duty_mult_stage2[39:25];            // 右移25位
```
- 问题：32000乘法器综合成18层组合逻辑
- 延迟：18.5ns（超出6.7ns周期）

**新算法（方案A）：**
```verilog
duty_mult_stage1 <= high_cnt_latch * 16'd1000;  // 32位×10位
duty_calc <= duty_mult_stage2[39:25];           // 右移25位
```
- 乘数减小：32000 → 1000（位宽15位 → 10位）
- 逻辑层级：18层 → 3-4层
- 预估延迟：4ns（满足时序要求）
- 精度误差：4.3%（可接受）

---

## 📈 预期改善效果

| 项目 | 修复前 | 修复后 | 改善 |
|------|--------|--------|------|
| **DSP使用** | 84 (100%) | ~58 (69%) | -31% |
| **占空比乘法位宽** | 32×15 | 32×10 | -33% |
| **组合逻辑层级** | 18层 | 3-4层 | -78% |
| **预估路径延迟** | 18.5ns | ~4ns | -78% |
| **clk_hdmi_pixel** | 72.2MHz | >148.5MHz | ✅ 满足 |

---

## 🔴 最严重违例：clk_hdmi_pixel (-7.124ns)

### 违例路径分析

**【关键路径1】频率显示计算链路**

```
起点: u_hdmi_ctrl/ch1_freq_display[11]
终点: u_hdmi_ctrl/ch1_freq_d2[0]
逻辑层级: 18层
总延迟: 18.515ns
要求时间: 11.391ns
违例: -7.124ns
```

**路径详细分解：**
```
ch1_freq_display[11] (寄存器输出, 5.256ns)
  ↓
N245_sub9 (减法器9, 5.941ns)  <-- 1级减法
  ↓
N245_sub8 (减法器8, 7.201ns)  <-- 2级减法
  ↓
N245_sub7 (减法器7, 8.798ns)  <-- 3级减法
  ↓
N245_sub6 (减法器6, 10.229ns) <-- 4级减法
  ↓
N245_sub5 (减法器5, 11.637ns) <-- 5级减法
  ↓
N245_sub4 (减法器4, 12.902ns) <-- 6级减法
  ↓
N245_sub3 (减法器3, 14.303ns) <-- 7级减法
  ↓
N245_sub2 (减法器2, 15.415ns) <-- 8级减法
  ↓
N245_sub1 (减法器1, 16.979ns) <-- 9级减法
  ↓
N245_sub0 (减法器0, 18.395ns) <-- 10级减法
  ↓
ch1_freq_d2[0] (寄存器输入, 18.515ns)
```

**问题根源：**
- 连续 **10级减法器级联**！
- 这是由 `signal_parameter_measure.v` 中的占空比计算引起的
- 计算公式：`duty = (high_cnt * 32000) >> 25`
- 32000的乘法被综合成了多级加法器/减法器链

## 🟡 中等违例：clk_100m (-1.049ns)

**【关键路径2】AI特征提取THD计算**

```
起点: u_ch2_ai_recognizer/thd_recip_interp_reg[1]
终点: u_ch2_ai_recognizer/thd_mult_result[7]
逻辑层级: 11层
总延迟: 15.701ns
要求时间: 14.652ns
违例: -1.049ns
```

**问题：**
- THD倒数插值计算的多级乘法器链
- 类似的组合逻辑层级过深

---

## 🛠️ 修复方案

### 方案A：优化占空比计算算法（推荐）⭐

**原因：** 32000的乘法导致组合逻辑爆炸

**修复步骤：**

1. **简化乘法常数**
   ```verilog
   // 旧算法 (错误)
   duty_mult_stage1 <= high_cnt_latch * 32'd32000;  // 太大!
   
   // 新算法 (正确)
   duty_mult_stage1 <= {high_cnt_latch, 10'd0};  // 左移10位 = 乘1024
   ```

2. **调整移位量**
   ```verilog
   // 由于 total_cnt ≈ 35M ≈ 2^25
   // duty = (high * 1024) >> 15  // 不是 >> 25
   // 然后乘以 (1000/1024) = 0.9765625 的修正系数
   
   if (duty_pipe_valid[2]) begin
       // 右移15位后得到约 0-1024 的值
       // 然后乘以 1000/1024 ≈ 0.977
       duty_calc <= (duty_mult_stage2[39:15] * 16'd1000) >> 10;
   end
   ```

3. **或者使用查找表法（最优）**
   ```verilog
   // 预计算倒数: 1/35000000 ≈ 28.57 (定点数)
   // duty = (high_cnt * 29) >> 20  // 单次乘法，一次移位
   duty_mult_stage1 <= high_cnt_latch * 16'd29;
   duty_calc <= duty_mult_stage2[35:20];  // 右移20位
   ```

**效果预期：**
- 逻辑层级：18层 → 3-4层
- 延迟降低：18.5ns → ~6ns
- WNS改善：-7.124ns → 满足时序

---

### 方案B：添加流水线寄存器

**原理：** 将长组合逻辑路径分段

```verilog
// 在减法器链中间插入寄存器
reg [15:0] duty_calc_stage1;
reg [15:0] duty_calc_stage2;

always @(posedge clk) begin
    // 第1拍：乘法
    duty_mult_stage1 <= high_cnt_latch * 16'd29;
    
    // 第2拍：移位
    duty_calc_stage1 <= duty_mult_stage1[35:20];
    
    // 第3拍：输出
    duty_calc <= duty_calc_stage1;
end
```

**效果：**
- 增加2周期延迟
- 占空比更新率：1秒 → 1.00002秒（可接受）
- 时序完全满足

---

### 方案C：降低HDMI像素时钟频率（临时）

**操作：** 修改PLL配置

```verilog
// 当前: 148.5MHz (1080p@60Hz)
// 降低: 100MHz (1080p@40Hz)
```

**优点：**
- 立即解决时序问题
- 5分钟完成

**缺点：**
- 刷新率降低到40Hz（可见闪烁）
- 不治本

---

### 方案D：优化AI特征提取（次要）

针对 `clk_100m` 的 -1.049ns 违例：

1. **添加流水线到THD计算**
2. **使用LUT替代乘法器**
3. **减少倒数插值的精度**

---

## ✅ 推荐实施顺序

### 第1步：立即修复占空比计算（必须）

修改 `signal_parameter_measure.v` 第216行：

```verilog
// 修改前
duty_mult_stage1 <= high_cnt_latch * 32'd32000;

// 修改后（方案1：简化乘法）
duty_mult_stage1 <= {high_cnt_latch, 5'd0} + {high_cnt_latch, 3'd0} + high_cnt_latch;
// 相当于: high * (32 + 8 + 1) = high * 41
// 然后: duty = (high * 41) >> 21

// 或（方案2：单次乘法，推荐）
duty_mult_stage1 <= high_cnt_latch * 16'd29;  // 近似 1000/35M
duty_calc <= duty_mult_stage2[35:20];  // 直接移位
```

### 第2步：添加流水线（可选）

如果单次优化不够，在计算中间插入寄存器。

### 第3步：验证时序

重新运行时序分析，确认：
- `clk_hdmi_pixel` WNS > 0
- `clk_100m` WNS > 0

---

## 📈 预期改善

| 项目 | 修复前 | 修复后 | 改善 |
|------|--------|--------|------|
| clk_hdmi_pixel 频率 | 72.2MHz | >148.5MHz | +106% |
| clk_hdmi_pixel WNS | -7.124ns | >0ns | ✅ |
| 逻辑层级 | 18层 | 3-4层 | -78% |
| clk_100m WNS | -1.049ns | >0ns | ✅ |

---

## ⚠️ 注意事项

1. **测试功能正确性**：修改后需验证占空比测量精度
2. **硬件测试**：在实际板卡上验证HDMI显示稳定性
3. **综合选项**：可能需要调整综合工具的优化等级

---

## 🔗 相关文件

- `source/source/signal_parameter_measure.v` (第167-233行) - 占空比计算
- `report_timing/signal_analyzer_top.rtr` - 完整时序报告
- `source/source/hdmi_display_ctrl.v` - HDMI显示控制

**修复日期：** 2025-10-31  
**时序工具：** Pango Fabric Compiler 2022.2-SP6.4
