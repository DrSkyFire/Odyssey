# 信号测量时间效应分析报告

## 📋 报告信息
- **日期**：2025年11月6日
- **模块**：signal_parameter_measure.v
- **问题描述**：频率测量和幅度测量存在明显的时间效应，输出受上一时刻影响较大
- **分析人**：GitHub Copilot

---

## 🔍 问题分析

### 核心问题：多重滑动平均滤波导致的延迟累积

您的信号测量模块中，**频率、幅度、占空比和THD都使用了滑动平均滤波器**，这是导致时间效应的主要原因。

---

## ⚠️ 发现的问题

### 问题 1: 频率测量的多级滞后 ⭐⭐⭐

**位置**: `signal_parameter_measure.v` 第533-567行

**代码现状**:
```verilog
// Stage 5: 滑动平均滤波器（4次平均，减少抖动）
reg [15:0]  freq_history[0:3];              // 历史值缓存
reg [1:0]   freq_hist_ptr;                  // 历史值指针
reg [17:0]  freq_sum;                       // 累加和
reg [15:0]  freq_filtered;                  // 滤波后的结果

always @(posedge clk or negedge rst_n) begin
    if (!rst_n) begin
        freq_sum <= 18'd0;
        freq_hist_ptr <= 2'd0;
        freq_filtered <= 16'd0;
        freq_unit_d3 <= 2'd0;
        for (j = 0; j < 4; j = j + 1) begin
            freq_history[j] <= 16'd0;
        end
    end else begin
        freq_unit_d3 <= freq_unit_d2;
        
        // 单位切换检测和滤波器更新
        if (freq_unit_d2 != freq_unit_d3) begin
            // 清空历史数据
        end
        else if (freq_result_done && freq_result != freq_history[freq_hist_ptr]) begin
            freq_sum <= freq_sum - freq_history[freq_hist_ptr] + freq_result;
            freq_history[freq_hist_ptr] <= freq_result;
            freq_hist_ptr <= freq_hist_ptr + 1'b1;
            freq_filtered <= freq_sum[17:2];  // ÷4
        end
    end
end
```

**问题分析**:
1. **4次滑动平均**：需要4个测量周期（400ms）才能完全更新
2. **流水线延迟**：freq_calc_trigger → freq_result_done 有3-4个时钟周期延迟
3. **输出更新条件**：`freq_result != freq_history[freq_hist_ptr]` 可能导致相同值被跳过
4. **时间效应**：当频率从1kHz切换到10kHz时
   - 第1个周期：freq_filtered = (1000*3 + 10000*1) / 4 = 3250Hz ❌
   - 第2个周期：freq_filtered = (1000*2 + 10000*2) / 4 = 5500Hz ❌
   - 第3个周期：freq_filtered = (1000*1 + 10000*3) / 4 = 7750Hz ❌
   - 第4个周期：freq_filtered = 10000Hz ✅

**影响**: 频率变化后需要400ms才能稳定到新值

---

### 问题 2: 幅度测量的滑动平均 ⭐⭐⭐

**位置**: `signal_parameter_measure.v` 第183-188行

**代码现状**:
```verilog
// 【新增】幅度滑动平均滤波 (4次平均，减少抖动)
reg [15:0]  amp_history[0:3];               // 幅度历史值缓存
reg [1:0]   amp_hist_ptr;                   // 幅度历史值指针
reg [17:0]  amp_sum;                        // 幅度累加和
reg [15:0]  amp_filtered;                   // 幅度滤波后的结果
```

**问题分析**:
- 同样采用4次滑动平均
- 幅度变化（如1V→2V）后需要400ms才能稳定
- 代码位置在第933-956行的滤波器实现

**影响**: 幅度响应速度慢，动态信号跟踪性能差

---

### 问题 3: 占空比测量的8次滑动平均 ⭐⭐⭐

**位置**: `signal_parameter_measure.v` 第175-180行

**代码现状**:
```verilog
// 【优化】占空比滑动平均滤波 (8次平均，减少跳动)
reg [15:0]  duty_history[0:7];              // 历史值缓存
reg [2:0]   duty_hist_ptr;                  // 历史值指针
reg [18:0]  duty_sum;                       // 累加和
reg [15:0]  duty_filtered;                  // 滤波后的结果
```

**问题分析**:
- **8次滑动平均**：需要800ms才能完全更新 ❌
- 占空比从50%切换到75%后的响应更慢
- 代码实现在第1414-1437行

**影响**: 占空比变化后需要800ms才能稳定，用户体验差

---

### 问题 4: THD测量的8次滑动平均 ⭐⭐

**位置**: `signal_parameter_measure.v` 第1660-1687行

**代码现状**:
```verilog
// 5b. THD滑动平均滤波器(8次平均，减少跳动)
reg [15:0]  thd_history[0:7];               // THD历史值缓存
reg [2:0]   thd_hist_ptr;                   // THD历史值指针
reg [18:0]  thd_sum;                        // THD累加和
reg [15:0]  thd_filtered;                   // 滤波后的THD结果
```

**问题分析**:
- 8次平均，800ms响应时间
- THD变化跟踪缓慢

**影响**: THD测量滞后严重

---

### 问题 5: 测量周期固定100ms可能不适合所有场景 ⭐

**位置**: `signal_parameter_measure.v` 第82行

**代码现状**:
```verilog
localparam TIME_100MS = 10_000_000;         // 100ms＝100MHz时钟周期（10Hz更新）
```

**问题分析**:
- 测量周期100ms + 滤波器延迟 = 总延迟400ms-800ms
- 对于快速变化的信号，响应太慢
- 测量周期和滤波器窗口没有分离设计

---

## 💡 改进建议

### 方案 1: 减少滤波器窗口大小（推荐） ⭐⭐⭐⭐⭐

**目标**: 将响应时间从400-800ms降低到100-200ms

**修改建议**:

#### 1.1 频率滤波器：4次 → 2次
```verilog
// 修改前：4次平均，400ms响应
reg [15:0]  freq_history[0:3];  

// 修改后：2次平均，200ms响应
reg [15:0]  freq_history[0:1];
reg         freq_hist_ptr;  // 从2位改为1位
reg [16:0]  freq_sum;        // 从18位改为17位
```

#### 1.2 幅度滤波器：4次 → 2次
```verilog
// 修改前：4次平均，400ms响应
reg [15:0]  amp_history[0:3];

// 修改后：2次平均，200ms响应
reg [15:0]  amp_history[0:1];
reg         amp_hist_ptr;
reg [16:0]  amp_sum;
```

#### 1.3 占空比滤波器：8次 → 4次
```verilog
// 修改前：8次平均，800ms响应
reg [15:0]  duty_history[0:7];

// 修改后：4次平均，400ms响应
reg [15:0]  duty_history[0:3];
reg [1:0]   duty_hist_ptr;  // 从3位改为2位
reg [17:0]  duty_sum;        // 从19位改为18位
```

#### 1.4 THD滤波器：8次 → 4次
```verilog
// 修改前：8次平均，800ms响应
reg [15:0]  thd_history[0:7];

// 修改后：4次平均，400ms响应
reg [15:0]  thd_history[0:3];
reg [1:0]   thd_hist_ptr;
reg [17:0]  thd_sum;
```

**优点**:
- ✅ 响应速度提升2倍
- ✅ 仍然保留平滑效果
- ✅ 资源消耗减半
- ✅ 改动量小，风险低

**缺点**:
- ⚠️ 噪声抑制能力略有下降（但通常可接受）

---

### 方案 2: 自适应滤波器（高级方案） ⭐⭐⭐⭐

**目标**: 根据信号变化速度自动调整滤波器强度

**设计思路**:
```verilog
// 检测信号变化率
reg [15:0] freq_change_rate;
always @(posedge clk) begin
    freq_change_rate <= (freq_result > freq_filtered) ? 
                        (freq_result - freq_filtered) : 
                        (freq_filtered - freq_result);
end

// 动态调整滤波器权重
reg [3:0] filter_alpha;  // 滤波系数
always @(*) begin
    if (freq_change_rate > THRESHOLD_LARGE_CHANGE)
        filter_alpha = 4'd12;  // 快速响应模式（α=0.75）
    else if (freq_change_rate > THRESHOLD_SMALL_CHANGE)
        filter_alpha = 4'd8;   // 中速响应模式（α=0.5）
    else
        filter_alpha = 4'd4;   // 慢速平滑模式（α=0.25）
end

// 一阶IIR滤波器
always @(posedge clk) begin
    freq_filtered <= freq_filtered + 
                     (((freq_result - freq_filtered) * filter_alpha) >> 4);
end
```

**优点**:
- ✅ 信号快速变化时响应快
- ✅ 信号稳定时噪声抑制好
- ✅ 自动平衡响应速度和稳定性

**缺点**:
- ⚠️ 实现复杂度高
- ⚠️ 需要仔细调试阈值参数

---

### 方案 3: 可配置滤波器窗口（灵活方案） ⭐⭐⭐

**目标**: 通过寄存器配置滤波器深度

**设计思路**:
```verilog
// 添加配置寄存器
input wire [2:0] filter_depth;  // 0=无滤波, 1=2次, 2=4次, 3=8次

// 动态调整滤波器
always @(posedge clk) begin
    case (filter_depth)
        3'd0: freq_filtered <= freq_result;                    // 无滤波
        3'd1: freq_filtered <= (freq_sum[16:1]);               // 2次平均
        3'd2: freq_filtered <= (freq_sum[17:2]);               // 4次平均
        3'd3: freq_filtered <= (freq_sum[18:3]);               // 8次平均
        default: freq_filtered <= freq_sum[17:2];              // 默认4次
    endcase
end
```

**优点**:
- ✅ 用户可根据需求调整
- ✅ 支持运行时配置
- ✅ 测试时可快速切换模式

**缺点**:
- ⚠️ 需要额外的控制接口
- ⚠️ 资源消耗略有增加

---

### 方案 4: 减少测量周期（激进方案） ⭐⭐

**目标**: 将测量周期从100ms降低到50ms

**修改**:
```verilog
// 修改前：100ms测量周期
localparam TIME_100MS = 10_000_000;

// 修改后：50ms测量周期
localparam TIME_50MS = 5_000_000;
```

**优点**:
- ✅ 所有参数响应速度提升2倍

**缺点**:
- ⚠️ 低频信号（<20Hz）测量精度下降
- ⚠️ 频率分辨率降低
- ⚠️ 噪声影响增大

**建议**: 不推荐，除非您的信号频率都>100Hz

---

## 📊 改进效果对比表

| 参数 | 当前响应时间 | 方案1（减半） | 方案2（自适应） | 方案4（50ms周期） |
|------|-------------|--------------|----------------|------------------|
| **频率** | 400ms | 200ms ✅ | 100-400ms ⭐ | 200ms |
| **幅度** | 400ms | 200ms ✅ | 100-400ms ⭐ | 200ms |
| **占空比** | 800ms | 400ms ✅ | 200-800ms ⭐ | 400ms |
| **THD** | 800ms | 400ms ✅ | 200-800ms ⭐ | 400ms |
| **噪声抑制** | 优秀 | 良好 | 自适应 | 一般 |
| **实现难度** | - | 简单 ⭐ | 中等 | 简单 |

---

## 🛠️ 推荐实施方案

### 立即实施（风险低）：
1. **方案1**: 减少滤波器窗口大小
   - 频率、幅度：4次 → 2次
   - 占空比、THD：8次 → 4次
   - 预期改善：响应速度提升2倍

### 中期优化（风险中）：
2. **方案2**: 实现自适应滤波器
   - 仅对频率和幅度测量应用
   - 占空比和THD保持固定滤波

### 长期规划（可选）：
3. **方案3**: 添加可配置滤波器接口
   - 通过SPI/I2C配置寄存器
   - 支持不同应用场景

---

## 🔧 具体修改步骤（方案1）

### 步骤1: 修改频率滤波器
修改位置：`signal_parameter_measure.v` 第141-148行

**当前代码**:
```verilog
// 【优化】频率滑动平均滤波器(4次平均，减少抖动)
reg [15:0]  freq_history[0:3];              // 历史值缓存
reg [1:0]   freq_hist_ptr;                  // 历史值指针
reg [17:0]  freq_sum;                       // 累加和
reg [15:0]  freq_filtered;                  // 滤波后的结果
```

**修改为**:
```verilog
// 【优化】频率滑动平均滤波器(2次平均，快速响应)
reg [15:0]  freq_history[0:1];              // 历史值缓存（改为2项）
reg         freq_hist_ptr;                  // 历史值指针（改为1位）
reg [16:0]  freq_sum;                       // 累加和（改为17位）
reg [15:0]  freq_filtered;                  // 滤波后的结果
```

**修改滤波器实现**（第533-567行）:
```verilog
// Stage 5: 滑动平均滤波器（2次平均，快速响应）
integer j;
reg [1:0] freq_unit_d3;
always @(posedge clk or negedge rst_n) begin
    if (!rst_n) begin
        freq_sum <= 17'd0;
        freq_hist_ptr <= 1'd0;
        freq_filtered <= 16'd0;
        freq_unit_d3 <= 2'd0;
        for (j = 0; j < 2; j = j + 1) begin  // 改为2次循环
            freq_history[j] <= 16'd0;
        end
    end else begin
        freq_unit_d3 <= freq_unit_d2;
        
        if (freq_unit_d2 != freq_unit_d3) begin
            freq_sum <= 17'd0;
            freq_hist_ptr <= 1'd0;
            freq_filtered <= 16'd0;
            for (j = 0; j < 2; j = j + 1) begin  // 改为2次循环
                freq_history[j] <= 16'd0;
            end
        end
        else if (freq_result_done && freq_result != freq_history[freq_hist_ptr]) begin
            freq_sum <= freq_sum - freq_history[freq_hist_ptr] + freq_result;
            freq_history[freq_hist_ptr] <= freq_result;
            freq_hist_ptr <= ~freq_hist_ptr;  // 0↔1切换
            freq_filtered <= freq_sum[16:1];  // ÷2（改为右移1位）
        end
    end
end
```

---

### 步骤2: 修改幅度滤波器
修改位置：`signal_parameter_measure.v` 第183-188行

**当前代码**:
```verilog
// 【新增】幅度滑动平均滤波 (4次平均，减少抖动)
reg [15:0]  amp_history[0:3];
reg [1:0]   amp_hist_ptr;
reg [17:0]  amp_sum;
reg [15:0]  amp_filtered;
```

**修改为**:
```verilog
// 【新增】幅度滑动平均滤波 (2次平均，快速响应)
reg [15:0]  amp_history[0:1];               // 改为2项
reg         amp_hist_ptr;                   // 改为1位
reg [16:0]  amp_sum;                        // 改为17位
reg [15:0]  amp_filtered;
```

**修改滤波器实现**（第933-956行）:
```verilog
// 幅度滑动平均滤波 (2次平均，快速响应)
always @(posedge clk or negedge rst_n) begin
    if (!rst_n) begin
        amp_sum <= 17'd0;
        amp_hist_ptr <= 1'd0;
        amp_filtered <= 16'd0;
        for (i = 0; i < 2; i = i + 1) begin  // 改为2次循环
            amp_history[i] <= 16'd0;
        end
    end else begin
        if (amp_pipe_valid[1]) begin
            amp_sum <= amp_sum - amp_history[amp_hist_ptr] + amp_result;
            amp_history[amp_hist_ptr] <= amp_result;
            amp_hist_ptr <= ~amp_hist_ptr;  // 0↔1切换
            amp_filtered <= amp_sum[16:1];  // ÷2（右移1位）
        end
    end
end
```

---

### 步骤3: 修改占空比滤波器
修改位置：`signal_parameter_measure.v` 第175-180行

**当前代码**:
```verilog
// 【优化】占空比滑动平均滤波 (8次平均，减少跳动)
reg [15:0]  duty_history[0:7];
reg [2:0]   duty_hist_ptr;
reg [18:0]  duty_sum;
reg [15:0]  duty_filtered;
```

**修改为**:
```verilog
// 【优化】占空比滑动平均滤波 (4次平均，平衡响应)
reg [15:0]  duty_history[0:3];              // 改为4项
reg [1:0]   duty_hist_ptr;                  // 改为2位
reg [17:0]  duty_sum;                       // 改为18位
reg [15:0]  duty_filtered;
```

**修改滤波器实现**（第1414-1437行）:
```verilog
// 占空比滑动平均滤波 (4次平均)
always @(posedge clk or negedge rst_n) begin
    if (!rst_n) begin
        duty_sum <= 18'd0;
        duty_hist_ptr <= 2'd0;
        duty_filtered <= 16'd0;
        for (k = 0; k < 4; k = k + 1) begin  // 改为4次循环
            duty_history[k] <= 16'd0;
        end
    end else begin
        if (duty_pipe_valid[2]) begin
            duty_sum <= duty_sum - duty_history[duty_hist_ptr] + duty_result;
            duty_history[duty_hist_ptr] <= duty_result;
            duty_hist_ptr <= duty_hist_ptr + 1'b1;
            duty_filtered <= duty_sum[17:2];  // ÷4（右移2位）
        end
    end
end
```

---

### 步骤4: 修改THD滤波器
修改位置：`signal_parameter_measure.v` 第1660-1687行

**当前代码**:
```verilog
// 5b. THD滑动平均滤波器(8次平均，减少跳动)
reg [15:0]  thd_history[0:7];
reg [2:0]   thd_hist_ptr;
reg [18:0]  thd_sum;
reg [15:0]  thd_filtered;
```

**修改为**:
```verilog
// 5b. THD滑动平均滤波器(4次平均，平衡响应)
reg [15:0]  thd_history[0:3];               // 改为4项
reg [1:0]   thd_hist_ptr;                   // 改为2位
reg [17:0]  thd_sum;                        // 改为18位
reg [15:0]  thd_filtered;
```

**修改滤波器实现**:
```verilog
always @(posedge clk or negedge rst_n) begin
    if (!rst_n) begin
        for (i = 0; i < 4; i = i + 1) begin  // 改为4次循环
            thd_history[i] <= 16'd0;
        end
        thd_hist_ptr <= 2'd0;
        thd_sum <= 18'd0;
        thd_filtered <= 16'd0;
    end else begin
        if (thd_pipe_valid[2]) begin
            thd_sum <= thd_sum - thd_history[thd_hist_ptr] + thd_calc;
            thd_history[thd_hist_ptr] <= thd_calc;
            thd_hist_ptr <= thd_hist_ptr + 1'b1;
            thd_filtered <= (thd_sum - thd_history[thd_hist_ptr] + thd_calc) >> 2;  // ÷4（右移2位）
        end
    end
end
```

---

## ✅ 测试验证清单

修改完成后，请按以下步骤验证：

### 1. 频率响应测试
- [ ] 信号：1kHz → 10kHz
- [ ] 预期响应时间：<200ms（修改前400ms）
- [ ] 稳定后误差：<0.1%

### 2. 幅度响应测试
- [ ] 信号：1Vpp → 2Vpp
- [ ] 预期响应时间：<200ms（修改前400ms）
- [ ] 稳定后误差：<1%

### 3. 占空比响应测试
- [ ] 信号：50% → 75%
- [ ] 预期响应时间：<400ms（修改前800ms）
- [ ] 稳定后误差：<0.5%

### 4. 噪声抑制测试
- [ ] 信号：1kHz + 白噪声（SNR=20dB）
- [ ] 频率抖动：<±10Hz（确认滤波仍有效）
- [ ] 幅度抖动：<±10mV

### 5. 极限测试
- [ ] 最低频率：10Hz（确认仍能正常测量）
- [ ] 最高频率：17.5MHz（确认精度未下降）

---

## 📝 总结

### 问题根源
- ✅ 多级滑动平均滤波器导致400-800ms的延迟
- ✅ 滤波器窗口过大（4次和8次）
- ✅ 测量周期（100ms）与滤波器窗口累积

### 推荐方案
- ⭐ **方案1**：减少滤波器窗口（2次和4次）
  - 实施难度：低
  - 改善效果：响应速度提升2倍
  - 风险评估：低

### 预期改善
- 频率响应：400ms → 200ms
- 幅度响应：400ms → 200ms
- 占空比响应：800ms → 400ms
- THD响应：800ms → 400ms

---

**报告完成**  
如需实施修改，我可以帮您生成具体的代码补丁文件。
