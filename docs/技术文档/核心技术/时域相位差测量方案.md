# 时域相位差测量方案 - 快速参考

## 📋 概述

采用**过零检测法**测量双通道相位差，**完全不依赖 FFT**，直接处理 ADC 时域采样数据。

---

## 🔧 核心原理

### 方法
1. **过零检测**：检测两个通道信号的上升沿过零点（零点 = 128，8位ADC中点）
2. **周期测量**：自动测量信号周期 T（通过连续两个上升沿时间差）
3. **时间差计算**：测量两个通道过零点之间的时间差 Δt
4. **相位差计算**：Phase = (Δt / T) × 360°

### 技术参数
- **采样率**：35MHz（与 ADC 时钟同步）
- **理论精度**：1kHz 信号下约 **0.01°**（35000 采样点/周期）
- **频率范围**：100Hz ~ 35kHz（可测周期 1000 ~ 350000 采样点）
- **滞回区间**：±5 LSB（防止过零抖动）

---

## 📊 信号连接

### 输入信号
```verilog
.clk         (clk_adc)              // 35MHz ADC采样时钟
.adc_ch1_data(ch1_data_sync[9:2])   // CH1 高8位数据
.adc_ch2_data(ch2_data_sync[9:2])   // CH2 高8位数据
.adc_valid   (dual_data_valid)      // 双通道数据有效
```

### 输出信号
```verilog
.phase_diff     (phase_difference)  // -1800 ~ +1800 (表示 -180.0° ~ +180.0°)
.phase_valid    (phase_diff_valid)  // 相位差有效标志（脉冲）
.phase_confidence(phase_confidence) // 0-255 置信度（周期稳定性）
```

---

## 🔍 LED 调试含义（新定义）

| LED | 状态 | 含义 |
|-----|------|------|
| LED[0] | 亮 | 系统运行（run_flag） |
| LED[1] | 亮 | 双通道ADC数据有效 |
| LED[2] | 亮 | 相位差输出有效 |
| LED[3] | 亮 | 置信度 > 100（周期稳定） |
| LED[4] | 亮 | 相位差 > 10° |
| LED[5] | 亮 | 相位差 < -10° |
| LED[6] | 亮 | CH1 过载（OTR） |
| LED[7] | 亮 | CH2 过载（OTR） |

---

## 🎯 预期测试结果

### 输入：1kHz 正弦波，相位差 0°
- **LED 状态**：LED[0,1,2,3] 亮
- **HDMI 显示**：+000.0° 或 -000.0°

### 输入：1kHz 正弦波，相位差 +90°
- **LED 状态**：LED[0,1,2,3,4] 亮
- **HDMI 显示**：+090.0°

### 输入：1kHz 正弦波，相位差 -90°
- **LED 状态**：LED[0,1,2,3,5] 亮
- **HDMI 显示**：-090.0°

### 输入：1kHz 正弦波，相位差 180°
- **LED 状态**：LED[0,1,2,3] 亮（LED[4,5] 取决于具体值是否>10°）
- **HDMI 显示**：+180.0° 或 -180.0°

---

## ✅ 优势对比

| 特性 | FFT频域法 | 时域过零法 |
|------|-----------|------------|
| 依赖模块 | FFT + CORDIC | 仅计数器 |
| 延迟 | ~8192采样点 | 1-2周期 |
| 资源占用 | 大（乘法器） | 小（仅逻辑） |
| 适用场景 | 多频率/谐波分析 | 单一频率 |
| 调试难度 | 高（多模块） | 低（纯时域） |
| 可靠性 | 依赖FFT配置 | 简单可靠 |

---

## ⚠️ 注意事项

1. **仅适用于单一频率正弦波**（如1kHz测试信号）
2. **信号幅度需足够**：确保过零点清晰，避免噪声误触发
3. **频率范围**：100Hz ~ 35kHz（低频测试需等待更长周期）
4. **滞回机制**：已设置±5 LSB滞回，防止零点附近抖动

---

## 🚀 快速测试步骤

1. **编译烧录**：使用新的时域相位差测量模块
2. **输入信号**：双通道输入 **1kHz 正弦波**，幅度 0.5-2Vpp
3. **观察 LED**：
   - LED[0] 应该常亮（系统运行）
   - LED[1] 应该常亮（ADC数据有效）
   - LED[2] 应该**闪烁或常亮**（相位差计算有效）
   - LED[3] 应该亮（置信度足够）
4. **观察 HDMI**：应该显示实际相位差（不再是固定 -099.8°）
5. **调整相位**：改变两个通道的相位差，观察HDMI数值变化

---

## 🔧 如果仍有问题

### LED[1] 不亮（ADC数据无效）
- 检查 `dual_data_valid` 信号
- 确认 ADC 同步模块正常工作

### LED[2] 不亮（相位差不输出）
- 检查输入信号幅度（需要足够的信噪比）
- 确认信号频率在 100Hz ~ 35kHz 范围内
- 查看周期测量是否在合理范围（MIN_PERIOD ~ MAX_PERIOD）

### 显示值不准确
- 检查输入信号是否为纯正弦波（非方波/三角波）
- 确认两个通道信号质量一致
- 调整 ZERO_THRESHOLD（当前=128）以匹配实际ADC中点

---

**立即编译测试，报告新的 LED 状态和 HDMI 显示值！**
