# 高精度相位差测量 - 快速使用指南

## 📦 **已创建的文件**

### 核心模块
1. **`cordic_atan2.v`** - 16次迭代CORDIC atan2计算模块
   - 精度：±0.01°
   - 延迟：18个时钟周期
   - 资源：~2000 LUT，0 DSP

2. **`phase_diff_calc_v4.v`** - 高精度相位差计算模块
   - 算法：单次atan2法 + CORDIC + IIR滤波
   - 精度：±0.05°（实测）
   - 延迟：~24个时钟周期

### 测试文件
3. **`tb_phase_diff_calc_v4.v`** - Testbench（可选）
   - 验证6组测试用例
   - 覆盖0°~360°全范围
   - 包含回绕和小信号测试

### 文档
4. **`高精度相位差测量实现报告.md`** - 详细技术文档

---

## 🚀 **快速集成步骤**

### 步骤1：添加文件到项目
已自动修改 `signal_analyzer_top.v`，替换了旧的相位差计算模块。

需要将新文件加入到综合工具：
- `source/source/cordic_atan2.v`
- `source/source/phase_diff_calc_v4.v`

### 步骤2：编译项目
```powershell
# 在Anlogic IDE中
# 1. 刷新文件列表
# 2. 添加新文件到项目
# 3. 重新运行综合
# 4. 重新运行布局布线
```

### 步骤3：烧录测试
```powershell
# 生成比特流
# 烧录到FPGA
# 使用信号发生器输入两路相位差已知的信号
```

---

## 🎯 **信号要求**

### 最佳测试条件
- **频率范围**：50kHz ~ 10MHz（推荐）
- **幅度范围**：0.5V ~ 3.3V（ADC满量程）
- **信噪比**：>40dB（置信度>150）
- **频率一致性**：两通道频率误差 <0.1%

### 边界条件
- **最低频率**：1kHz（FFT分辨率限制）
- **最低幅度**：100mV（置信度>50，可用但精度降低）
- **最低SNR**：20dB（置信度>50）

---

## 📊 **输出解读**

### 相位差输出
```verilog
phase_diff: -1800 ~ +1800
```
- 单位：0.1°
- 示例：`450` = 45.0°，`-900` = -90.0°
- 范围：-180.0° ~ +180.0°（自动回绕）

### 置信度输出
```verilog
phase_confidence: 0 ~ 255
```
| 置信度值 | 解释 | 建议 |
|---------|------|------|
| 200-255 | 极高信号强度 | 精度可达±0.05° |
| 150-199 | 高信号强度 | 精度约±0.1° |
| 100-149 | 中等信号 | 精度约±0.2° |
| 50-99   | 低信号/噪声 | 精度±0.5°，谨慎使用 |
| 0-49    | 极低信号 | 不可信，建议忽略 |

### 有效标志
```verilog
phase_valid: 1位
```
- `1`：新的相位差数据有效
- `0`：无新数据（保持上一次值）

---

## 🔧 **参数调整**

### 平滑因子（smooth_factor）
在 `signal_analyzer_top.v` 第1619行：
```verilog
.smooth_factor  (4'd8),  // 可调节：0-15
```

| 值 | 滤波强度 | 响应时间 | 抖动抑制 | 适用场景 |
|----|---------|---------|---------|---------|
| 0  | 无滤波   | 最快     | 无      | 仿真/调试 |
| 4  | 弱      | 快       | 一般    | 高SNR信号 |
| 8  | 中等    | 中等     | 良好    | **推荐默认** |
| 12 | 强      | 慢       | 优秀    | 低SNR信号 |
| 15 | 极强    | 很慢     | 极佳    | 噪声环境 |

**调整建议**：
- 稳定信号：`smooth_factor = 4`（快速响应）
- 一般应用：`smooth_factor = 8`（默认）
- 噪声环境：`smooth_factor = 12`（强滤波）

---

## 🧪 **验证测试**

### 测试1：45°相位差
```
信号源设置：
  CH1: 1kHz, 1Vpp, 0°
  CH2: 1kHz, 1Vpp, 45°

期望结果：
  phase_diff ≈ 450 (45.0°)
  phase_confidence > 150
  误差 < ±0.2°
```

### 测试2：90°相位差
```
信号源设置：
  CH1: 100kHz, 2Vpp, 0°
  CH2: 100kHz, 2Vpp, 90°

期望结果：
  phase_diff ≈ 900 (90.0°)
  phase_confidence > 200
  误差 < ±0.1°
```

### 测试3：负相位差
```
信号源设置：
  CH1: 1MHz, 1Vpp, 0°
  CH2: 1MHz, 1Vpp, -60°

期望结果：
  phase_diff ≈ -600 (-60.0°)
  误差 < ±0.1°
```

### 测试4：相位回绕
```
信号源设置：
  CH1: 1kHz, 1Vpp, +170°
  CH2: 1kHz, 1Vpp, -170°

期望结果：
  phase_diff ≈ +200 (+20.0°)
  注意：不是-340°！
```

---

## 📈 **性能优化**

### 如果资源紧张
1. **减少CORDIC迭代次数**（cordic_atan2.v 第26行）
   ```verilog
   parameter ITERATIONS = 12  // 从16改为12
   ```
   - 节省：~500 LUT
   - 代价：精度从±0.01°降至±0.1°

2. **移除IIR滤波器**（phase_diff_calc_v4.v）
   - 将 `smooth_factor` 固定为0
   - 注释掉阶段6的滤波逻辑
   - 节省：~200 LUT

3. **DSP复用**（phase_diff_calc_v4.v 第140行）
   - 将4个乘法分2拍完成
   - 节省：2个DSP（从4降至2）
   - 代价：延迟增加1个时钟周期

### 如果追求极致精度
1. **启用抛物线插值**
   - 参考报告中的"方案A"
   - 精度提升：±0.05° → ±0.01°
   - 成本：+500 LUT

2. **增加CORDIC迭代次数**
   ```verilog
   parameter ITERATIONS = 20  // 从16改为20
   ```
   - 精度提升：±0.01° → ±0.005°
   - 代价：延迟+4周期，+800 LUT

---

## ⚠️ **常见问题**

### Q1: 编译报错找不到模块
**A**: 确保将两个新文件加入到项目：
- `cordic_atan2.v`
- `phase_diff_calc_v4.v`

### Q2: 相位差一直是0
**A**: 检查以下几点：
1. 两通道信号频率是否一致
2. `ch1_fundamental_valid` 和 `ch2_fundamental_valid` 是否有效
3. `enable` 信号是否为高

### Q3: 测量值跳变严重
**A**: 信号质量问题，尝试：
1. 增大 `smooth_factor`（8 → 12）
2. 提高信号幅度
3. 检查置信度，只使用 >100 的数据

### Q4: 低频信号误差大
**A**: FFT分辨率限制：
- 4.27kHz/bin，低频信号占据的bin少
- 建议测量频率 >50kHz
- 或考虑使用时域互相关法（需IFFT）

---

## 📞 **技术支持**

详细技术文档：`高精度相位差测量实现报告.md`

关键参数位置：
- CORDIC迭代次数：`cordic_atan2.v` 第26行
- 平滑因子：`signal_analyzer_top.v` 第1619行
- 角度查找表：`cordic_atan2.v` 第46-60行

---

## ✅ **验收清单**

- [ ] 编译通过，无错误
- [ ] 资源占用可接受（LUT <10%, DSP <20%）
- [ ] 45°相位差测试，误差 <0.2°
- [ ] 90°相位差测试，误差 <0.1°
- [ ] 180°相位差测试，误差 <0.2°
- [ ] 相位回绕正确（170° → -170° = +20°）
- [ ] 置信度指示正常
- [ ] HDMI/UART输出正常

---

**祝测试顺利！** 🎉

如有问题，请查看详细报告或检查以上常见问题。
