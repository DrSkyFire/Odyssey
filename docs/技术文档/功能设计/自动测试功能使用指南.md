# 自动测试功能使用指南

**版本**: v2.0 - 可调阈值版本  
**更新日期**: 2025年11月7日

---

## 1. 功能概述

自动测试模块支持对信号参数进行自动化测试,用户可通过按键实时调整测试阈值,测试结果通过LED指示灯实时反馈。

### 1.1 测试参数
- ✅ 频率 (Hz)
- ✅ 幅度 (V)
- ✅ 占空比 (%)
- ✅ THD (总谐波失真, %)
- ✅ 相位差 (°)

### 1.2 新增特性 (v2.0)
- 🎛️ **按键可调阈值**: 无需重新编译即可修改测试条件
- 🔄 **动态配置**: 测试过程中实时调整
- 💾 **状态保持**: 阈值在测试模式退出后保持
- 🔢 **步进调整**: 预设步长,快速配置

---

## 2. 按键映射

### 2.1 模式控制
| 按键 | 功能 | 说明 |
|-----|------|------|
| **user_button[5]** | 自动测试使能 | 切换测试模式开/关 |

### 2.2 阈值调整（仅在测试模式下有效）
| 按键 | 功能 | 调整步长 | 范围 |
|-----|------|---------|------|
| **user_button[0]** | 频率目标 + | 10 Hz | 0 ~ 20 kHz |
| **user_button[1]** | 频率目标 - | 10 Hz | 0 ~ 20 kHz |
| **user_button[2]** | 幅度上限 + | 0.1 V | 0 ~ 5 V |
| **user_button[3]** | 幅度下限 - | 0.1 V | 0 ~ 5 V |
| **user_button[4]** | 占空比容差 + | 1% | 0 ~ ±20% |
| **user_button[6]** | THD阈值切换 | 循环 | 5% → 10% → 3% → 5% |

**注意**: 按键在**非测试模式**下保持原有功能(模式切换、通道选择等)。

---

## 3. 阈值配置

### 3.1 默认值 (复位后)
| 参数 | 默认值 | 容差/范围 |
|-----|--------|----------|
| **频率** | 1000 Hz | ±50 Hz |
| **幅度** | 0.5 - 4.0 V | 固定范围 |
| **占空比** | 50% | ±5% |
| **THD** | <5% | 上限 |
| **相位差** | 0° / 180° | ±10° |

### 3.2 可调范围
```
频率目标:  10 Hz ~ 20 kHz
频率容差:  固定 ±50 Hz (未来可扩展)
幅度下限:  0.1 V ~ 5 V
幅度上限:  0.1 V ~ 5 V
占空比容差: 0% ~ ±20%
THD上限:   3% / 5% / 10% (三档循环)
相位差容差: 固定 ±10° (未来可扩展)
```

---

## 4. LED指示

### 4.1 LED位定义
| LED位 | 指示内容 | 说明 |
|------|---------|------|
| **LED[0]** | 频率合格 | 1=通过, 0=失败 |
| **LED[1]** | 幅度合格 | 1=通过, 0=失败 |
| **LED[2]** | 占空比合格 | 1=通过, 0=失败 |
| **LED[3]** | THD合格 | 1=通过, 0=失败 |
| **LED[4]** | 相位差合格 | 1=通过, 0=失败 |
| **LED[5]** | 综合结果 | 全部合格时=1 ⭐ |
| **LED[6]** | 测试运行 | 1Hz闪烁 (心跳) |
| **LED[7]** | 测试模式 | 1=测试模式激活 |

### 4.2 LED状态示例
```
测试中全部合格:     11111111 (0xFF)
测试中频率失败:     11111110 (0xFE)
测试中幅度+THD失败: 11110000 (0xF0)
非测试模式:         0xxxxxxx (LED[7]=0, 其他显示系统状态)
```

---

## 5. 使用流程

### 5.1 快速开始
1. **进入测试模式**
   - 按下 `user_button[5]`
   - 观察 `LED[7]` 亮起,确认进入测试模式

2. **调整阈值** (可选)
   - 按 `user_button[0/1]` 调整频率目标
   - 按 `user_button[2/3]` 调整幅度范围
   - 按 `user_button[4]` 增加占空比容差
   - 按 `user_button[6]` 切换THD阈值 (5% / 10% / 3%)

3. **观察测试结果**
   - `LED[0-4]`: 各项参数测试结果
   - `LED[5]`: 综合判断 (全部合格时亮)
   - `LED[6]`: 闪烁表示测试运行中

4. **退出测试模式**
   - 再次按下 `user_button[5]`
   - LED恢复显示系统状态

### 5.2 典型应用场景

#### 场景1: 信号源质量检测
**目标**: 检测1kHz正弦波是否符合标准
```
1. 设置频率目标 = 1000 Hz (默认值)
2. 设置THD阈值 = 5% (默认值)
3. 连接信号源到CH1
4. 进入测试模式
5. 观察LED[0-5]:
   - LED[0]=1 → 频率合格 (950-1050 Hz)
   - LED[1]=1 → 幅度合格 (0.5-4V)
   - LED[3]=1 → THD合格 (<5%)
   - LED[5]=1 → 整体合格 ✅
```

#### 场景2: 方波占空比校准
**目标**: 检测PWM信号占空比是否为50%±2%
```
1. 按user_button[4]减小占空比容差到±2%
2. 进入测试模式
3. 观察LED[2]:
   - LED[2]=1 → 占空比48%-52%, 合格
   - LED[2]=0 → 超出范围, 需调整信号源
```

#### 场景3: 双通道相位差验证
**目标**: 检测两路同频信号是否同相
```
1. 连接两路信号到CH1和CH2
2. 进入测试模式
3. 观察LED[4]:
   - LED[4]=1 → 相位差0°±10°或180°±10%, 合格
   - LED[4]=0 → 相位偏移过大
```

---

## 6. 故障排除

### 6.1 常见问题

#### Q1: 按下测试按键LED无反应
**检查项**:
- [ ] 确认按下的是 `user_button[5]` (测试使能键)
- [ ] 检查 `LED[7]` 是否亮起 (测试模式指示)
- [ ] 确认信号已接入且 `param_valid` 有效

#### Q2: 阈值调整无效
**检查项**:
- [ ] 确认已进入测试模式 (LED[7]=1)
- [ ] 确认按下的是测试模式下的复用按键 (user_button[0-4,6])
- [ ] 检查阈值是否已到达极限值 (如频率20kHz)

#### Q3: 所有测试项都失败 (LED[0-4]=0)
**检查项**:
- [ ] 确认信号已接入ADC
- [ ] 检查 `param_valid` 信号 (参数测量完成标志)
- [ ] 验证信号幅度是否在ADC范围内 (0-5V)

#### Q4: LED[5]不亮但部分测试通过
**原因**: 综合合格需要**全部5项**都通过
**解决**:
- 检查哪一项失败 (LED[0-4]中的0)
- 调整信号源或放宽对应阈值

---

## 7. 高级配置

### 7.1 修改默认阈值
编辑 `source/source/auto_test.v` 的默认值:
```verilog
// 初始默认值
localparam FREQ_TARGET_DEFAULT  = 16'd1000;     // 默认1kHz → 修改为其他值
localparam FREQ_TOL_DEFAULT     = 16'd50;       // ±50Hz
localparam AMP_MIN_DEFAULT      = 16'd500;      // 0.5V
localparam AMP_MAX_DEFAULT      = 16'd4000;     // 4V
localparam DUTY_TARGET_DEFAULT  = 16'd500;      // 50%
localparam DUTY_TOL_DEFAULT     = 16'd50;       // ±5%
localparam THD_MAX_DEFAULT      = 16'd50;       // 5%
localparam PHASE_TOL_DEFAULT    = 16'd100;      // ±10°
```

### 7.2 修改调整步长
```verilog
// 调整步长
localparam FREQ_STEP            = 16'd10;       // 频率调整10Hz → 修改为1Hz/100Hz
localparam AMP_STEP             = 16'd100;      // 幅度调整0.1V
localparam DUTY_STEP            = 16'd10;       // 占空比调整1%
localparam THD_STEP             = 16'd5;        // THD调整0.5%
```

### 7.3 扩展功能建议
- [ ] 添加UART输出当前阈值设置
- [ ] 保存阈值到非易失存储器 (Flash)
- [ ] 增加相位差容差可调功能
- [ ] 添加频率容差可调功能
- [ ] 支持测试序列 (批量测试多组参数)

---

## 8. 技术细节

### 8.1 阈值边界计算
```verilog
// 频率范围
freq_min = freq_target - freq_tolerance
freq_max = freq_target + freq_tolerance

// 占空比范围
duty_min = duty_target - duty_tolerance
duty_max = duty_target + duty_tolerance

// 幅度范围
amp_min ~ amp_max (独立设置)
```

### 8.2 相位差判断逻辑
```verilog
// 同相: 0°±tolerance
(phase_diff <= phase_tolerance) || 
(phase_diff >= (3600 - phase_tolerance))

// 反相: 180°±tolerance
(phase_diff >= (1800 - phase_tolerance)) && 
(phase_diff <= (1800 + phase_tolerance))
```

### 8.3 参数单位换算
| 参数 | 寄存器格式 | 实际值换算 |
|-----|-----------|----------|
| **频率** | 16位无符号 | 1 = 1 Hz |
| **幅度** | 16位无符号 | 1000 = 1 V |
| **占空比** | 16位无符号 | 1000 = 100% |
| **THD** | 16位无符号 | 1000 = 100% |
| **相位差** | 16位有符号 | 3600 = 360° |

---

## 9. 更新日志

### v2.0 (2025-11-07)
- ✅ 新增按键阈值调整功能
- ✅ 6个可配置参数 (频率、幅度、占空比、THD)
- ✅ 按键复用设计 (测试模式下自动切换功能)
- ✅ 动态阈值边界计算

### v1.0 (2025-10-21)
- ✅ 基础自动测试功能
- ✅ 固定阈值参数判断
- ✅ LED结果指示

---

## 10. 参考资料

- [相位差测量快速使用指南](相位差测量快速使用指南.md)
- [信号参数测量优化总结](signal_measure_optimization_summary.md)
- [AI自动识别模块检查报告](AI自动识别模块检查报告.md)

---

**文档版本**: 1.0  
**作者**: GitHub Copilot  
**审核**: 待用户测试反馈
