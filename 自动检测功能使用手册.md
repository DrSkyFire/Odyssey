# 自动检测功能使用手册

## 📋 功能概述

自动检测功能采用**层级化设计**，可以精细调整频率、幅度、占空比和THD的上下限阈值，并实时判断测试信号是否合格。

---

## 🎮 按键操作指南

### 进入/退出自动测试模式

**button[5]** - 切换自动测试模式
- 按一次进入自动测试模式
- 再按一次退出自动测试模式

### 第一层：参数选择界面

进入自动测试模式后，显示参数选择界面：

| 按键 | 功能 | 说明 |
|------|------|------|
| button[0] | 进入频率调整 | 调整频率上下限 |
| button[1] | 进入幅度调整 | 调整幅度上下限 |
| button[2] | 进入占空比调整 | 调整占空比上下限 |
| button[3] | 进入THD调整 | 调整THD上限 |
| button[5] | 退出自动测试 | 返回正常模式 |
| button[7] | 退出自动测试 | 返回正常模式（备用） |

### 第二层：参数调整界面

选择任一参数后，进入参数调整界面：

| 按键 | 功能 | 说明 |
|------|------|------|
| button[0] | 下限减少 | 减小下限值 |
| button[1] | 下限增加 | 增大下限值 |
| button[2] | 上限减少 | 减小上限值 |
| button[3] | 上限增加 | 增大上限值 |
| button[4] | 步进切换 | 细调→中调→粗调循环 |
| button[6] | 恢复默认 | 恢复当前参数默认值 |
| button[7] | 返回菜单 | 返回参数选择界面 |

**注意**：THD只有上限，没有下限。调整THD时，使用button[2]/[3]调整上限。

---

## ⚙️ 参数配置

### 默认阈值

| 参数 | 默认目标值 | 默认容差 | 下限 | 上限 |
|------|----------|---------|------|------|
| 频率 | 100kHz | ±5kHz | 95kHz | 105kHz |
| 幅度 | 3V | ±500mV | 2.5V | 3.5V |
| 占空比 | 60% | ±5% | 55% | 65% |
| THD | - | - | - | 60% |

### 步进模式

每个参数支持3档步进（按button[4]切换）：

| 参数 | 细调（档0） | 中调（档1） | 粗调（档2） |
|------|-----------|-----------|-----------|
| 频率 | 1Hz | 100Hz | 100kHz |
| 幅度 | 1mV | 100mV | 1V |
| 占空比 | 0.1% | 1% | 10% |
| THD | 0.1% | 1% | 10% |

### 参数范围限制

| 参数 | 最小值 | 最大值 | 单位 |
|------|-------|-------|------|
| 频率 | 0Hz | 500kHz | Hz |
| 幅度 | 0mV | 5000mV | mV (5V) |
| 占空比 | 0% | 100% | % |
| THD | 0% | 100% | % |

---

## 💡 使用示例

### 示例1：调整频率阈值到98kHz-102kHz

1. 按button[5]进入自动测试模式
2. 按button[0]进入频率调整界面
3. 按button[4]切换到粗调模式（100kHz步进）
4. 观察当前值（默认95kHz-105kHz）
5. 按button[0]将下限从95kHz调整到0
6. 按button[1]将下限从0调整到98kHz（需要切换到中调或细调）
7. 按button[2]将上限从105kHz调整到100kHz
8. 按button[3]将上限从100kHz调整到102kHz
9. 按button[7]返回参数选择界面

### 示例2：快速恢复默认值

在任意参数调整界面：
1. 按button[6]恢复当前参数默认值
2. 继续调整或按button[7]返回

### 示例3：退出自动测试模式

方法1：在参数选择界面按button[5]
方法2：在参数选择界面按button[7]
方法3：在参数调整界面按button[7]返回，再按button[5]

---

## 📺 HDMI显示

屏幕右下角实时显示当前调整状态：

```
┌─────────────────────────┐
│ [自动测试模式]          │
│ 参数选择界面            │
│ [0]频率 [1]幅度         │
│ [2]占空比 [3]THD        │
│ [5]退出 [7]退出         │
└─────────────────────────┘
```

进入参数调整后：

```
┌─────────────────────────┐
│ [频率调整]              │
│ 下限: 95000 Hz          │
│   [0]减少 [1]增加       │
│ 上限: 105000 Hz         │
│   [2]减少 [3]增加       │
│ 步进: 细调(1Hz)         │
│   [4]切换步进           │
│ [6]恢复默认 [7]返回     │
└─────────────────────────┘
```

---

## 🚦 LED指示

LED[7:0]功能分配：

| LED | 功能 | 说明 |
|-----|------|------|
| LED[0] | 频率测试结果 | 亮=合格, 灭=不合格 |
| LED[1] | 幅度测试结果 | 亮=合格, 灭=不合格 |
| LED[2] | 占空比测试结果 | 亮=合格, 灭=不合格 |
| LED[3] | THD测试结果 | 亮=合格, 灭=不合格 |
| LED[4] | 相位差测试结果 | 预留（暂不使用） |
| LED[5] | 综合测试结果 | 全部合格时亮 |
| LED[6] | （未使用） | - |
| LED[7] | （未使用） | - |

---

## ⚠️ 注意事项

### 操作建议

1. **逐步调整**：使用细调模式精确调整，使用粗调模式快速定位
2. **确认范围**：调整前先了解当前值，避免调整过度
3. **测试验证**：调整后观察LED指示，确认测试结果是否符合预期
4. **恢复默认**：如果调整错误，使用button[6]快速恢复

### 常见问题

**Q：步进模式如何生效？**
A：切换步进模式后，按下调整按键立即生效新步进值。

**Q：下限能否超过上限？**
A：不能。代码有保护逻辑，确保下限<上限。

**Q：THD为什么没有下限？**
A：THD（总谐波失真）只关心上限，数值越小越好，所以只需设置最大允许值。

**Q：退出自动测试后，阈值会保留吗？**
A：**不会**。复位后恢复默认值。如需保留，建议记录当前设置。

---

## 🔧 高级功能

### 批量测试流程

1. 设置合适的阈值范围
2. 连接被测信号
3. 观察LED[5]综合测试结果
4. 根据LED[0-3]定位不合格项
5. 调整阈值或改善信号质量

### 参数范围校准

如果信号特性特殊，可以调整阈值范围：

```
示例：测试50kHz ±1kHz信号
1. 进入频率调整
2. 下限设为49kHz
3. 上限设为51kHz
4. 返回菜单，连接信号测试
```

---

## 📊 技术细节

### 层级状态机

```
一级状态：auto_test_enable
  ├─ 0：正常模式
  └─ 1：自动测试模式
      │
      二级状态：param_adjust_mode
        ├─ ADJUST_IDLE (0)：参数选择界面
        ├─ ADJUST_FREQ (1)：频率调整界面
        ├─ ADJUST_AMP (2)：幅度调整界面
        ├─ ADJUST_DUTY (3)：占空比调整界面
        └─ ADJUST_THD (4)：THD调整界面
```

### 测试判断逻辑

```verilog
// 频率测试
freq_pass = (freq >= freq_min) && (freq <= freq_max);

// 幅度测试
amp_pass = (amplitude >= amp_min) && (amplitude <= amp_max);

// 占空比测试
duty_pass = (duty >= duty_min) && (duty <= duty_max);

// THD测试
thd_pass = (thd <= thd_max);

// 综合判断
all_pass = freq_pass && amp_pass && duty_pass && thd_pass;
```

---

## 📝 版本信息

- **版本**: v2.0
- **日期**: 2025年11月7日
- **更新内容**:
  - 重构为层级化设计
  - 支持上下限独立调整
  - 添加3档步进模式
  - 移除内部测试信号功能
  - button[7]专用于自动测试
  - 增加HDMI显示支持

---

## 🎯 快速参考

### 常用操作速查

| 操作 | 按键序列 |
|------|---------|
| 进入自动测试 | [5] |
| 调整频率下限 | [5] → [0] → [0]/[1] |
| 调整频率上限 | [5] → [0] → [2]/[3] |
| 切换步进 | [5] → [0] → [4] |
| 恢复默认频率 | [5] → [0] → [6] |
| 退出自动测试 | [5] → [7] 或 [5] → [5] |

---

**祝使用愉快！如有问题请参考本手册或联系技术支持。**
