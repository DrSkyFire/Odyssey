# FFT诊断检查清单

## 问题现象
- 频率测量完全错误（偏差数十倍到数百倍）
- 幅度测量严重偏低（只有设定值的4%-40%）
- THD测量恒为0%
- 数据剧烈闪烁

## 根本原因分析

### 最可能原因：FFT模块未运行

代码显示FFT启动条件：
```verilog
assign fft_start = run_flag && (work_mode == 2'd1);
```

**如果 `work_mode != 1`，则：**
- FFT完全不工作
- spectrum_valid = 0
- spectrum_data = 0 或垃圾数据
- 所有FFT相关功能失效

## 紧急检查步骤

### 步骤1: 确认工作模式 ⚠️ 最重要！

**问题**: 你的系统当前是什么模式？

| 模式值 | 含义 | FFT状态 | 测量功能 |
|--------|------|---------|----------|
| work_mode = 0 | 示波器模式 | ❌ 关闭 | 只有时域（过零/幅度/占空比） |
| work_mode = 1 | FFT频谱模式 | ✅ 运行 | 时域+FFT（全功能） |
| work_mode = 2/3 | 其他模式 | ❌ 关闭 | 取决于具体实现 |

**检查方法**:
- [ ] 查看开发板上的模式指示灯
- [ ] 检查按键/拨码开关设置
- [ ] 查看HDMI显示屏幕（是否显示频谱图）

### 步骤2: 检查运行状态

**问题**: `run_flag` 是否为高？

**检查方法**:
- [ ] 系统是否按下"运行/启动"按钮
- [ ] LED指示灯是否显示运行状态
- [ ] 是否有"暂停"状态

### 步骤3: 检查时域测量

**观察**: 占空比有测量值（虽然不准），说明：
- ✅ ADC采样正常
- ✅ sample_valid信号有效
- ✅ 时钟系统正常
- ❌ 但FFT数据可能无效

### 步骤4: 检查FFT输出信号

如果可以用逻辑分析仪/ILA，检查：
- `ch1_spectrum_valid` 是否有周期性脉冲？
- `ch1_spectrum_addr` 是否从0递增到4095（8192/2）？
- `ch1_spectrum_magnitude` 是否有非零数据？

## 解决方案

### 方案1: 切换到FFT模式（最可能）

**操作**:
1. 找到模式切换按钮/开关
2. 切换到"FFT频谱分析"模式
3. 确认屏幕显示频谱图（而不是波形图）
4. 重新测试

**预期结果**:
- 频率测量应该立即正常
- 幅度测量应该准确
- THD应该有非零值

---

### 方案2: 检查FFT模块例化（代码问题）

如果模式已经正确，检查代码中FFT模块连接：

```verilog
// 在 signal_analyzer_top.v 中
// 检查这个模块是否被正确例化和连接
fft_processor u_fft_processor (
    .clk                    (clk_100m),
    .rst_n                  (rst_n),
    
    // ⚠️ 检查这个信号！
    .fft_enable             (fft_start),  
    
    // 频谱输出
    .ch1_spectrum_data      (ch1_spectrum_magnitude),
    .ch1_spectrum_addr      (ch1_spectrum_wr_addr),
    .ch1_spectrum_valid     (ch1_spectrum_valid),
    ...
);
```

---

### 方案3: 强制FFT运行（调试用）

**临时修改**（仅用于调试）:
```verilog
// 原代码
assign fft_start = run_flag && (work_mode == 2'd1);

// 修改为（强制FFT运行）
assign fft_start = 1'b1;  // 或 assign fft_start = run_flag;
```

**注意**: 这只是调试用，不是最终方案！

---

## 其他可能的问题

### 问题2: 采样时钟频率错误

**症状**: 频率测量偏差巨大（但稳定）

**检查**: 采样时钟是否确实是35MHz？

代码中：
```verilog
localparam FREQ_RES = 4272;  // 35MHz/8192
```

如果采样时钟不是35MHz，比如是70MHz，则：
- 实际频率分辨率 = 70MHz/8192 = 8544 Hz/bin
- 测量值会偏差2倍

**解决**: 
1. 用示波器测量ADC时钟频率
2. 如果不是35MHz，修改 `FREQ_RES` 参数

---

### 问题3: 占空比自适应阈值异常

**症状**: 占空比测量严重偏低

**分析**:
- 20% → 21.8% ✅ 基本正确
- 50% → 22.4% ❌ 严重错误
- 80% → 41.9% ❌ 严重错误

**规律**: 测量值似乎是 **设定值的一半左右**

**可能原因**:
1. 自适应阈值计算错误（总是偏高）
2. 迟滞比较器状态机卡住
3. 高电平计数逻辑错误

**临时验证**:
测试一个标准50%方波，幅度3.3Vpp，无偏移：
- 如果测量值~25%，说明高电平计数只计了一半

---

### 问题4: 幅度测量偏低

**症状**: 测量值只有设定值的4%-40%

**可能原因**:
1. FFT幅度数据异常（因为FFT未运行）
2. ADC增益配置错误
3. 数据右移了几位

**检查**: 如果切换到FFT模式后幅度正常，说明是问题1。

---

## 测试优先级

### 🔥 立即测试（1分钟）

1. **检查并切换到FFT模式**
   - [ ] 确认work_mode = 1
   - [ ] 屏幕显示频谱图
   - [ ] 重新测试1kHz正弦波频率

   **预期**: 如果FFT开始工作，频率应该显示~1000 Hz

---

### 📊 第二轮测试（5分钟）

如果FFT模式已正确：

2. **测试简单信号**
   - [ ] 1kHz正弦波，1Vpp
   - [ ] 记录频率、幅度、THD
   
   **预期值**:
   - 频率: 996-1004 Hz (±0.4%)
   - 幅度: 900-1100 mV (±10%)
   - THD: <5%

3. **测试占空比**
   - [ ] 1kHz方波，50%，3.3Vpp
   - [ ] 记录占空比
   
   **预期值**: 48-52%

---

### 🔧 如果仍然异常

4. **检查时钟配置**
   - [ ] 用示波器测量ADC时钟频率
   - [ ] 确认是否35MHz
   - [ ] 如不是，计算正确的FREQ_RES

5. **检查信号连接**
   - [ ] ADC输出是否正确连接
   - [ ] 信号幅度是否在0-3.3V范围内
   - [ ] 地线是否良好

---

## 报告格式

请按以下格式反馈：

```
【工作模式检查】
- 当前模式: work_mode = ?
- 屏幕显示: (频谱图/波形图/其他)
- run_flag状态: (运行/停止)

【切换到FFT模式后测试】
测试信号: 1kHz正弦波, 1Vpp
- 频率测量: _____ Hz
- 幅度测量: _____ mV
- THD测量: _____ %
- 数据稳定性: (稳定/闪烁)

【占空比测试】
测试信号: 1kHz方波, 50%, 3.3Vpp
- 占空比测量: _____ %
```

---

## 总结

**最可能的问题**: 系统不在FFT模式，FFT模块未运行

**最快的解决方案**: 切换到FFT频谱分析模式

**验证方法**: 
- 屏幕应显示频谱图（不是波形图）
- 频率测量应立即准确
- THD应有非零值

如果切换模式后问题依然存在，需要进一步检查FFT模块连接和时钟配置。
