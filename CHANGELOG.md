# 更新日志 / CHANGELOG

本文档记录Odyssey项目的所有重要版本更新。

---

## [v2.0] - 2025年11月 - 时序优化版 ⚡

### 🎯 重大突破

#### 时序优化成果
- **ADC时钟域**（35MHz）：WNS -11.889ns → **+2.5ns** ✅
- **HDMI时钟域**（74.25MHz）：WNS -5.114ns → **+0.8ns** ✅
- **系统时钟域**（100MHz）：WNS -3.489ns → **+1.2ns** ✅
- **所有时钟域WNS全部转正，系统稳定运行** 🎉

#### 性能提升
| 指标 | v1.5 | v2.0 | 提升幅度 |
|------|------|------|---------|
| FFT吞吐率 | 9 FFT/s | 12.2 FFT/s | **+35%** |
| 参数更新率 | 5 Hz | 10 Hz | **+100%** |
| 系统稳定性 | 偶发错误 | 48小时无错误 | **质的飞跃** |

### ✨ 新增功能

#### 1. 锁相放大HDMI显示窗口
- 位置：左上角浮窗（不遮挡主要内容）
- 显示内容：
  - 参考频率（6位数字，单位Hz）
  - 工作模式（DDS/External/Auto）
  - 解调幅度（4位数字，单位mV）
  - 相位角度（3位数字+小数点，单位°）
  - 信噪比（2位数字，单位dB）
  - 锁定状态（LOCKED绿色 / UNLOCK红色）
- 颜色方案：深绿色背景+亮绿色文字

#### 2. 自动测试HDMI显示优化
- **单位显示**：频率(Hz)、幅度(mV)、占空比(%)、THD(%)
- **前导零抑制**：999Hz显示为"999"而非"0999"
- **小数点对齐**：占空比和THD显示"60.0%"格式
- **步进模式**：细调/中调/粗调三档切换

#### 3. SNR实时估算显示
- 范围：0-60dB（7档查找表）
- 更新率：10Hz
- 显示位置：锁相放大窗口

### 🔧 核心优化技术

#### 技术1：查找表（LUT）替代除法 ⭐⭐⭐
```verilog
// 优化前：除法运算延迟>40ns（导致35MHz时钟违例）
snr_estimate <= (signal_power / noise_power) << 4;

// 优化后：7档查找表延迟<5ns
if (ch1_locked) begin
    if (ch1_magnitude > 24'h100000)      snr_estimate <= 16'h3C00;  // 60dB
    else if (ch1_magnitude > 24'h010000) snr_estimate <= 16'h3200;  // 50dB
    // ... 7档分级
end
```
- **效果**：时序改善14.4ns，节省约1500 LUT
- **模块**：`weak_signal_detector.v`

#### 技术2：BCD场消隐期预计算 ⭐⭐⭐
```verilog
// 在HDMI场消隐期间（h_cnt=210-250）完成所有除法/转换
always @(posedge clk_hdmi_pixel) begin
    if (h_cnt == 210) ch1_freq_bcd    <= binary_to_bcd(ch1_freq);
    if (h_cnt == 220) ch1_amplitude_bcd <= binary_to_bcd(ch1_amplitude);
    // ... 其他参数
end

// 显示期间直接使用预计算结果（无除法，延迟<2ns）
char_code <= digit_to_ascii(ch1_freq_bcd[digit_index]);
```
- **效果**：时序改善5.9ns，避免HDMI时钟域违例
- **模块**：`hdmi_display_ctrl.v`

#### 技术3：流水线设计 ⭐⭐
```verilog
// FFT控制器3级流水线
always @(posedge clk_100m) begin
    fft_din_d1 <= fifo_dout;              // Stage 1: 读取
    fft_din_d2 <= fft_din_d1 * hann_coef;  // Stage 2: 加窗
    fft_din    <= fft_din_d2;              // Stage 3: 输入FFT
end
```
- **效果**：吞吐率提升35%
- **模块**：`dual_channel_fft_controller.v`

### 🐛 Bug修复

#### 严重Bug（影响功能）
1. **SNR计算时序违例**
   - 位置：`weak_signal_detector.v` Line 456
   - 现象：ADC时钟域WNS -11.889ns，导致系统不稳定
   - 原因：除法运算延迟过长
   - 修复：改用7档查找表
   - 状态：✅ 已修复

2. **自动测试输入信号未定义**
   - 位置：`signal_analyzer_top.v` Line 2345
   - 现象：auto_test模块输入信号悬空，导致随机行为
   - 原因：顶层模块端口连接遗漏
   - 修复：添加完整端口连接
   - 状态：✅ 已修复

#### 显示Bug（影响体验）
3. **频率单位显示缺失**
   - 位置：`hdmi_display_ctrl.v` 参数表格部分
   - 现象：频率显示"100000"而非"100000 Hz"
   - 修复：添加单位字符串拼接
   - 状态：✅ 已修复

4. **占空比前导零未抑制**
   - 位置：`hdmi_display_ctrl.v` BCD显示部分
   - 现象：60.0%显示为"060.0%"
   - 修复：添加前导零抑制逻辑
   - 状态：✅ 已修复

### 📊 资源使用变化

| 资源 | v1.5 | v2.0 | 变化 |
|------|------|------|------|
| LUT4 | 46331 / 49152 (94.3%) | 44831 / 49152 (91.2%) | **-1500 LUT** |
| RAM | 180KB / 468KB (38.4%) | 180KB / 468KB (38.4%) | 不变 |
| DSP | 32 / 32 (100%) | 32 / 32 (100%) | 不变 |
| PLL | 2 / 4 (50%) | 2 / 4 (50%) | 不变 |

**优化说明**：通过查找表替代除法，节省约1500 LUT，资源利用率从94.3%降至91.2%。

### 📝 文档更新

- ✅ [ADC时序违例修复报告.md](../ADC时序违例修复报告.md) - 详细优化过程
- ✅ [时序优化总结.md](../时序优化总结.md) - 所有时钟域优化汇总
- ✅ [锁相放大HDMI显示完成报告.md](../锁相放大HDMI显示完成报告.md) - HDMI窗口设计
- ✅ [自动测试HDMI显示格式优化报告.md](../自动测试HDMI显示格式优化报告.md) - 显示格式优化

### 🎯 测试验证

#### 时序测试
- ✅ 所有时钟域WNS≥0（满足时序要求）
- ✅ 连续运行48小时无错误
- ✅ 温度循环测试（25°C-50°C）无异常

#### 功能测试
- ✅ 参数测量精度：频率<0.1%，幅度±1%，占空比±0.1%
- ✅ 锁相放大：检测灵敏度<10mV，SNR改善35dB
- ✅ 自动测试：判断延迟<10ms，误判率<0.1%

---

## [v1.5] - 2025年10月 - 功能完善版

### ✨ 新增功能

1. **微弱信号检测模块（数字锁相放大）**
   - DDS参考源（32位NCO，0.01Hz分辨率）
   - 正交解调（I/Q双路混频）
   - CIC低通滤波（256阶，等效带宽<1Hz）
   - CORDIC算法（幅度/相位解调）
   - 检测灵敏度：<10mV

2. **自动测试模块**
   - 层级化交互设计（二级菜单）
   - 4项参数阈值判断（频率/幅度/占空比/THD）
   - 3档步进调整（细调/中调/粗调）
   - LED实时指示（8位LED）

3. **相位差测量（双通道）**
   - 时域过零检测算法
   - 精度：<1°
   - 范围：-180° ~ +180°

4. **UART调试输出**
   - 波特率：115200bps
   - 格式：8N1
   - 内容：所有参数实时输出

### 🔧 优化改进

1. **FFT点数升级**
   - 1024点 → 8192点
   - 频率分辨率：34.18kHz → 4.27kHz

2. **参数测量精度提升**
   - 频率：FFT峰值插值（10倍分辨率提升）
   - 占空比：自适应阈值+迟滞比较（抗噪声）
   - THD：2-5次谐波搜索容差优化

3. **HDMI显示布局优化**
   - 添加锁相放大窗口预留区域
   - 优化参数表格排版
   - 添加自动测试界面

### 📝 文档新增

- [高精度双通道相位差测量-实现总结.md](../高精度双通道相位差测量-实现总结.md)
- [时域相位差测量方案.md](../时域相位差测量方案.md)
- [自动检测功能层级设计方案.md](../自动检测功能层级设计方案.md)

---

## [v1.0] - 2025年9月 - 初始版本

### ✨ 核心功能

1. **双通道ADC采集**
   - 芯片：MS9280
   - 采样率：35MSPS（每通道）
   - 分辨率：10位
   - 接口：异步FIFO缓冲

2. **1024点FFT频谱分析**
   - 算法：基-2 FFT
   - 窗函数：汉宁窗
   - 频率分辨率：34.18kHz
   - 动态范围：>60dB

3. **参数测量（4项）**
   - 频率：FFT峰值检测
   - 幅度：峰峰值测量
   - 占空比：固定阈值检测
   - THD：2-5次谐波分析

4. **HDMI显示（720p@60Hz）**
   - 分辨率：1280×720
   - 驱动芯片：MS7210
   - 显示内容：参数表格+频谱图

### 🎯 设计目标

- 实现基础信号分析功能
- 验证FPGA架构可行性
- 建立开发流程

### ⚠️ 已知问题

- ❌ 时序违例（ADC时钟域WNS -11.889ns）
- ❌ FFT点数较少（频率分辨率不足）
- ❌ 占空比测量受噪声影响大
- ⚠️ 无微弱信号检测功能

---

## 🗓️ 版本规划

### [v2.1] - 规划中
- [ ] 添加波形显示功能（类似示波器）
- [ ] 优化FFT窗口显示（对数坐标+颜色映射）
- [ ] 添加数据存储功能（SD卡/Flash）
- [ ] 扩展到4通道（需要更大FPGA）

### [v3.0] - 远期规划
- [ ] 添加触摸屏支持（替代按键）
- [ ] 网络接口（TCP/IP远程控制）
- [ ] 升级ADC到125MSPS
- [ ] 添加信号发生器功能

---

## 📊 版本对比总结

| 功能 | v1.0 | v1.5 | v2.0 |
|------|------|------|------|
| FFT点数 | 1024 | 8192 | 8192 |
| 参数种类 | 4项 | 6项 | 6项 |
| 微弱信号检测 | ❌ | ✅ | ✅ |
| 自动测试 | ❌ | ✅ | ✅ |
| 时序状态 | ❌ 违例 | ⚠️ 违例 | ✅ 全部转正 |
| 性能（FFT吞吐率） | 6 FFT/s | 9 FFT/s | 12.2 FFT/s |
| 资源利用率 | 85% | 94% | 91% |
| 稳定性 | ⭐⭐ | ⭐⭐⭐ | ⭐⭐⭐⭐⭐ |

---

## 📝 贡献者

- **DrSkyFire** - 项目负责人，核心开发

---

## 📄 许可证

本项目采用 [MIT License](../LICENSE)

---

<div align="center">

**Odyssey Project Changelog**  
**最后更新：2025年11月7日**  
**© 2025 DrSkyFire**

</div>
