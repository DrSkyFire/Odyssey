# 时序优化方案

## 当前时序状态 (极其严重)

### 违例汇总
- **clk_100m (10ns周期)**: WNS = -72.949ns, 实际需要 82.949ns
  - 失败路径: 130条 (共32935个端点)
  - TNS: -7013.286ns
  - 实际可达频率: **12.06 MHz** (要求100MHz)
  
- **clk_hdmi_pixel (6.734ns周期)**: WNS = -2.688ns
  - 失败路径: 61条 (共1290个端点)
  - TNS: -48.744ns

### 关键路径分析
**最差路径** (WNS = -72.949ns):
```
起点: u_param_measure_ch1/harmonic_power[6]
终点: u_param_measure_ch1/thd_instant[0]

路径组成:
1. 乘法运算 (harmonic_power * 1000): ~20ns
2. 左移运算 (<< 10): ~5ns
3. 除法运算 (/ fundamental_power): ~50ns  ← 主要瓶颈
4. 比较运算 (> 1000): ~3ns
5. 滑动平均更新: ~5ns

总延迟: ~83ns (超出10ns周期 73ns!)
```

**根本原因**: 
- 除法器生成了极深的组合逻辑链(34级加减法器级联)
- 单周期完成 `((a*1000)<<10) / ((b<<10)+1)` 运算是不可能的

---

## 优化方案对比

### 方案1: 流水线化除法 ⭐⭐⭐⭐⭐ (强烈推荐)

**原理**: 将除法运算分成多个时钟周期完成

**实现**:
```verilog
// 状态机: IDLE → MUL → DIV_STAGE1 → DIV_STAGE2 → AVG → DONE
// 周期1: numerator <= harmonic_power * 1000
// 周期2: denominator <= fundamental_power << 10
// 周期3: thd_instant <= numerator / denominator
// 周期4: 更新滑动平均
```

**优势**:
- ✅ 彻底解决时序问题(每级 < 10ns)
- ✅ 精度不变
- ✅ 资源占用不变
- ⚠️ 结果延迟增加3-4个时钟周期(但更新率仍为10Hz,用户无感知)

**预期效果**: WNS改善 **60-70ns**

---

### 方案2: 使用IP核除法器 ⭐⭐⭐⭐

**原理**: 使用FPGA厂商提供的流水线除法器IP

**实现**:
```
创建32位除法器IP核:
- 输入: dividend[41:0], divisor[41:0]
- 输出: quotient[41:0]
- 流水线级数: 4-8级
- 延迟: 4-8个时钟周期
```

**优势**:
- ✅ 自动优化的流水线结构
- ✅ 时序收敛好
- ✅ 可配置延迟和精度
- ⚠️ 占用DSP/乘法器资源
- ⚠️ 需要IP核配置

**预期效果**: WNS改善 **65-75ns**

---

### 方案3: 降低计算精度 ⭐⭐⭐

**原理**: 减少位宽,简化除法

**实现**:
```verilog
// 方案A: 去掉左移10位的精度增强
thd_instant <= (harmonic_power * 1000) / (fundamental_power + 1);

// 方案B: 改用查找表(LUT)近似
// 预计算 1000/x 的值,x=1-4096
wire [15:0] inv_table [0:4095];  // 存储 1000/x
thd_instant <= (harmonic_power * inv_table[fundamental_power[11:0]]) >> 10;
```

**优势**:
- ✅ 立即见效
- ✅ 资源占用可能减少
- ❌ 精度损失
- ❌ LUT方案占用大量BRAM

**预期效果**: WNS改善 **30-40ns** (可能仍不够)

---

### 方案4: 降低时钟频率 ⭐⭐

**原理**: 将参数测量模块运行在更低的时钟频率

**实现**:
```verilog
// 使用clk_10m (100ns周期)代替clk_100m
signal_parameter_measure #(...) u_param_measure_ch1 (
    .clk(clk_10m),  // 改为10MHz
    ...
);
```

**优势**:
- ✅ 无需修改算法
- ✅ 实施简单
- ❌ 测量响应速度降低10倍(1s → 10s)
- ❌ 用户体验严重下降

**预期效果**: 时序问题解决,但不推荐

---

### 方案5: 简化算法 ⭐⭐⭐⭐

**原理**: 用近似算法替代精确除法

**实现A - 牛顿迭代法近似除法**:
```verilog
// 计算 a/b ≈ a * (1/b)
// 用牛顿迭代求 1/b:
// x[n+1] = x[n] * (2 - b*x[n])
// 3次迭代即可达到足够精度
```

**实现B - 对数域计算**:
```verilog
// THD = harmonic / fundamental
// log(THD) = log(harmonic) - log(fundamental)
// 使用查找表存储log值,减法后再exp还原
```

**优势**:
- ✅ 时序好于直接除法
- ✅ 可流水线化
- ⚠️ 算法复杂度增加
- ⚠️ 精度需要权衡

**预期效果**: WNS改善 **40-50ns**

---

## 推荐实施方案

### 阶段1: 快速修复 (立即实施)

**1. 占空比和THD计算改为4级流水线**
```verilog
// 周期1: 计算分子
stage1_numerator <= (high_cnt * 1000) << 10;

// 周期2: 计算分母  
stage2_denominator <= (total_cnt << 10) + 1;

// 周期3: 执行除法
stage3_quotient <= stage1_numerator / stage2_denominator;

// 周期4: 更新滑动平均
duty_instant <= stage3_quotient;
```

**预期改善**: clk_100m WNS: -72.949ns → **-10ns左右**

---

### 阶段2: 彻底解决 (如果阶段1不够)

**2. 使用IP核除法器**
- 配置: 42位/42位除法器, 8级流水线
- 替换手工除法运算
- 优点: 时序收敛保证

**预期改善**: clk_100m WNS: **正值** (时序收敛)

---

### 阶段3: 优化HDMI路径 (独立优化)

**3. HDMI像素时钟路径优化**
- 已完成: spectrum_addr计算优化
- 待优化: char_code MUX逻辑(已改为寄存器,待验证)

**预期改善**: clk_hdmi_pixel WNS: -2.688ns → **正值**

---

## 资源占用预估

| 方案 | LUT增加 | FF增加 | BRAM增加 | DSP增加 |
|------|---------|---------|----------|---------|
| 流水线化(手工) | +200 | +300 | 0 | 0 |
| IP核除法器 | +100 | +200 | 0 | +2 |
| 查找表方案 | +500 | +50 | +2 | 0 |

---

## 实施计划

### 第1步: 流水线化除法运算 (2小时)
- [ ] 修改signal_parameter_measure.v
- [ ] 添加4级流水线状态机
- [ ] 分离乘法、除法、平均运算
- [ ] 编译验证

### 第2步: 时序验证 (0.5小时)
- [ ] 运行完整编译流程
- [ ] 检查report_timing
- [ ] 确认WNS < 0.5ns

### 第3步: 功能验证 (可选)
- [ ] 仿真测试流水线正确性
- [ ] 硬件测试测量精度

---

## 预期最终时序

### 优化后目标
- clk_100m: WNS > 0.5ns (100MHz收敛)
- clk_hdmi_pixel: WNS > 0.5ns (148.5MHz收敛)
- clk_adc: WNS > 5ns (已满足)
- clk_10m: WNS > 50ns (已满足)

### 是否需要立即实施?

**建议**: 先实施阶段1的流水线化方案(手工编码),因为:
1. 不依赖IP核,可移植性好
2. 资源占用小
3. 可以完全解决问题
4. 实施时间短(2小时内完成)

如果您同意,我立即开始修改代码!
