# THD修复v8 - DC偏置去除（紧急）

## 🔴 重大Bug发现！

### 观察现象
- ✅ **频谱bin 0处有巨大峰值**（远超100%）
- ✅ **始终存在，不抖动**
- ✅ **无论是否有输入都存在**
- ✅ 修复LUT后，THD反而变成0.0%了

### 🐞 Bug 9：ADC数据未去除DC偏置

## 根本原因

**ADC数据处理错误**！

### 错误代码（dual_channel_fft_controller.v 第141行）

```verilog
// ❌ 错误：直接符号扩展最高位
assign adc_signed = {{6{data_buffer[15]}}, data_buffer[15:6]};
```

**问题**：
- ADC输出是**无符号数**：0-1023
- 理想0V对应：512（中点）
- **但代码没有减去512！**
- 直接符号扩展，导致：
  - ADC=512 → adc_signed=512（应该是0）
  - ADC=600 → adc_signed=600（应该是+88）
  - ADC=400 → adc_signed=400（应该是-112）

### FFT输入包含巨大DC偏置

**示例**：
```
ADC数据：512, 612, 412, 512, 612, ...（1MHz正弦波，幅度100）
应该是：  0,  100, -100,   0,  100, ...
实际是：512,  612,  412, 512,  612, ...（带512偏置！）

FFT结果：
  bin 0 (DC): 512 ← 巨大的DC分量！
  bin 234 (1MHz基波): 100 ← 实际信号
  
FFT幅度：
  DC >> 基波，bin 0的峰值远超实际信号
```

---

## 为什么导致THD=0.0%？

### 修复LUT前（显示99.9%）

```
fft_max_amp = 512（DC分量，从bin 1开始搜索被跳过）
实际检测到的是DC旁边的"小峰"（泄漏）
thd_lut_index = 1（错误）
THD被放大 → 99.9%
```

### 修复LUT后（显示0.0%）

```
fft_max_amp可能仍然检测到DC泄漏或噪声
但由于LUT修正了小幅度信号的计算
如果基波幅度很小（<100），可能不满足触发条件：
  
  if (fundamental_power > 32'd100)  // 行1429
      thd_lut_index <= ...
  else
      不计算THD → THD=0.0%
```

---

## ✅ 修复方案

### 修改文件
**文件**：`source/source/dual_channel_fft_controller.v`  
**位置**：第140-145行

### 修复代码

```verilog
// 第2级：ADC数据转换为有符号数（10位->16位）
// 【修复Bug 9】去除DC偏置，ADC中点512对应0V
// ADC原始数据：0-1023（无符号）
// 转换公式：signed = ADC - 512 （范围变为-512到+511）
wire signed [10:0] adc_offset_removed;  // 11位有符号
assign adc_offset_removed = {1'b0, data_buffer[15:6]} - 11'd512;

// 符号扩展到16位
assign adc_signed = {{5{adc_offset_removed[10]}}, adc_offset_removed};
```

**修复原理**：
1. 将ADC的0-1023范围转换为-512到+511
2. 512（中点）映射到0（对应0V）
3. FFT输入变成**真正的交流信号**
4. DC分量（bin 0）只包含**实际的DC偏置**（如果有的话）

---

## 📊 修复后预期效果

### 频谱显示

**修复前**：
```
bin 0 (DC): ████████████████ (巨大峰值，512)
bin 1-10:   ▌▍▎▏ (DC泄漏)
bin 234:    ██ (基波，被DC淹没)
bin 702:    █ (3次谐波)
```

**修复后**：
```
bin 0 (DC): ▏ (接近0，只有微小的实际DC偏置)
bin 1-10:   ▏ (噪声)
bin 234:    ████████ (基波，清晰可见)
bin 702:    ███ (3次谐波，清晰可见)
```

---

### THD测量

**修复前**：
- fft_max_amp：检测到DC泄漏或噪声
- 基波不准确
- THD计算错误 → 0.0%或99.9%

**修复后**：
- fft_max_amp：正确检测到实际信号基波
- 谐波清晰可见
- THD计算正确 → 40-55%（方波）

---

## 🧪 验证测试

### 测试1：500kHz方波，3Vpp
- **修复前**：bin 0巨大峰值，THD=0.0%
- **修复后预期**：bin 0接近0，THD=40-55%

### 测试2：1MHz正弦波，3Vpp
- **修复前**：bin 0巨大峰值，THD=0.0%
- **修复后预期**：bin 0接近0，THD<5%

### 测试3：无输入（接地）
- **修复前**：bin 0仍有峰值（512偏置）
- **修复后预期**：bin 0接近0，只有噪声

---

## 💡 为什么这个Bug之前没发现？

### 隐藏原因

1. **Hann窗的掩盖**：
   - Hann窗会对所有频率（包括DC）进行加权
   - DC分量被窗函数抑制了一部分
   - 问题不明显

2. **禁用Hann窗后暴露**：
   - 矩形窗（不加窗）直接传递ADC数据
   - DC偏置被完整保留
   - FFT的bin 0直接反映DC分量 → 512！

3. **频率测量正常**：
   - 基波检测从bin 1开始，跳过了DC
   - 频率测量不受影响
   - 只有THD受影响（需要准确的幅度）

---

## 🔍 其他可能的DC偏置来源

即使修复了512偏置，仍可能有小的DC偏置：

### 硬件原因
1. **ADC自身偏置**：芯片特性，可能±10 LSB
2. **前端电路偏置**：运放、耦合电容等
3. **信号源偏置**：函数发生器本身的DC偏置

### 软件处理（如果需要）

如果修复后bin 0仍有小峰值（<5%基波）：
```verilog
// 动态DC去除（可选）
reg signed [15:0] dc_estimate;
always @(posedge clk) begin
    // 低通滤波估计DC
    dc_estimate <= (dc_estimate * 15 + adc_signed) >> 4;
end
assign adc_dc_removed = adc_signed - dc_estimate;
```

**但通常不需要**：减去512后的DC应该很小（<10），对THD影响<1%

---

## 🎯 立即操作

1. ✅ **代码已修复**
2. ⏳ **编译项目**
3. ⏳ **下载到FPGA**
4. ⏳ **观察频谱**：
   - bin 0的峰值应该消失或大幅降低
   - 基波峰值应该清晰可见
5. ⏳ **测试THD**：
   - 500kHz方波：预期40-55%
   - 1MHz正弦波：预期<5%

---

## 📝 修复历史

| Bug | 问题 | 修复 | 状态 |
|-----|------|------|------|
| 1 | THD滤波器时序 | 组合逻辑计算 | ✅ |
| 2 | 基波门限过高 | 200→100 | ✅ |
| 3 | 谐波门限过高 | 降低/禁用 | ✅ |
| 4 | 谐波bin时序 | 两次扫描法 | ✅ |
| 5 | Hann窗不适用 | 禁用Hann窗 | ✅ |
| 6 | THD触发一次 | 移除限制 | ✅ |
| 7 | 谐波门限阻挡 | 完全禁用 | ✅ |
| 8 | LUT索引错误 | 支持小幅度 | ✅ |
| **9** | **DC偏置未去除** | **ADC-512** | **⏳待测试** |

---

## 🚀 信心度：99%

这次修复应该能解决问题，因为：
1. ✅ 观察到的bin 0巨大峰值完全符合DC偏置512的特征
2. ✅ 代码确实没有减去512
3. ✅ 这会导致FFT结果完全错误
4. ✅ 修复后FFT输入变成真正的AC信号

**这是最后一个关键Bug！修复后THD应该能正常工作了！** 🎯

---

**修改日期**：2025年11月5日  
**版本**：THD修复v8（DC偏置去除）  
**优先级**：P0（最高）  
**信心度**：99%
