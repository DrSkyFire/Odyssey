# THD测量问题完整修复报告

## 📋 问题演进历史

### 第一阶段：THD显示0.0%
**现象**：所有信号THD都显示0.0%
**修复**：
1. ✅ THD滤波器时序错误
2. ✅ 基波门限过高（200→100）
3. ✅ 谐波检测门限过高

**结果**：THD有显示了，但数值错误

---

### 第二阶段：THD都是20.2%
**现象**：正弦波、方波、三角波THD都是20.2%，无法区分
**修复**：
4. ✅ 谐波bin计算时序错误（改用两次扫描法）

**结果**：THD变为0.0%，FFT频谱上看不到谐波

---

### 第三阶段：发现根本原因
**现象**：FFT频谱上看不到任何谐波（即使是方波）
**诊断**：Hann窗对低频信号（1kHz）衰减96%，谐波淹没在噪声中
**修复**：
5. ✅ 禁用Hann窗，改用矩形窗（不加窗）

---

## 🔴 根本原因：Hann窗对低频不适用

### 问题分析

**Hann窗系数分布**（8192点）：
```
bin 0-10:    系数≈0.0000 (前100点几乎为0)
bin 100:     系数≈0.0097
bin 234:     系数≈0.04   ← 1kHz基波位置，衰减96%！
bin 702:     系数≈0.10   ← 3kHz谐波位置，衰减90%！
bin 1170:    系数≈0.15   ← 5kHz谐波位置，衰减85%！
bin 4096:    系数=1.0    (中心最大)
bin 8191:    系数≈0.0000 (末尾为0)
```

**对1kHz方波的影响**：
```
原始信号（未加窗）：
  基波1kHz:  幅度10000
  3次谐波:   幅度3333 (33%)
  5次谐波:   幅度2000 (20%)
  理论THD: 48%

加Hann窗后：
  基波1kHz:  10000×0.04 = 400  (衰减96%)
  3次谐波:   3333×0.10 = 333   (衰减90%)
  5次谐波:   2000×0.15 = 300   (衰减85%)
  
结果：
  谐波和基波都被严重衰减
  SNR急剧下降（信号400，噪声50 → SNR=8）
  谐波淹没在噪声中 → FFT频谱上看不到
  THD测量失败 → 显示0.0%
```

---

## ✅ 最终修复方案

### 核心修改：使用矩形窗（不加窗）

**文件**：`dual_channel_fft_controller.v` 行141-145

**修改前**：
```verilog
// 第3级：乘法（组合逻辑）
assign windowed_mult = adc_signed * $signed({1'b0, window_coeff});
assign windowed_data = windowed_mult[30:15];
```

**修改后**：
```verilog
// 使用矩形窗（不加窗）- 直接传递ADC数据
assign windowed_mult = 32'd0;  // 禁用乘法器
assign windowed_data = adc_signed;  // 直接使用ADC数据
```

**原理**：
- 矩形窗 = 所有系数为1 = 不衰减任何频率
- 直接传递ADC数据，不做任何窗函数处理
- 保留完整的信号能量和相位信息

---

## 📊 预期效果

### 修复前（使用Hann窗）
| 信号 | FFT基波幅度 | FFT谐波幅度 | 能否检测谐波 | THD显示 |
|------|-------------|-------------|-------------|---------|
| 1kHz正弦波 | 400 | ~50 (噪声) | ❌ 淹没 | 0.0% |
| 1kHz方波 | 400 | ~300 (H3) | ❌ 淹没 | 0.0% |
| 1kHz三角波 | 400 | ~100 (H3) | ❌ 淹没 | 0.0% |

### 修复后（使用矩形窗）
| 信号 | FFT基波幅度 | FFT谐波幅度 | 能否检测谐波 | THD预期 |
|------|-------------|-------------|-------------|---------|
| 1kHz正弦波 | 10000 | <200 (噪声) | ✅ 明显 | 0.5-2.0% |
| 1kHz方波 | 8000 | ~2700 (H3) | ✅ 明显 | 40-55% |
| 1kHz三角波 | 9000 | ~1000 (H3) | ✅ 明显 | 10-15% |

**关键改善**：
- 基波幅度提升25倍（400→10000）
- 谐波幅度提升9倍（300→2700）
- SNR提升（10000/50=200 vs 400/50=8）
- 谐波清晰可见，THD计算正确

---

## 🧪 验证步骤

### 第一步：编译烧录
```powershell
# 在TD PDS IDE中：
# 1. Project → Clean
# 2. Project → Synthesize
# 3. 下载bitstream到FPGA
```

### 第二步：观察FFT频谱
输入信号：**1kHz方波，2Vpp**

**观察HDMI显示的FFT频谱**：
| bin位置 | 理论频率 | 预期幅度 | 验证 |
|---------|----------|----------|------|
| 234 | 1kHz (基波) | 最高峰 | □ 可见 |
| 702 | 3kHz (H3) | 33%基波 | □ 可见 |
| 1170 | 5kHz (H5) | 20%基波 | □ 可见 |

✅ **如果能看到3次、5次谐波峰值 → 修复成功**

### 第三步：验证THD数值
| 信号 | 频率 | 幅度 | 预期THD | 实测THD | 状态 |
|------|------|------|---------|---------|------|
| 正弦波 | 1kHz | 2Vpp | <2% | _____ % | □ |
| 方波 | 1kHz | 2Vpp | 40-55% | _____ % | □ |
| 三角波 | 1kHz | 2Vpp | 10-15% | _____ % | □ |

**成功标准**：
- ✅ 方波THD > 正弦波THD（至少20倍）
- ✅ 三角波THD 介于方波和正弦波之间
- ✅ 方波THD在40-55%范围内

---

## 🔧 如果问题仍未解决

### 调试检查清单

#### 1. FFT频谱仍然看不到谐波
**可能原因**：
- [ ] ADC输入信号过小（检查信号幅度）
- [ ] FFT输入数据错误（检查FIFO数据）
- [ ] 频谱显示问题（检查其他频率的波形）

**调试方法**：
```verilog
// 在顶层模块添加调试信号
assign debug_led[7:0] = fft_max_amp[15:8];  // 显示基波幅度
```

#### 2. THD仍然为0
**可能原因**：
- [ ] 谐波检测门限仍然过高
- [ ] 谐波bin位置计算错误
- [ ] THD计算流水线问题

**调试方法**：
参考前面的诊断报告，逐步检查谐波检测链路

#### 3. 方波THD偏低（<30%）
**可能原因**：
- [ ] 谐波门限过高，H5被过滤
- [ ] 输入信号本身失真度低（检查信号源）

**调整方法**：
降低H5门限至10

---

## 📁 所有修改文件清单

| 文件 | 修改内容 | 行数 | 版本 |
|------|----------|------|------|
| `signal_parameter_measure.v` | THD滤波器时序修复 | 1489-1500 | v1 |
| `signal_parameter_measure.v` | 降低基波门限100 | 1370-1377 | v1 |
| `signal_parameter_measure.v` | 降低谐波检测门限 | 690-720 | v1 |
| `signal_parameter_measure.v` | 谐波bin时序修复 | 620-730 | v2 |
| `dual_channel_fft_controller.v` | 禁用Hann窗 | 141-145 | v3 |

---

## 💡 技术总结

### 关键教训1：窗函数选择要匹配应用场景
| 应用 | 推荐窗函数 | 原因 |
|------|-----------|------|
| THD测量 | 矩形窗 | 不衰减，幅度准确 |
| 语音分析 | Hann窗 | 减少频谱泄漏 |
| 雷达信号 | Hamming窗 | 主瓣窄，旁瓣低 |
| 低频测量(<10kHz) | 矩形窗 | Hann窗前后衰减严重 |

### 关键教训2：低频FFT的特殊性
```
问题：低频信号在FFT中只占很少的bin
  1kHz / (35MHz/8192) = 0.234 bin（不到1个bin！）
  
Hann窗影响：
  前1000个bin窗系数<0.2（衰减>80%）
  低频信号几乎全在窗函数的"死区"
  
解决方法：
  1. 使用矩形窗（本方案）
  2. 增加FFT点数（如16384点，但资源消耗大）
  3. 降低采样率（但会限制最高可测频率）
```

### 关键教训3：THD测量的本质
```
THD = 谐波功率和 / 基波功率

关键要求：
  1. 幅度比例准确（窗函数不能引入失真）
  2. 谐波可检测（SNR足够高）
  3. 基波和谐波受同样处理（保持比值不变）

Hann窗的问题：
  基波和谐波受不同衰减（窗系数不同）
  破坏了幅度比例关系
  不适合THD测量
```

---

## ✅ 修复完成确认

- [x] Bug 1：THD滤波器时序
- [x] Bug 2：基波门限过高
- [x] Bug 3：谐波检测门限过高
- [x] Bug 4：谐波bin计算时序
- [x] Bug 5：Hann窗对低频不适用（根本原因）
- [ ] 编译测试
- [ ] FFT频谱验证
- [ ] THD数值验证
- [ ] 全面性能测试

---

**修复日期**：2025年11月4日
**版本**：v3 (最终版)
**根本原因**：Hann窗对低频信号衰减过大
**解决方案**：改用矩形窗（不加窗）
**预期效果**：THD测量恢复正常，能区分不同波形

---

## 🎯 预期的最终结果

修复后，系统应该能够：

1. ✅ **区分不同波形**
   - 正弦波：THD < 2%
   - 方波：THD 40-55%
   - 三角波：THD 10-15%

2. ✅ **FFT频谱可见谐波**
   - 方波能看到明显的3次、5次谐波峰
   - 正弦波频谱干净，只有基波

3. ✅ **数值稳定**
   - THD跳动 < ±5%
   - 不再出现20%-90%的剧烈跳动

4. ✅ **小信号测量**
   - 支持0.5Vpp以上的信号
   - THD测量准确度±5%

请编译测试，期待你的好消息！
