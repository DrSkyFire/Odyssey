# 幅度测量模块修复说明

## 修复日期
2025年11月3日

## 发现的问题

### 1. **乘法位宽溢出风险** ⚠️ 【已修复】
**问题描述：**
```verilog
// 原代码
amplitude_calc <= (({10'd0, max_val_latch} - {10'd0, min_val_latch}) * 20'd9900) >> 10;
```
- 差值最大1023 (10位)
- 乘以9900后：1023 × 9900 = 10,127,700
- 需要24位存储，但中间结果可能被截断

**修复方案：**
- 改用32位宽存储中间结果
- 分离乘法和除法操作为独立流水线阶段

### 2. **时序竞争问题** ⚠️ 【已修复】
**问题描述：**
- `amplitude_calc` 在 `measure_done` 时计算
- 但 `measure_done` 也触发输出更新
- 可能导致使用未稳定的数据

**修复方案：**
- 增加流水线设计（3级）
- 提前触发计算（在 `time_cnt == TIME_100MS - 2` 时）
- 确保输出时数据已稳定

### 3. **缺少滤波器导致抖动** 📊 【已修复】
**问题描述：**
- 幅度直接输出，无滤波
- 频率和占空比都有滑动平均滤波
- 导致幅度显示跳动

**修复方案：**
- 添加4次滑动平均滤波器
- 与频率/占空比统一风格

### 4. **硬件衰减系数不确定** 🔍 【需要测试】
**问题描述：**
- 原注释声称有1:3的衰减比
- 但这需要实测验证
- 不同硬件版本可能不同

**修复方案：**
- 先使用标准公式：`峰峰值(mV) = (max - min) × 3300 / 1024`
- 在代码中预留衰减补偿接口（注释说明）
- 通过实测后调整系数

## 修复后的幅度计算流程

### 流水线设计（3级）

```
Stage 1: 计算差值
  amp_diff = max_val_latch - min_val_latch
  触发：time_cnt == TIME_100MS - 2

Stage 2: 乘以3300（转换为mV）
  amp_mult = amp_diff × 3300
  位宽：32位防止溢出

Stage 3: 除以1024 + 输出
  amp_result = amp_mult >> 10
  amplitude_calc = amp_result（延迟1拍）

滤波：4次滑动平均
  amp_filtered = (amp_history[0~3]) / 4

输出：
  amplitude_out = amp_filtered
```

### 关键改进点

1. **32位乘法器**
   ```verilog
   amp_mult <= {22'd0, amp_diff} * 32'd3300;
   ```
   确保不会溢出

2. **异常保护**
   ```verilog
   if (max_val_latch >= min_val_latch)
       amp_diff <= max_val_latch - min_val_latch;
   else
       amp_diff <= 10'd0;  // 防止负数
   ```

3. **流水线有效标志**
   ```verilog
   reg [1:0] amp_pipe_valid;
   ```
   确保每级数据有效性

4. **滤波器平滑**
   ```verilog
   amp_filtered <= amp_sum[17:2];  // 4次平均
   ```

## 硬件衰减补偿调整方法

如果实测发现幅度偏小，可以在 Stage 3 中调整：

### 方法1：倍数补偿
```verilog
// ×1.5倍
amp_result <= (amp_mult[25:10] * 16'd3) >> 1;

// ×2倍
amp_result <= (amp_mult[25:10] << 1);

// ×3倍
amp_result <= (amp_mult[25:10] * 16'd3);
```

### 方法2：精确系数补偿
如果实测衰减比为 K，则：
```verilog
// 例如实测衰减比 K = 2.8
// 需要补偿 2.8倍 = 28/10
amp_result <= (amp_mult[25:10] * 16'd28) / 16'd10;
```

### 方法3：修改基础公式
如果衰减比固定为3，可以直接：
```verilog
// Stage 2改为：
amp_mult <= {22'd0, amp_diff} * 32'd9900;  // 3300 × 3
```

## 测试验证方案

### 测试步骤

1. **零点测试**
   - 输入：GND（0V）
   - 期望：amplitude_out ≈ 0 ~ 50 mV（噪声底）

2. **满量程测试**
   - 输入：3.3V直流
   - 期望：amplitude_out ≈ 0（直流无峰峰值）

3. **标准幅度测试**
   | 输入Vpp | ADC差值(LSB) | 期望输出(mV) | 公式 |
   |---------|--------------|--------------|------|
   | 1.0V    | 310          | 1000         | 310 × 3.2227 |
   | 2.0V    | 620          | 2000         | 620 × 3.2227 |
   | 3.0V    | 930          | 3000         | 930 × 3.2227 |

   **如果测得值偏小（例如只有333mV），说明有硬件衰减，需要补偿**

4. **稳定性测试**
   - 固定幅度信号
   - 观察10秒内幅度跳动范围
   - 期望：抖动 < ±1% (滤波器生效)

5. **线性度测试**
   - 输入：100mV ~ 3300mV，步进100mV
   - 绘制测量值 vs 实际值曲线
   - 期望：线性度 R² > 0.999

### 调试输出建议

在仿真或调试时，可以添加：
```verilog
// 调试信号（仅用于仿真/ILA）
(* mark_debug = "true" *) reg [9:0] debug_max_val;
(* mark_debug = "true" *) reg [9:0] debug_min_val;
(* mark_debug = "true" *) reg [9:0] debug_amp_diff;
(* mark_debug = "true" *) reg [31:0] debug_amp_mult;
(* mark_debug = "true" *) reg [15:0] debug_amp_result;
(* mark_debug = "true" *) reg [15:0] debug_amp_filtered;
```

## 预期改进效果

1. **消除溢出风险**：32位乘法器确保所有情况不溢出
2. **消除时序竞争**：流水线设计保证数据稳定性
3. **减少抖动**：滤波器降低显示跳动 > 50%
4. **灵活补偿**：预留接口，方便根据实测调整

## 后续优化建议

1. **自动校准**
   - 可以添加校准模式
   - 输入已知标准信号
   - 自动计算补偿系数

2. **温度补偿**
   - ADC参考电压可能随温度漂移
   - 可以添加温度传感器反馈

3. **FFT幅度融合**
   - 低频用时域峰峰值
   - 高频用FFT基波幅度
   - 综合两者优势

## 修改文件列表

- `signal_parameter_measure.v` (修改)
  - 添加幅度计算流水线
  - 添加幅度滤波器
  - 修复位宽和时序问题
