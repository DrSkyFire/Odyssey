# 按键冲突修复报告

## 问题分析

### 发现的按键冲突

| 按键 | 冲突的功能 | 严重程度 |
|------|-----------|---------|
| user_button[0] | btn_mode + btn_freq_up_raw | P0 严重 |
| user_button[1] | btn_start + btn_freq_dn_raw | P0 严重 |
| user_button[2] | btn_stop + btn_amp_up_raw + btn_weak_sig_enable | P0 极严重 |
| user_button[3] | btn_ch1_toggle + btn_amp_dn_raw | P0 严重 |
| user_button[4] | btn_trig_mode + btn_duty_up_raw | P0 严重 |
| user_button[6] | btn_ch2_toggle + btn_thd_adjust_raw | P0 严重 |
| user_button[7] | btn_test_mode + adc_otr_clear (直连) | P1 中等 |

### 问题根源

1. **重复的消抖模块**: 同一个user_button连接到多个key_debounce模块
2. **复用逻辑错误**: 试图通过后续assign控制复用，但消抖模块已经冲突
3. **信号直连**: user_button[7]同时直连adc_otr_clear和消抖模块

## 修复方案

### 按键功能分配原则

1. **基础功能优先**: 模式切换、启动/停止、通道控制为核心功能
2. **上下文复用**: 根据工作模式(auto_test_enable)复用按键
3. **一键一模块**: 每个user_button只连接一个消抖模块

### 新的按键分配方案

| 按键 | 默认模式 | 自动测试模式 | 微弱信号模式 |
|------|---------|-------------|-------------|
| button[0] | 模式切换 (btn_mode) | 频率增加 | 频率增加 |
| button[1] | 启动 (btn_start) | 频率减少 | 频率减少 |
| button[2] | 停止 (btn_stop) | 幅度增加 | 参考频率增加 |
| button[3] | CH1开关 | 幅度减少 | 参考频率减少 |
| button[4] | 触发模式 | 占空比增加 | 参考模式切换 |
| button[5] | 自动测试切换 | (自动测试切换) | 微弱信号切换 |
| button[6] | CH2开关 | THD调整 | (保留) |
| button[7] | 测试模式 | (保留) | (保留) |

### 复用逻辑设计

```verilog
// 每个按键只有一个消抖模块
wire btn_0_pulse, btn_1_pulse, ..., btn_7_pulse;

// 根据模式分配功能
assign btn_mode      = btn_0_pulse & ~auto_test_enable & ~weak_sig_enable;
assign btn_freq_up   = btn_0_pulse & (auto_test_enable | weak_sig_enable);

assign btn_start     = btn_1_pulse & ~auto_test_enable & ~weak_sig_enable;
assign btn_freq_dn   = btn_1_pulse & (auto_test_enable | weak_sig_enable);
...
```

## 修复步骤

1. ✅ 删除所有冲突的消抖模块
2. ✅ 为每个user_button创建单一消抖模块
3. ✅ 实现基于模式的按键分配逻辑
4. ✅ 处理user_button[7]的直连冲突
5. ✅ 更新所有相关注释

## 影响评估

### 功能保留
- ✅ 所有核心功能保留（模式切换、启动停止、通道控制）
- ✅ 自动测试功能完整保留
- ✅ 微弱信号检测功能保留
- ✅ AI识别功能预留(button[7]在测试模式外可用)

### 用户体验优化
- ✅ 按键响应更清晰（无冲突）
- ✅ 模式切换更直观（同一按键在不同模式下有不同功能）
- ✅ 减少资源占用（消抖模块从13个减少到8个）

### 潜在风险
- ⚠️ 用户需要学习新的按键映射
- ⚠️ button[7]不再能直接清除ADC溢出（需要通过消抖）

## 后续建议

1. 创建按键功能速查表（用户文档）
2. 考虑添加LED指示当前模式
3. 测试各模式下的按键响应
