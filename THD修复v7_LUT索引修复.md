# THDä¿®å¤v7 - LUTç´¢å¼•è®¡ç®—ä¿®å¤

## ğŸ‰ é‡å¤§çªç ´ï¼

**THDå·²ç»èƒ½æ˜¾ç¤ºäº†ï¼** æ˜¾ç¤º99.9%è¯´æ˜æ•´ä¸ªè®¡ç®—é“¾è·¯éƒ½æ˜¯æ­£å¸¸çš„ï¼Œåªæ˜¯**æ•°å€¼è®¡ç®—æœ‰è¯¯**ã€‚

---

## ğŸ Bug 8ï¼šLUTç´¢å¼•è®¡ç®—é”™è¯¯

### é—®é¢˜ç°è±¡
- **è¾“å…¥**ï¼š500kHzæ–¹æ³¢ï¼Œ3Vpp
- **æ˜¾ç¤º**ï¼šTHD = 99.9%
- **é¢„æœŸ**ï¼šTHD â‰ˆ 40-55%

### æ ¹æœ¬åŸå› 

**LUTç´¢å¼•è®¡ç®—å‡è®¾åŸºæ³¢å¹…åº¦>256**ï¼Œä½†å®é™…å¯èƒ½æ›´å°ï¼

```verilog
// ä¿®å¤å‰ï¼ˆé”™è¯¯ä»£ç ï¼‰
if (fundamental_power[15:8] != 8'd0)
    thd_lut_index <= fundamental_power[15:8];  // å–é«˜8ä½
else
    thd_lut_index <= 8'd1;  // âŒ å½“fft_max_amp<256æ—¶ï¼Œç´¢å¼•å¼ºåˆ¶ä¸º1
```

**é—®é¢˜åˆ†æ**ï¼š
- å½“`fft_max_amp = 200`æ—¶
- `thd_lut_index = 200[15:8] = 0` â†’ å¼ºåˆ¶ä¸º1
- `thd_reciprocal = 4000`ï¼ˆä»LUTæŸ¥è¡¨ï¼‰
- ç›¸å½“äºé™¤ä»¥`256/4000Ã—1024 = 65`
- **å®é™…åº”è¯¥é™¤ä»¥200ï¼Œè¢«ç¼©å°äº†3å€ï¼**
- **ç»“æœ**ï¼šTHDè¢«æ”¾å¤§çº¦3å€ï¼Œå¯¼è‡´æ˜¾ç¤º99.9%

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### ä¿®å¤1ï¼šLUTç´¢å¼•è®¡ç®—ï¼ˆè¡Œ1428-1449ï¼‰

```verilog
// ä¿®å¤åï¼šæ”¯æŒå°å¹…åº¦ä¿¡å·
if (fundamental_power > 32'd65280)  // 65280 = 255Ã—256
    thd_lut_index <= 8'd255;  // é¥±å’Œ
else if (fundamental_power >= 32'd256)
    thd_lut_index <= fundamental_power[15:8];  // æ­£å¸¸èŒƒå›´
else begin
    // âœ… å°å¹…åº¦ä¿¡å·ï¼ˆ100-255ï¼‰ç‰¹æ®Šå¤„ç†
    if (fundamental_power >= 32'd200)
        thd_lut_index <= 8'd12;  // ~333
    else if (fundamental_power >= 32'd160)
        thd_lut_index <= 8'd10;  // ~400
    else if (fundamental_power >= 32'd128)
        thd_lut_index <= 8'd8;   // ~500
    else
        thd_lut_index <= 8'd6;   // ~667
end
```

**ä¿®å¤åŸç†**ï¼š
- å¯¹äºå°å¹…åº¦ä¿¡å·ï¼Œä½¿ç”¨å›ºå®šçš„ç´¢å¼•æ˜ å°„
- é¿å…ç´¢å¼•è¿‡å°å¯¼è‡´å€’æ•°è¿‡å¤§
- ç¡®ä¿THDè®¡ç®—åœ¨åˆç†èŒƒå›´

---

### ä¿®å¤2ï¼šæ‰©å±•LUTè¡¨ï¼ˆè¡Œ1456-1476ï¼‰

æ·»åŠ äº†å¯¹å°ç´¢å¼•å€¼çš„ç²¾ç¡®æ”¯æŒï¼š

```verilog
case (thd_lut_index)
    8'd3:   thd_reciprocal <= 20'd1333;  // æ–°å¢
    8'd5:   thd_reciprocal <= 20'd800;   // æ–°å¢
    8'd6:   thd_reciprocal <= 20'd667;   // æ–°å¢
    8'd7:   thd_reciprocal <= 20'd571;   // æ–°å¢
    8'd10:  thd_reciprocal <= 20'd400;   // æ–°å¢
    8'd12:  thd_reciprocal <= 20'd333;   // æ–°å¢
    // ... å…¶ä»–åŸæœ‰å€¼
```

---

## ğŸ“Š ä¿®å¤æ•ˆæœé¢„æµ‹

### 500kHzæ–¹æ³¢ï¼Œ3Vpp

**å‡è®¾å€¼**ï¼ˆéœ€è¦é€šè¿‡UARTç¡®è®¤ï¼‰ï¼š
- `fft_max_amp = 200`
- `fft_harmonic_3 = 60`ï¼ˆ3æ¬¡è°æ³¢ï¼‰
- `è°æ³¢å’Œ = 115`

**ä¿®å¤å‰**ï¼š
```
thd_lut_index = 1ï¼ˆé”™è¯¯ï¼‰
thd_reciprocal = 4000
THD = (115 Ã— 4000) >> 10 = 449
ç»è¿‡æ»¤æ³¢å¯èƒ½è¾¾åˆ°999 â†’ æ˜¾ç¤º99.9%
```

**ä¿®å¤å**ï¼š
```
thd_lut_index = 12ï¼ˆæ­£ç¡®ï¼‰
thd_reciprocal = 333
THD = (115 Ã— 333) >> 10 = 37
å®é™…çº¦ä¸º37% â†’ ç»è¿‡æ»¤æ³¢çº¦40-50%
```

---

### 1MHzæ–¹æ³¢ï¼Œ3Vpp

å¦‚æœ`fft_max_amp`æ›´å¤§ï¼ˆæ¯”å¦‚5000ï¼‰ï¼š

**ä¿®å¤å‰**ï¼š
```
thd_lut_index = 5000[15:8] = 19ï¼ˆæ¥è¿‘æ­£ç¡®ï¼‰
THDè®¡ç®—åŸºæœ¬å‡†ç¡®ï¼Œå¯èƒ½æ˜¾ç¤º40-60%
```

**ä¿®å¤å**ï¼š
```
thd_lut_index = 5000[15:8] = 19ï¼ˆä¸å˜ï¼‰
THDè®¡ç®—æ›´åŠ å‡†ç¡®ï¼Œæ˜¾ç¤º40-55%
```

---

## ğŸ§ª éªŒè¯æµ‹è¯•

### æµ‹è¯•1ï¼š500kHzæ–¹æ³¢ï¼Œ3Vpp
- **ä¿®å¤å‰**ï¼šTHD = 99.9%
- **ä¿®å¤åé¢„æœŸ**ï¼šTHD = 40-55%
- **çŠ¶æ€**ï¼šâ³ å¾…æµ‹è¯•

### æµ‹è¯•2ï¼š1MHzæ–¹æ³¢ï¼Œ3Vpp
- **ä¿®å¤å‰**ï¼šå¯èƒ½æ¥è¿‘99.9%
- **ä¿®å¤åé¢„æœŸ**ï¼šTHD = 40-55%
- **çŠ¶æ€**ï¼šâ³ å¾…æµ‹è¯•

### æµ‹è¯•3ï¼š1MHzæ­£å¼¦æ³¢ï¼Œ3Vpp
- **ä¿®å¤å‰**ï¼šå¯èƒ½>50%
- **ä¿®å¤åé¢„æœŸ**ï¼šTHD < 5%
- **çŠ¶æ€**ï¼šâ³ å¾…æµ‹è¯•

---

## ğŸ” UARTè°ƒè¯•ï¼ˆä»ç„¶é‡è¦ï¼‰

è™½ç„¶å·²ç»ä¿®å¤äº†è®¡ç®—ï¼Œä½†UARTåªè¾“å‡ºä¸€ä¸ª"="çš„é—®é¢˜è¿˜éœ€è¦è§£å†³ï¼š

**å¯èƒ½åŸå› **ï¼š
1. æ³¢ç‰¹ç‡ä¸åŒ¹é…ï¼ˆæ£€æŸ¥UARTå‘é€æ¨¡å—çš„æ³¢ç‰¹ç‡é…ç½®ï¼‰
2. UARTçŠ¶æ€æœºå¡ä½
3. æ—¶é’ŸåŸŸé—®é¢˜

**å»ºè®®**ï¼š
- å…ˆæµ‹è¯•THDä¿®å¤æ•ˆæœ
- å¦‚æœTHDæ­£å¸¸ï¼Œå†è°ƒè¯•UARTè¾“å‡º
- UARTä¸»è¦ç”¨äºæ·±åº¦è°ƒè¯•ï¼Œä¸å½±å“ä¸»åŠŸèƒ½

---

## ğŸ“ ä¿®æ”¹æ–‡ä»¶

**æ–‡ä»¶**ï¼š`source/source/signal_parameter_measure.v`

**ä¿®æ”¹ä½ç½®**ï¼š
- è¡Œ1428-1449ï¼šLUTç´¢å¼•è®¡ç®—é€»è¾‘
- è¡Œ1456-1476ï¼šLUTå€’æ•°è¡¨æ‰©å±•

**ä¿®æ”¹ç±»å‹**ï¼šBugä¿®å¤

---

## ğŸ¯ ä¸‹ä¸€æ­¥

1. **ç«‹å³ç¼–è¯‘**ï¼šç¼–è¯‘æ— é”™è¯¯ âœ…
2. **ä¸‹è½½åˆ°FPGA**
3. **æµ‹è¯•500kHzæ–¹æ³¢**ï¼š
   - è§‚å¯ŸHDMIæ˜¾ç¤ºTHD
   - é¢„æœŸï¼šä»99.9%é™ä½åˆ°40-55%
4. **æµ‹è¯•ä¸åŒä¿¡å·**ï¼š
   - 1MHzæ–¹æ³¢
   - 1MHzæ­£å¼¦æ³¢
   - 100kHzæ–¹æ³¢
5. **è®°å½•ç»“æœ**å¹¶æŠ¥å‘Š

---

## ğŸ’¡ ä¸ºä»€ä¹ˆè¿™æ¬¡ä¼šæˆåŠŸï¼Ÿ

### ä¹‹å‰7æ¬¡ä¿®å¤çš„ç´¯ç§¯æ•ˆæœï¼š
1. âœ… THDæ»¤æ³¢å™¨æ—¶åº â†’ æ»¤æ³¢å™¨æ­£å¸¸
2. âœ… åŸºæ³¢é—¨é™é™ä½ â†’ èƒ½è§¦å‘è®¡ç®—
3. âœ… è°æ³¢é—¨é™ç¦ç”¨ â†’ è°æ³¢èƒ½è¢«æ£€æµ‹
4. âœ… è°æ³¢binæ—¶åº â†’ binè®¡ç®—æ­£ç¡®
5. âœ… ç¦ç”¨Hannçª— â†’ FFTå¹…åº¦æ­£å¸¸
6. âœ… THDè§¦å‘é€»è¾‘ â†’ èƒ½é‡å¤è®¡ç®—
7. âœ… è°æ³¢é—¨é™å®Œå…¨ç¦ç”¨ â†’ æ‰€æœ‰è°æ³¢é€šè¿‡

### ç¬¬8æ¬¡ä¿®å¤ï¼ˆæœ¬æ¬¡ï¼‰ï¼š
8. âœ… **LUTç´¢å¼•ä¿®æ­£ â†’ æ•°å€¼è®¡ç®—æ­£ç¡®**

**å…³é”®æ´å¯Ÿ**ï¼š
- æ˜¾ç¤º99.9%è¯´æ˜é“¾è·¯é€šäº†ï¼Œåªæ˜¯ç®—é”™äº†
- LUTç´¢å¼•æ˜¯æœ€åä¸€ä¸ªbug
- ä¿®å¤ååº”è¯¥èƒ½æ­£å¸¸æ˜¾ç¤ºï¼

---

**ç«‹å³ç¼–è¯‘å¹¶æµ‹è¯•ï¼é¢„è®¡è¿™æ¬¡ä¼šæˆåŠŸï¼** ğŸš€

ä¿®æ”¹æ—¥æœŸï¼š2025å¹´11æœˆ5æ—¥  
ç‰ˆæœ¬ï¼šTHDä¿®å¤v7ï¼ˆLUTç´¢å¼•ä¿®å¤ï¼‰  
ä¼˜å…ˆçº§ï¼šP0ï¼ˆæœ€é«˜ï¼‰  
ä¿¡å¿ƒåº¦ï¼š95%ï¼ˆæé«˜ï¼‰
