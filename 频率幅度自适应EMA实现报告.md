# 频率/幅度自适应EMA滤波器实现报告

**日期**: 2025-11-07  
**方案**: 基于输入特性（频率/幅度）的自适应平滑  
**原理**: 超低频/小信号噪声大→强平滑，高频/大信号噪声小→快速响应

---

## 问题重新分析

### 用户需求
- **超低频信号**：较大噪声 → 需要强平滑抑制
- **高频信号**：微弱噪声 → 可以快速响应
- **要求**：快速收敛 + 低频降噪

### 之前方案的失败原因
**基于误差的自适应**（已失败）：
```verilog
// ❌ 错误：阈值依赖ema输出
if (|error| > ema/16) α=0.5;  // 大变化快速跟踪
else α=0.125;  // 小变化强平滑
```

**问题**：
1. 小信号/初始状态 `ema=0` → 阈值失效
2. 无法区分"噪声波动"和"真实信号变化"
3. α=0.5过于激进，与窗函数波动叠加后震荡

---

## 新方案：基于输入特性的自适应

### 核心思想
**不看误差，看输入本身的特性**：
- 频率测量：根据**当前频率**调整α
- 幅度测量：根据**当前幅度**调整α

### 优势
✅ 阈值固定（1kHz, 10kHz, 500mV, 2V），不依赖ema  
✅ 小信号/初始状态稳定  
✅ 符合物理规律：低频/小信号噪声占比确实更大  
✅ α切换仅在跨频段/幅度段时发生，不频繁  

---

## 实现细节

### 1. 频率自适应EMA

**分段策略**：
```verilog
// 超低频：<1kHz（Hz单位且<1000）
if (freq_unit == Hz && freq_result < 1000)
    α = 0.0625 (SHIFT=4)  // 等效16次平均，800ms响应

// 低频：1-10kHz（kHz单位且<10）
else if (freq_unit == kHz && freq_result < 10)
    α = 0.125 (SHIFT=3)  // 等效8次平均，400ms响应

// 高频：>10kHz（kHz≥10或MHz单位）
else
    α = 0.25 (SHIFT=2)  // 等效4次平均，200ms响应
```

**物理依据**：
- **1kHz信号**：FFT窗内仅0.234周期 → 频谱泄漏严重 → 需强平滑
- **100kHz信号**：FFT窗内23.4周期 → 频谱清晰 → 可快速响应

**代码位置**：`signal_parameter_measure.v` line 557-588

**示例效果**：
| 输入频率 | α系数 | 响应时间 | 噪声抑制 |
|---------|-------|----------|----------|
| 500Hz   | 0.0625 | 800ms | -12dB (16x) |
| 5kHz    | 0.125  | 400ms | -9dB (8x) |
| 50kHz   | 0.25   | 200ms | -6dB (4x) |

---

### 2. 幅度自适应EMA

**分段策略**：
```verilog
// 小信号：<500mV
if (amplitude < 500)
    α = 0.0625 (SHIFT=4)  // 超强平滑

// 中等信号：500mV-2V
else if (amplitude < 2000)
    α = 0.125 (SHIFT=3)  // 强平滑

// 大信号：>2V
else
    α = 0.25 (SHIFT=2)  // 快速响应
```

**物理依据**：
- **小信号**：ADC量化噪声占比大 → 需强平滑
- **大信号**：SNR高，量化噪声可忽略 → 可快速跟踪

**代码位置**：`signal_parameter_measure.v` line 1003-1046

**示例效果**：
| 输入幅度 | α系数 | 响应时间 | 抖动抑制 |
|---------|-------|----------|----------|
| 200mV   | 0.0625 | 800ms | ±1mV |
| 1V      | 0.125  | 400ms | ±5mV |
| 3V      | 0.25   | 200ms | ±10mV |

---

### 3. 占空比/THD滤波器

**策略**：保持固定α=0.125
- 占空比和THD与频率/幅度关联性不强
- 固定α简单可靠，避免过度复杂化

---

## 与之前方案的对比

| 特性 | 基于误差的自适应（已失败） | 基于输入的自适应（新方案） |
|------|--------------------------|--------------------------|
| 阈值依赖 | ❌ 依赖ema输出 | ✅ 固定阈值（1kHz, 10kHz等） |
| 小信号稳定性 | ❌ ema=0时阈值失效 | ✅ 基于输入值判断，稳定 |
| 噪声识别 | ❌ 无法区分噪声/真实变化 | ✅ 符合物理规律 |
| α最大值 | ❌ 0.5（过于激进） | ✅ 0.25（适中） |
| 切换频率 | ❌ 频繁（每次误差>阈值） | ✅ 低（仅跨频段时） |
| 实现复杂度 | 🟠 中等（误差比较+补码） | ✅ 低（简单if-else） |

---

## 预期效果

### 超低频场景（例如500Hz）
- **输入**：500Hz正弦波，噪声±50Hz
- **α选择**：0.0625（超强平滑）
- **预期输出**：500Hz ± 5Hz（噪声抑制10倍）
- **响应时间**：800ms

### 低频场景（例如5kHz）
- **输入**：5kHz正弦波，噪声±20Hz
- **α选择**：0.125（强平滑）
- **预期输出**：5kHz ± 5Hz（噪声抑制4倍）
- **响应时间**：400ms

### 高频场景（例如100kHz）
- **输入**：100kHz正弦波，噪声±10Hz
- **α选择**：0.25（快速响应）
- **预期输出**：100kHz ± 5Hz（噪声抑制2倍）
- **响应时间**：200ms

### 小信号场景（例如200mV）
- **输入**：200mV@1kHz，抖动±10mV
- **α选择**：幅度0.0625 + 频率0.0625
- **预期输出**：200mV ± 1mV（抖动抑制10倍）
- **显示**：✅ 正常显示（解决<2Vpp无显示问题）

### 大信号场景（例如3V@100kHz）
- **输入**：3V@100kHz，抖动±5mV
- **α选择**：幅度0.25 + 频率0.25
- **预期输出**：3V ± 2mV，100kHz ± 5Hz
- **响应时间**：200ms（快速跟踪）

---

## 资源开销

### 频率滤波器
- 增加：2个比较器（freq_unit + freq_result）
- 增加：3选1多路选择器（选择α）
- **总计**：约50 LUTs

### 幅度滤波器
- 增加：2个比较器（amplitude_calc vs 500, 2000）
- 增加：3选1多路选择器
- **总计**：约50 LUTs

**总资源**：约100 LUTs（相比之前的200 LUTs减少50%）

---

## 调试与调优

### 测试场景

1. **超低频噪声测试**
   - 输入：500Hz正弦波 + 白噪声
   - 检查：频率显示是否稳定在500Hz附近
   - 调整：如噪声仍大，可降低阈值（1kHz → 2kHz）

2. **高频响应测试**
   - 输入：100kHz方波，快速切换到200kHz
   - 检查：响应时间是否<500ms
   - 调整：如响应慢，可提高高频α（0.25 → 0.375）

3. **小信号显示测试**
   - 输入：100mV@1kHz
   - 检查：是否正常显示（解决<2Vpp问题）
   - 调整：如仍无显示，检查ADC或前端增益

4. **跨频段切换测试**
   - 输入：500Hz → 5kHz → 50kHz
   - 检查：α切换是否平滑，有无跳变
   - 调整：如有跳变，考虑增加迟滞（例如1kHz±100Hz）

### 参数调整

如需修改阈值，在 `signal_parameter_measure.v` 中：

```verilog
// 当前阈值（频率）
freq_result < 16'd1000  // <1kHz → 超低频
freq_result < 16'd10    // <10kHz → 低频

// 调整示例（更敏感的分段）
freq_result < 16'd500   // <500Hz → 超低频
freq_result < 16'd5     // <5kHz → 低频

// 当前阈值（幅度）
amplitude_calc < 16'd500   // <500mV → 小信号
amplitude_calc < 16'd2000  // <2V → 中等

// 调整示例
amplitude_calc < 16'd300   // <300mV → 小信号
amplitude_calc < 16'd1500  // <1.5V → 中等
```

---

## 技术亮点

### 1. 物理规律驱动
基于实际信号特性（低频噪声大、小信号SNR差），而非数学上的误差分析。

### 2. 阈值独立
阈值完全独立于EMA输出，避免小信号/初始状态下的失效问题。

### 3. 简单可靠
判断逻辑清晰（简单的if-else），无复杂的补码运算或绝对值计算。

### 4. 可扩展性
可轻松添加更多频段（例如超高频>1MHz，α=0.5）或中间档位。

---

## 总结

**核心创新**：从"检测变化"转向"识别特性"

| 方面 | 之前方案 | 新方案 |
|------|---------|--------|
| 驱动因素 | 误差大小 | 输入特性（频率/幅度） |
| 阈值 | 动态（ema/16） | 固定（1kHz, 10kHz等） |
| 稳定性 | ❌ 小信号失效 | ✅ 全范围稳定 |
| 物理意义 | ⚠️ 间接 | ✅ 直接（低频=噪声大） |
| 复杂度 | 🟠 中等 | ✅ 低 |

**预期结果**：
- ✅ 超低频强降噪（16x平均）
- ✅ 高频快速响应（200ms）
- ✅ 小信号正常显示
- ✅ 无震荡、无失效
