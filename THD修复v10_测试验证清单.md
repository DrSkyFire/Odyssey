# THD修复v10 测试验证清单

**版本**: v10  
**修复内容**: 精确谐波bin计算（频率倍数法）  
**目标**: 修复20kHz方波THD=0%问题

---

## 📋 测试前准备

### 1. 编译工程
```bash
cd e:\Odyssey_proj
td -script impl.tcl
```

**检查点**:
- [ ] 编译成功，无ERROR
- [ ] 检查WARNING，确认除法时序满足要求
- [ ] 生成.sbit文件

### 2. 烧录FPGA
- [ ] 烧录成功
- [ ] LED指示灯正常

---

## 🧪 功能测试

### 测试1: 20kHz方波（重点测试）

**预期**: THD从0.0%恢复到~45%

| 项目 | 设置 | v9结果 | v10预期 | 实测 | 状态 |
|------|------|--------|---------|------|------|
| 波形 | 方波 | - | - | | |
| 频率 | 20kHz | 0.0% | 40-50% | | |
| 幅度 | 3Vpp | - | - | | |
| THD | 测量值 | **0.0%** | **~48%** | | |

**诊断步骤**（如果失败）:
1. 检查频率显示是否准确（应显示20.0kHz）
2. 检查幅度显示是否正常（应显示3.0V左右）
3. 如果THD仍为0%：
   - 可能是谐波幅度低于噪声阈值50
   - 需要降低阈值或增加函数发生器幅度到5Vpp

---

### 测试2: 600kHz方波（回归测试）

**预期**: THD保持53%±3%

| 项目 | v9结果 | v10预期 | 实测 | 状态 |
|------|--------|---------|------|------|
| THD | 53%±3% | 53%±3% | | |

---

### 测试3: 1MHz方波（改善验证）

**预期**: THD保持或略微提升

| 项目 | v9结果 | v10预期 | 实测 | 状态 |
|------|--------|---------|------|------|
| THD | 20%±1% | 20-25% | | |

**备注**: 
- 理论THD应为53%（仅3次和5次谐波）
- 如果仍然20%，可能是3次谐波幅度不足
- 后续可能需要添加7次和9次谐波检测

---

### 测试4: 500kHz正弦波（基线测试）

**预期**: THD保持8%左右（ADC非线性）

| 项目 | v9结果 | v10预期 | 实测 | 状态 |
|------|--------|---------|------|------|
| THD | 8.0%±3% | 8.0%±3% | | |

---

## 📊 扩展测试（可选）

### 低频测试矩阵

| 频率 | 波形 | 理论THD | v9测量 | v10预期 |
|------|------|---------|--------|---------|
| 10kHz | 方波 | 48.3% | 未测试 | ~45% |
| 15kHz | 方波 | 48.3% | 未测试 | ~45% |
| 20kHz | 方波 | 48.3% | **0.0%** | **~45%** |
| 30kHz | 方波 | 48.3% | 未测试 | ~48% |
| 50kHz | 方波 | 48.3% | 未测试 | ~48% |

**测试目的**: 验证低频THD的准确性和稳定性

---

### 高频测试矩阵

| 频率 | 波形 | 理论THD | v10预期 | 备注 |
|------|------|---------|---------|------|
| 500kHz | 方波 | 48.3% | ~50% | |
| 700kHz | 方波 | 48.3% | ~50% | |
| 1MHz | 方波 | 53.3% | ~20% | 3次谐波可能弱 |
| 2MHz | 方波 | 53.3% | 0-10% | 谐波超出范围 |

**测试目的**: 验证高频THD的极限和衰减特性

---

## 🔍 调试工具（如果需要）

### UART调试输出
如果THD仍然不准确，可以启用UART调试：

```verilog
// 在signal_analyzer_top.v中添加UART输出
// 输出格式: 
// F=20000,H2=xxx,H3=xxx,H5=xxx,THD=xxx
```

### 频谱分析
使用HDMI显示或UART输出FFT前30个bin的幅度，手动计算THD验证。

---

## ✅ 验收标准

### 最低要求:
- [x] 20kHz方波THD > 0% （修复失效问题）
- [ ] 600kHz方波THD = 53%±5% （不退化）

### 理想目标:
- [ ] 20kHz方波THD = 48%±5% （接近理论值）
- [ ] 10-50kHz低频方波THD稳定在45-50%
- [ ] 500kHz-1MHz高频方波THD稳定在50%以上

---

## 📝 测试记录

### 测试环境:
- **日期**: _________
- **FPGA版本**: v10
- **函数发生器**: _________
- **测试人**: _________

### 问题记录:
```
问题1: 
  现象: 
  分析: 
  解决: 

问题2:
  现象:
  分析:
  解决:
```

---

## 🚀 下一步计划

根据测试结果：

### 如果20kHz THD成功（>40%）:
- [ ] 添加10kHz/15kHz测试，验证更低频
- [ ] 优化正弦波THD（降低ADC非线性影响）
- [ ] 添加7次和9次谐波检测（提升1MHz方波THD）

### 如果20kHz THD仍失败（<10%）:
- [ ] 使用UART输出谐波bin和幅度值
- [ ] 检查3次和5次谐波是否在±3bin范围内
- [ ] 验证`fft_freq_hz`的值是否正确（应为20000Hz）
- [ ] 考虑扩大搜索范围到±5bin或±10bin

---

**测试完成后请填写结果并提交到仓库！** 🎯
