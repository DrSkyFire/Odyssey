# 自适应EMA滤波器失败分析报告

**日期**: 2025-11-07  
**问题**: 自适应EMA导致严重震荡和小信号无显示  
**状态**: 已紧急回退到固定α=0.125 + 禁用窗函数

---

## 问题现象

启用自适应EMA滤波器后出现两个严重问题：

### 1. 小信号无显示（<2Vpp）
- **现象**：信号幅度低于2Vpp时，频谱和所有测量值完全消失
- **影响**：无法测量小信号，系统可用性严重下降

### 2. 大幅震荡（>100%）
- **现象**：所有参数（频率、幅度、占空比、THD）在输入值附近剧烈震荡
- **震荡幅度**：超过100%（例如100kHz信号在50kHz-200kHz之间跳动）
- **影响**：测量结果完全不可用

---

## 根本原因分析

### 原因1：阈值计算依赖EMA值

**设计缺陷**：
```verilog
// 大变化阈值：|error| > ema/16
if (error > {4'd0, freq_ema[15:4]}) begin
    // 使用α=0.5快速跟踪
end
```

**问题**：
- **初始状态**：`ema = 0` → 阈值 = 0/16 = 0 → **任何误差都被判定为"大变化"**
- **小信号**：`ema < 16` → 阈值 = 0（右移4位下溢）→ **持续触发α=0.5**
- **结果**：EMA无法收敛，输出在0和输入值之间震荡

**示例**：
```
输入：100mV信号（ADC值≈30）
第1次：ema=0, error=30, 阈值=0 → "大变化" → ema = 0 + 30>>1 = 15
第2次：ema=15, error=15, 阈值=0 → "大变化" → ema = 15 + 15>>1 = 22
第3次：ema=22, error=8, 阈值=1 → "大变化" → ema = 22 + 8>>1 = 26
...
持续在10-40之间震荡，永不收敛
```

### 原因2：α=0.5过于激进

**问题**：
- α=0.5意味着新值权重50%，收敛速度极快（2次周期达95%）
- 但对噪声和窗函数波动极其敏感
- **与窗函数能量波动叠加**：
  - 窗函数导致测量值系统性波动±5%
  - α=0.5使滤波器完全跟随这个波动
  - 结果：输出震荡幅度等于输入波动幅度

### 原因3：频繁切换α值本身引入不稳定

**问题**：
- 自适应EMA在大/中/小变化阈值附近频繁切换α值
- 每次切换相当于改变滤波器的传递函数
- **引发瞬态扰动**：
  ```
  α=0.125 → α=0.5 → α=0.125 → α=0.5 ...
  (稳定)    (跳变)   (稳定)    (跳变)
  ```
- 结果：滤波器无法稳定，持续震荡

### 原因4：补码运算位宽问题

**潜在风险**：
```verilog
// 负数取绝对值
if ((~freq_error[15:0] + 1'b1) > {4'd0, freq_ema[15:4]}) begin
    //      ^^^^^^^^^^^^^^^^^^^^
    //      16位 + 1 可能溢出到17位，但只取[15:0]
```

虽然不是主要原因，但在边界条件下可能导致误判。

---

## 设计缺陷总结

| 问题 | 影响 | 严重程度 |
|------|------|----------|
| 阈值依赖EMA，小信号/初始状态下=0 | 无法收敛，持续震荡 | 🔴 致命 |
| α=0.5过于激进，对噪声敏感 | 跟随窗函数波动，震荡>100% | 🔴 致命 |
| 频繁切换α值引入瞬态扰动 | 滤波器不稳定 | 🟠 严重 |
| 补码运算位宽潜在溢出 | 边界条件误判 | 🟡 中等 |

---

## 回退方案

已紧急回退到稳定配置：

### 1. 禁用窗函数
```verilog
// dual_channel_fft_controller.v line 91
parameter ENABLE_WINDOW = 0;  // 矩形窗
```

**理由**：
- Hann窗导致能量波动±5%-10%
- 自适应EMA无法抑制这种系统性波动
- 矩形窗虽然降噪差，但测量值稳定

### 2. 固定α=0.125（所有参数）
```verilog
// signal_parameter_measure.v
freq_ema <= freq_ema + freq_error[16:FREQ_ALPHA_SHIFT_SLOW];  // α=0.125
amp_ema <= amp_ema + amp_error[16:AMP_ALPHA_SHIFT_SLOW];      // α=0.125
duty_ema <= duty_ema + duty_error[16:DUTY_ALPHA_SHIFT_SLOW];  // α=0.125
thd_ema <= thd_ema + thd_error[16:THD_ALPHA_SHIFT_SLOW];      // α=0.125
```

**理由**：
- α=0.125稳定可靠，等效8次平均
- 响应时间400ms可接受
- 没有切换α引入的瞬态扰动

### 3. 保留自适应框架（localparam定义）
```verixml
localparam FREQ_ALPHA_SHIFT_SLOW = 3;  // α = 0.125
localparam FREQ_ALPHA_SHIFT_MID  = 2;  // α = 0.25
localparam FREQ_ALPHA_SHIFT_FAST = 1;  // α = 0.5
```

**理由**：为将来改进留接口，但暂时不使用

---

## 经验教训

### 1. 自适应参数不应依赖输出值

❌ **错误设计**：阈值 = ema / 16（依赖输出）  
✅ **正确设计**：阈值 = 固定值（如10、100）或输入范围的百分比

### 2. 激进参数需要充分测试

❌ **错误**：α=0.5直接上线  
✅ **正确**：从α=0.25开始，逐步测试到α=0.5

### 3. 窗函数 + 自适应滤波器需谨慎

- 窗函数引入**系统性波动**（非随机噪声）
- 自适应滤波器可能**误判为真实信号变化**
- 需要区分"系统性波动"和"真实输入变化"

### 4. 小信号场景是关键测试点

- 很多算法在大信号下正常，小信号下崩溃
- 必须测试边界条件：0信号、小信号、饱和信号

---

## 未来改进方向（暂不实施）

### 方案A：固定阈值的自适应EMA

```verilog
// 阈值基于ADC量程，而非ema值
localparam FREQ_THRESHOLD_LARGE = 16'd5000;   // 5kHz绝对变化
localparam FREQ_THRESHOLD_MEDIUM = 16'd1000;  // 1kHz绝对变化

if (|error| > FREQ_THRESHOLD_LARGE)
    α = 0.25;  // 大变化，中等跟踪（而非0.5）
else if (|error| > FREQ_THRESHOLD_MEDIUM)
    α = 0.1875;  // 中等变化
else
    α = 0.125;  // 小变化
```

**优势**：
- 阈值不受ema影响，小信号下稳定
- α=0.25而非0.5，降低震荡风险

### 方案B：迟滞阈值

```verilog
// 进入大变化模式：error > 5kHz
// 退出大变化模式：error < 1kHz （迟滞）
```

**优势**：避免在阈值附近频繁切换α

### 方案C：变化趋势检测

```verilog
// 连续3次误差方向一致 → 真实变化
// 误差方向交替 → 噪声/波动
```

**优势**：区分真实变化和系统性波动

---

## 当前配置状态

| 参数 | 配置 | 响应时间 | 稳定性 |
|------|------|----------|--------|
| 窗函数 | 禁用（矩形窗） | N/A | ✅ 稳定 |
| 频率EMA | α=0.125固定 | 400ms | ✅ 稳定 |
| 幅度EMA | α=0.125固定 | 400ms | ✅ 稳定 |
| 占空比EMA | α=0.125固定 | 400ms | ✅ 稳定 |
| THD EMA | α=0.125固定 | 400ms | ✅ 稳定 |

**总结**：已回退到之前稳定但响应偏慢的配置。

---

## 测试验证

请重新编译测试，预期：
- ✅ 小信号（<2Vpp）正常显示
- ✅ 所有参数测量值稳定（震荡<5%）
- ⚠️ 响应时间400ms（较慢，但可接受）

如仍有问题，请反馈现象。
