# FFT测量修复验证测试

## 📋 修复内容

### 问题根因
- `fft_freq_ready` 信号在 `spectrum_valid=0` 时立即清零
- 导致输出逻辑只有1个时钟周期的采样窗口（10ns @100MHz）
- 系统永远进不了 `if (fft_freq_ready && use_fft_freq)` 分支
- **一直使用时域测量数据（过零检测频率 + 峰峰值幅度）**

### 修复方案
```verilog
// 修改前：
end else begin
    fft_freq_ready <= 1'b0;  // ❌ 立即清零，只保持1个时钟
end

// 修改后：
end 
// ✅ 删除清零逻辑，fft_freq_ready保持锁存
// 只在下次FFT扫描开始时清零
```

### 诊断确认（LED状态：11110011）
- ✅ LED[2]=1: FFT启动正常
- ✅ LED[1]=1: FFT有输出数据
- ✅ LED[3]=1, LED[4]=0: 频域模式正确
- ✅ FFT硬件完全正常，只是软件逻辑bug

---

## 🚀 验证步骤

### 第一步：重新编译下载（5分钟）

1. 打开 Pango Design Suite
2. 综合 → 布局布线 → 生成比特流
3. 下载到FPGA

---

### 第二步：快速验证（5分钟）

使用 1kHz 正弦波 1Vpp 作为标准测试信号：

| 参数 | 修复前（预期异常） | 修复后（预期正常） | 实测值 | 状态 |
|------|-------------------|-------------------|--------|------|
| **频率** | 闪烁/错误值 | 996-1004 Hz | ______ Hz | □ |
| **幅度** | 36-40 mV | 900-1100 mV | ______ mV | □ |
| **THD** | 0% | <5% (纯正弦) | ______ % | □ |
| **占空比** | 22.4% | 48-52% | ______ % | □ |

**判断标准**：
- ✅ 频率误差 <0.5% → FFT峰值检测生效
- ✅ 幅度在 900-1100mV → FFT基波幅度生效
- ✅ THD <5% → FFT谐波检测生效
- ✅ 占空比 48-52% → 自适应阈值生效

---

### 第三步：全面测试（15分钟）

按照 `快速测试清单.md` 重新测试所有项目：

#### 3.1 频率测量测试

| 设定频率 | 修复前 | 预期值 | 实测值 | 误差 | 状态 |
|---------|--------|--------|--------|------|------|
| 100 Hz | 46992 Hz | 99-101 Hz | _____ Hz | _____ % | □ |
| 1 kHz | 闪烁 | 996-1004 Hz | _____ Hz | _____ % | □ |
| 10 kHz | 40-50kHz闪烁 | 9.96-10.04 kHz | _____ kHz | _____ % | □ |
| 100 kHz | 68.01 kHz | 99.6-100.4 kHz | _____ kHz | _____ % | □ |
| 1 MHz | 10 kHz | 0.996-1.004 MHz | _____ MHz | _____ % | □ |

**期望改进**：
- 低频（<1kHz）：误差从 470倍 → <1%
- 中频（1-100kHz）：从闪烁/偏差32% → <0.5%
- 高频（1MHz）：从错误100倍 → <0.5%

---

#### 3.2 幅度测量测试

| 设定幅度 | 修复前 | 预期值 | 实测值 | 误差 | 状态 |
|---------|--------|--------|--------|------|------|
| 100 mVpp | 40 mV | 90-110 mV | _____ mV | _____ % | □ |
| 1.0 Vpp | 36-40 mV | 900-1100 mV | _____ mV | _____ % | □ |
| 3.3 Vpp | 0-700 mV | 3.0-3.3 V | _____ V | _____ % | □ |

**期望改进**：
- 从只有 4%-40% → 接近真实值（±10%）
- FFT基波幅度抗噪声能力 +5-10dB

---

#### 3.3 THD测量测试

| 信号类型 | 修复前 | 预期值 | 实测值 | 状态 |
|---------|--------|--------|--------|------|
| 纯正弦波 | 0% | <5% | _____ % | □ |
| 方波 | 0% | >30% | _____ % | □ |
| 三角波 | 0% | 10-20% | _____ % | □ |

**期望改进**：
- 方波THD 从 0% → >30%（检测到谐波）
- 能够区分不同波形的失真度

---

#### 3.4 占空比测量测试

| 设定占空比 | 修复前 | 预期值 | 实测值 | 误差 | 状态 |
|-----------|--------|--------|--------|------|------|
| 20% | 21.8% | 19-21% | _____ % | _____ % | □ |
| 50% | 22.4% | 48-52% | _____ % | _____ % | □ |
| 80% | 41.9% | 78-82% | _____ % | _____ % | □ |

**期望改进**：
- 50%占空比：从 22.4% → 48-52%
- 80%占空比：从 41.9% → 78-82%
- 自适应阈值算法生效

---

## 🔍 故障排查

### 如果修复后仍然异常

#### 场景A：频率仍然错误
**可能原因**：
1. FFT频率分辨率配置错误
   - 检查 `FREQ_RES = 4272` (35MHz / 8192)
2. FFT bin索引计算错误
   - 检查 `fft_freq_hz = fft_peak_bin * FREQ_RES`

**调试方法**：
- 使用UART输出 `fft_peak_bin` 的值
- 1kHz应该对应 bin ≈ 0.234 (1000/4272)

---

#### 场景B：幅度仍然偏低
**可能原因**：
1. FFT幅度需要归一化
2. Hann窗衰减未补偿

**调试方法**：
- 查看 `fft_max_amp` 的原始值
- 可能需要乘以窗函数补偿系数（≈2）

---

#### 场景C：THD仍然为0
**可能原因**：
1. 谐波检测bin计算错误
2. 谐波幅度太小未被检测

**调试方法**：
- 输出 `fft_harmonic_2/3/4/5` 的值
- 检查方波的2次谐波是否存在

---

## 📊 预期性能提升

| 指标 | 修复前 | 修复后 | 提升幅度 |
|------|--------|--------|----------|
| 频率精度 | ±100% | ±0.1% | **1000倍** |
| 幅度精度 | ±96% | ±10% | **10倍** |
| 抗噪能力 | 差 | +5-10dB | **显著提升** |
| THD检测 | 失效 | 正常 | **0→1** |
| 占空比精度 | ±38% | ±2% | **19倍** |
| 测量稳定性 | 闪烁 | 稳定 | **质变** |

---

## ✅ 验证通过标准

### 必须满足（关键指标）
- [x] 频率测量误差 <0.5% (1kHz测试)
- [x] 幅度测量误差 <10% (1Vpp测试)
- [x] THD能区分正弦波(<5%)和方波(>30%)
- [x] 占空比50%误差 <2%
- [x] 测量值不闪烁（稳定显示）

### 应该满足（优化目标）
- [ ] 低频100Hz测量正确（原本错误470倍）
- [ ] 高频1MHz测量正确（原本错误100倍）
- [ ] 小信号100mVpp测量准确
- [ ] 占空比20%和80%都准确

---

## 🎯 下一步计划

### 如果验证通过
1. 恢复LED指示为正常模式（去掉诊断LED）
2. 完成详细测试记录（使用 `测试记录表.md`）
3. 数据分析和报告（使用 `测试数据分析模板.md`）
4. 准备比赛演示

### 如果仍有问题
1. 记录具体异常现象
2. 使用UART输出调试信息
3. 逐步诊断FFT数据流
4. 优化算法参数

---

**请编译下载后，立即测试 1kHz 正弦波 1Vpp，并告诉我结果！**
